<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://huyuhui001.github.io/mySite/linux/SRE/03-identity-security/ rel=canonical><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.3.1, mkdocs-material-8.4.3"><title>Identity & Security - UPSkilling</title><link rel=stylesheet href=../../../assets/stylesheets/main.6b80c2a2.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.cbb835fc.min.css><meta name=theme-color content=#009485><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../extra.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme data-md-color-primary=teal data-md-color-accent=green> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#_1 class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title=UPSkilling class="md-header__button md-logo" aria-label=UPSkilling data-md-component=logo> <img src=../../../assets/logo.jpg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> UPSkilling </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Identity & Security </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/huyuhui001/mySite title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> huyuhui001/mySite </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> UPSkilling </a> </li> <li class=md-tabs__item> <a href=../../ class="md-tabs__link md-tabs__link--active"> Linux </a> </li> <li class=md-tabs__item> <a href=../../../k8s/ class=md-tabs__link> Kubernetes </a> </li> <li class=md-tabs__item> <a href=../../../python/ class=md-tabs__link> Python </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=UPSkilling class="md-nav__button md-logo" aria-label=UPSkilling data-md-component=logo> <img src=../../../assets/logo.jpg alt=logo> </a> UPSkilling </label> <div class=md-nav__source> <a href=https://github.com/huyuhui001/mySite title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> huyuhui001/mySite </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1> UPSkilling <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=UPSkilling data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> UPSkilling </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> Welcome </a> </li> <li class=md-nav__item> <a href=../../../about/ class=md-nav__link> About </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2> Linux <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Linux data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ class=md-nav__link> Index </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2 type=checkbox id=__nav_2_2 checked> <label class=md-nav__link for=__nav_2_2> Linux SRE <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Linux SRE" data-md-level=2> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Linux SRE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../01-fundamentals/ class=md-nav__link> Linux Fundamentals </a> </li> <li class=md-nav__item> <a href=../02-filesystem/ class=md-nav__link> File System </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Identity & Security <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Identity & Security </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 用户、组、权限 </a> </li> <li class=md-nav__item> <a href=#selinux class=md-nav__link> SELinux </a> <nav class=md-nav aria-label=SELinux> <ul class=md-nav__list> <li class=md-nav__item> <a href=#selinux_1 class=md-nav__link> SELinux主要概念 </a> </li> <li class=md-nav__item> <a href=#selinux-in-opensuse class=md-nav__link> SELinux in openSUSE </a> </li> <li class=md-nav__item> <a href=#selinux-in-ubuntu class=md-nav__link> SELinux in Ubuntu </a> </li> <li class=md-nav__item> <a href=#selinux-in-rocky class=md-nav__link> SELinux in Rocky </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 用户和组的配置文件 </a> <nav class=md-nav aria-label=用户和组的配置文件> <ul class=md-nav__list> <li class=md-nav__item> <a href=#etcpasswd class=md-nav__link> /etc/passwd </a> </li> <li class=md-nav__item> <a href=#etcshadow class=md-nav__link> /etc/shadow </a> </li> <li class=md-nav__item> <a href=#etcgroup class=md-nav__link> /etc/group </a> </li> <li class=md-nav__item> <a href=#etcgshadow class=md-nav__link> /etc/gshadow </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 生成随机密码 </a> </li> <li class=md-nav__item> <a href=#vipwvigrpwckgrpck class=md-nav__link> vipw/vigr/pwck/grpck命令 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 用户管理 </a> <nav class=md-nav aria-label=用户管理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#useradd class=md-nav__link> 创建用户useradd </a> <nav class=md-nav aria-label=创建用户useradd> <ul class=md-nav__list> <li class=md-nav__item> <a href=#newusers class=md-nav__link> 批量创建用户newusers </a> </li> <li class=md-nav__item> <a href=#chpasswd class=md-nav__link> 批量修改密码chpasswd </a> </li> <li class=md-nav__item> <a href=#openssl-passwd class=md-nav__link> 生成加密密码openssl passwd </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#usermod class=md-nav__link> 修改用户属性usermod </a> </li> <li class=md-nav__item> <a href=#userdel class=md-nav__link> 删除用户userdel </a> </li> <li class=md-nav__item> <a href=#id class=md-nav__link> 查看用户信息id </a> </li> <li class=md-nav__item> <a href=#su class=md-nav__link> 切换用户su </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 设置密码 </a> <nav class=md-nav aria-label=设置密码> <ul class=md-nav__list> <li class=md-nav__item> <a href=#passwd class=md-nav__link> passwd </a> </li> <li class=md-nav__item> <a href=#pwgen class=md-nav__link> pwgen </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> 非交互式设置密码 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> 设置用户密码策略 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> 组管理 </a> <nav class=md-nav aria-label=组管理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#groupadd class=md-nav__link> 创建组groupadd </a> </li> <li class=md-nav__item> <a href=#groupmod class=md-nav__link> 修改组groupmod </a> </li> <li class=md-nav__item> <a href=#groupdel class=md-nav__link> 删除组groupdel </a> </li> <li class=md-nav__item> <a href=#gpasswd class=md-nav__link> 更改组成员和密码gpasswd </a> </li> <li class=md-nav__item> <a href=#groupmems class=md-nav__link> 修改组成员groupmems </a> </li> <li class=md-nav__item> <a href=#group class=md-nav__link> 查看组关系group </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> 练习 </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> 权限管理 </a> <nav class=md-nav aria-label=权限管理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#chown class=md-nav__link> 修改属主chown </a> </li> <li class=md-nav__item> <a href=#chgrp class=md-nav__link> 修改属组chgrp </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> 文件和目录权限 </a> </li> <li class=md-nav__item> <a href=#chmod class=md-nav__link> 权限修改chmod </a> </li> <li class=md-nav__item> <a href=#umask class=md-nav__link> 默认权限umask </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> 特殊权限 </a> </li> <li class=md-nav__item> <a href=#chattr class=md-nav__link> 设定文件特殊属性chattr </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#acl class=md-nav__link> 访问控制列表ACL </a> <nav class=md-nav aria-label=访问控制列表ACL> <ul class=md-nav__list> <li class=md-nav__item> <a href=#acl_1 class=md-nav__link> ACL </a> </li> <li class=md-nav__item> <a href=#acl_2 class=md-nav__link> ACL的基本类型 </a> </li> <li class=md-nav__item> <a href=#acl_3 class=md-nav__link> ACL术语 </a> </li> <li class=md-nav__item> <a href=#acl_4 class=md-nav__link> ACL权限分类 </a> </li> <li class=md-nav__item> <a href=#acl_5 class=md-nav__link> ACL操作命令 </a> </li> <li class=md-nav__item> <a href=#acl_6 class=md-nav__link> ACL实例解析 </a> <nav class=md-nav aria-label=ACL实例解析> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_14 class=md-nav__link> 实例描述 </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> 初始化环境 </a> </li> <li class=md-nav__item> <a href=#acl_7 class=md-nav__link> 添加ACL权限 </a> </li> <li class=md-nav__item> <a href=#mask class=md-nav__link> 修改mask权限 </a> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> 有效权限分析 </a> </li> <li class=md-nav__item> <a href=#acl_8 class=md-nav__link> 默认ACL权限 </a> </li> <li class=md-nav__item> <a href=#acl_9 class=md-nav__link> 递归ACL权限 </a> </li> <li class=md-nav__item> <a href=#acl_10 class=md-nav__link> 删除ACL权限 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#acl_11 class=md-nav__link> ACL目录实例解析 </a> <nav class=md-nav aria-label=ACL目录实例解析> <ul class=md-nav__list> <li class=md-nav__item> <a href=#acl_12 class=md-nav__link> 目录ACL </a> </li> <li class=md-nav__item> <a href=#acl_13 class=md-nav__link> 目录的默认ACL </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#acl_14 class=md-nav__link> ACL检查逻辑 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../04-TextTools/ class=md-nav__link> Text Tools </a> </li> <li class=md-nav__item> <a href=../05-RegExpress/ class=md-nav__link> Regular Expression </a> </li> <li class=md-nav__item> <a href=../06-FileLookup/ class=md-nav__link> File Lookup </a> </li> <li class=md-nav__item> <a href=../07-FilePacking/ class=md-nav__link> FIle Packing & Unpacking </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_3 type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3> SUSE Linux Administration <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="SUSE Linux Administration" data-md-level=2> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> SUSE Linux Administration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../Administration/01/ class=md-nav__link> Linux File System Overview </a> </li> <li class=md-nav__item> <a href=../../Administration/02/ class=md-nav__link> Useful Commands </a> </li> <li class=md-nav__item> <a href=../../Administration/03/ class=md-nav__link> Shell </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_4 type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4> SUSE Enterprise Storage Foundation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="SUSE Enterprise Storage Foundation" data-md-level=2> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> SUSE Enterprise Storage Foundation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../SES/linux_ses_memo/ class=md-nav__link> SUSE Enterprise Storage Foundation </a> </li> <li class=md-nav__item> <a href=../../SES/linux_ses_demo/ class=md-nav__link> SUSE Enterprise Storage Basic Operation </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Kubernetes data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/ class=md-nav__link> Index </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2 type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2> Installation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Installation data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> Installation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/installation/single-local/ class=md-nav__link> Single Node Installation </a> </li> <li class=md-nav__item> <a href=../../../k8s/installation/multiple-local/ class=md-nav__link> Multiple Nodes Installation </a> </li> <li class=md-nav__item> <a href=../../../k8s/installation/aliyun-ubuntu/ class=md-nav__link> Installation on Aliyun ECS </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3 type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3> Docker <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Docker data-md-level=2> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/foundamentals/docker/ class=md-nav__link> Fundamentals </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_4 type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4> Foundamentals <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Foundamentals data-md-level=2> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Foundamentals </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/foundamentals/memo/ class=md-nav__link> Memo </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/basics/ class=md-nav__link> kubectl basics </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_5 type=checkbox id=__nav_3_5> <label class=md-nav__link for=__nav_3_5> Core Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Core Kubernetes" data-md-level=2> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> Core Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/foundamentals/pod/ class=md-nav__link> Pod </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/deployment/ class=md-nav__link> Deployment </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/service/ class=md-nav__link> Service </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_6 type=checkbox id=__nav_3_6> <label class=md-nav__link for=__nav_3_6> Application Modeling <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Application Modeling" data-md-level=2> <label class=md-nav__title for=__nav_3_6> <span class="md-nav__icon md-icon"></span> Application Modeling </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/foundamentals/namespace/ class=md-nav__link> Namespace </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/statefulset/ class=md-nav__link> StatefulSet </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/daemonset/ class=md-nav__link> DaemonSet </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/job/ class=md-nav__link> Job and Cronjob </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/configuration/ class=md-nav__link> Configuration </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/secrets/ class=md-nav__link> Secrets </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/persistence/ class=md-nav__link> Persistence </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/rbac/ class=md-nav__link> Role Based Access Control (RBAC) </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/ingress/ class=md-nav__link> Ingress </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_7 type=checkbox id=__nav_3_7> <label class=md-nav__link for=__nav_3_7> Advanced Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Advanced Kubernetes" data-md-level=2> <label class=md-nav__title for=__nav_3_7> <span class="md-nav__icon md-icon"></span> Advanced Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/foundamentals/scheduling/ class=md-nav__link> Scheduling </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/hpa/ class=md-nav__link> Horizontal Pod Autoscaling </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/policy/ class=md-nav__link> Policy </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/networkpolicy/ class=md-nav__link> Network Policy </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/clustermgt/ class=md-nav__link> Cluster Management </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_8 type=checkbox id=__nav_3_8> <label class=md-nav__link for=__nav_3_8> Operating Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Operating Kubernetes" data-md-level=2> <label class=md-nav__title for=__nav_3_8> <span class="md-nav__icon md-icon"></span> Operating Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/foundamentals/troubleshooting/ class=md-nav__link> Troubleshooting </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/healthcheck/ class=md-nav__link> Health Check </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/helming/ class=md-nav__link> Helming </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_9 type=checkbox id=__nav_3_9> <label class=md-nav__link for=__nav_3_9> Case Study <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Case Study" data-md-level=2> <label class=md-nav__title for=__nav_3_9> <span class="md-nav__icon md-icon"></span> Case Study </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/foundamentals/casestudy-operation-resources/ class=md-nav__link> Operations on Resources </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/casestudy-health-check/ class=md-nav__link> Health Check </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/casestudy-calico/ class=md-nav__link> Calico Installation </a> </li> <li class=md-nav__item> <a href=../../../k8s/foundamentals/kyma/ class=md-nav__link> Kyma </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_10 type=checkbox id=__nav_3_10> <label class=md-nav__link for=__nav_3_10> Demos <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Demos data-md-level=2> <label class=md-nav__title for=__nav_3_10> <span class="md-nav__icon md-icon"></span> Demos </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../k8s/demo/cap_on_kyma/ class=md-nav__link> Build CAP application on Kyma </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Python <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Python data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../python/ class=md-nav__link> Index </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2 type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2> Python基础 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Python基础 data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Python基础 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../python/Foundation/ch00/ class=md-nav__link> 安装 </a> </li> <li class=md-nav__item> <a href=../../../python/Foundation/ch01/ class=md-nav__link> 语言基础 </a> </li> <li class=md-nav__item> <a href=../../../python/Foundation/ch02/ class=md-nav__link> 打包和拆包 </a> </li> <li class=md-nav__item> <a href=../../../python/Foundation/ch03/ class=md-nav__link> 函数及文件 </a> </li> <li class=md-nav__item> <a href=../../../python/Foundation/ch04/ class=md-nav__link> 面向对象概念 </a> </li> <li class=md-nav__item> <a href=../../../python/Foundation/ch05/ class=md-nav__link> 面向对象特性 </a> </li> <li class=md-nav__item> <a href=../../../python/Foundation/Algorithms/ class=md-nav__link> 数据结构和算法 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3 type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3> Python数据分析基础 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Python数据分析基础 data-md-level=2> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Python数据分析基础 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../python/DataAnalysis/ch01/ class=md-nav__link> NumPy基础 </a> </li> <li class=md-nav__item> <a href=../../../python/DataAnalysis/ch10/ class=md-nav__link> NumPy进阶 </a> </li> <li class=md-nav__item> <a href=../../../python/DataAnalysis/ch02/ class=md-nav__link> Pandas入门 </a> </li> <li class=md-nav__item> <a href=../../../python/DataAnalysis/ch03/ class=md-nav__link> 数据载入、存储及文件格式 </a> </li> <li class=md-nav__item> <a href=../../../python/DataAnalysis/ch04/ class=md-nav__link> 数据清洗与准备 </a> </li> <li class=md-nav__item> <a href=../../../python/DataAnalysis/ch05/ class=md-nav__link> 数据规整：连接、联合与重塑 </a> </li> <li class=md-nav__item> <a href=../../../python/DataAnalysis/ch06/ class=md-nav__link> 绘图与可视化 </a> </li> <li class=md-nav__item> <a href=../../../python/DataAnalysis/ch07/ class=md-nav__link> 数据聚合与分组操作 </a> </li> <li class=md-nav__item> <a href=../../../python/DataAnalysis/ch08/ class=md-nav__link> 时间序列 </a> </li> <li class=md-nav__item> <a href=../../../python/DataAnalysis/ch09/ class=md-nav__link> 高阶pandas </a> </li> <li class=md-nav__item> <a href=../../../python/DataAnalysis/ch11/ class=md-nav__link> Python建模库介绍 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4 type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4> Demos <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Demos data-md-level=2> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Demos </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../python/Demo/CourseSystem/ class=md-nav__link> 选课系统 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 用户、组、权限 </a> </li> <li class=md-nav__item> <a href=#selinux class=md-nav__link> SELinux </a> <nav class=md-nav aria-label=SELinux> <ul class=md-nav__list> <li class=md-nav__item> <a href=#selinux_1 class=md-nav__link> SELinux主要概念 </a> </li> <li class=md-nav__item> <a href=#selinux-in-opensuse class=md-nav__link> SELinux in openSUSE </a> </li> <li class=md-nav__item> <a href=#selinux-in-ubuntu class=md-nav__link> SELinux in Ubuntu </a> </li> <li class=md-nav__item> <a href=#selinux-in-rocky class=md-nav__link> SELinux in Rocky </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 用户和组的配置文件 </a> <nav class=md-nav aria-label=用户和组的配置文件> <ul class=md-nav__list> <li class=md-nav__item> <a href=#etcpasswd class=md-nav__link> /etc/passwd </a> </li> <li class=md-nav__item> <a href=#etcshadow class=md-nav__link> /etc/shadow </a> </li> <li class=md-nav__item> <a href=#etcgroup class=md-nav__link> /etc/group </a> </li> <li class=md-nav__item> <a href=#etcgshadow class=md-nav__link> /etc/gshadow </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 生成随机密码 </a> </li> <li class=md-nav__item> <a href=#vipwvigrpwckgrpck class=md-nav__link> vipw/vigr/pwck/grpck命令 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 用户管理 </a> <nav class=md-nav aria-label=用户管理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#useradd class=md-nav__link> 创建用户useradd </a> <nav class=md-nav aria-label=创建用户useradd> <ul class=md-nav__list> <li class=md-nav__item> <a href=#newusers class=md-nav__link> 批量创建用户newusers </a> </li> <li class=md-nav__item> <a href=#chpasswd class=md-nav__link> 批量修改密码chpasswd </a> </li> <li class=md-nav__item> <a href=#openssl-passwd class=md-nav__link> 生成加密密码openssl passwd </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#usermod class=md-nav__link> 修改用户属性usermod </a> </li> <li class=md-nav__item> <a href=#userdel class=md-nav__link> 删除用户userdel </a> </li> <li class=md-nav__item> <a href=#id class=md-nav__link> 查看用户信息id </a> </li> <li class=md-nav__item> <a href=#su class=md-nav__link> 切换用户su </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 设置密码 </a> <nav class=md-nav aria-label=设置密码> <ul class=md-nav__list> <li class=md-nav__item> <a href=#passwd class=md-nav__link> passwd </a> </li> <li class=md-nav__item> <a href=#pwgen class=md-nav__link> pwgen </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> 非交互式设置密码 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> 设置用户密码策略 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> 组管理 </a> <nav class=md-nav aria-label=组管理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#groupadd class=md-nav__link> 创建组groupadd </a> </li> <li class=md-nav__item> <a href=#groupmod class=md-nav__link> 修改组groupmod </a> </li> <li class=md-nav__item> <a href=#groupdel class=md-nav__link> 删除组groupdel </a> </li> <li class=md-nav__item> <a href=#gpasswd class=md-nav__link> 更改组成员和密码gpasswd </a> </li> <li class=md-nav__item> <a href=#groupmems class=md-nav__link> 修改组成员groupmems </a> </li> <li class=md-nav__item> <a href=#group class=md-nav__link> 查看组关系group </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> 练习 </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> 权限管理 </a> <nav class=md-nav aria-label=权限管理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#chown class=md-nav__link> 修改属主chown </a> </li> <li class=md-nav__item> <a href=#chgrp class=md-nav__link> 修改属组chgrp </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> 文件和目录权限 </a> </li> <li class=md-nav__item> <a href=#chmod class=md-nav__link> 权限修改chmod </a> </li> <li class=md-nav__item> <a href=#umask class=md-nav__link> 默认权限umask </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> 特殊权限 </a> </li> <li class=md-nav__item> <a href=#chattr class=md-nav__link> 设定文件特殊属性chattr </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#acl class=md-nav__link> 访问控制列表ACL </a> <nav class=md-nav aria-label=访问控制列表ACL> <ul class=md-nav__list> <li class=md-nav__item> <a href=#acl_1 class=md-nav__link> ACL </a> </li> <li class=md-nav__item> <a href=#acl_2 class=md-nav__link> ACL的基本类型 </a> </li> <li class=md-nav__item> <a href=#acl_3 class=md-nav__link> ACL术语 </a> </li> <li class=md-nav__item> <a href=#acl_4 class=md-nav__link> ACL权限分类 </a> </li> <li class=md-nav__item> <a href=#acl_5 class=md-nav__link> ACL操作命令 </a> </li> <li class=md-nav__item> <a href=#acl_6 class=md-nav__link> ACL实例解析 </a> <nav class=md-nav aria-label=ACL实例解析> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_14 class=md-nav__link> 实例描述 </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> 初始化环境 </a> </li> <li class=md-nav__item> <a href=#acl_7 class=md-nav__link> 添加ACL权限 </a> </li> <li class=md-nav__item> <a href=#mask class=md-nav__link> 修改mask权限 </a> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> 有效权限分析 </a> </li> <li class=md-nav__item> <a href=#acl_8 class=md-nav__link> 默认ACL权限 </a> </li> <li class=md-nav__item> <a href=#acl_9 class=md-nav__link> 递归ACL权限 </a> </li> <li class=md-nav__item> <a href=#acl_10 class=md-nav__link> 删除ACL权限 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#acl_11 class=md-nav__link> ACL目录实例解析 </a> <nav class=md-nav aria-label=ACL目录实例解析> <ul class=md-nav__list> <li class=md-nav__item> <a href=#acl_12 class=md-nav__link> 目录ACL </a> </li> <li class=md-nav__item> <a href=#acl_13 class=md-nav__link> 目录的默认ACL </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#acl_14 class=md-nav__link> ACL检查逻辑 </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/huyuhui001/mySite/edit/main/docs/linux/SRE/03-identity-security.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1 id=_1>身份与安全<a class=headerlink href=#_1 title="Permanent link"> ¶</a></h1> <h2 id=_2>用户、组、权限<a class=headerlink href=#_2 title="Permanent link"> ¶</a></h2> <p>用户和组</p> <ul> <li>用户user和组group在Linux系统中以数字形式进行管理。</li> <li>用户被分配的号码称为用户ID（UID）。 </li> <li>每个Linux系统都有一个特权用户，即<code>root</code>用户。 <code>root</code>是系统管理员。 此用户的UID始终为0。</li> <li>普通用户的UID编号（默认情况下）为1000。</li> <li>每个组也分配了一个称为组ID（GID）的编号。</li> <li>每个用户有一个主要组（primary group），有零个或者任意个附加组（supplementary group）。</li> </ul> <p>以openSUSE为例：</p> <ul> <li>UID</li> <li>0: root</li> <li>1 – 99: System</li> <li>100 – 499: System accounts</li> <li> <p>≥ 1000: Normal (unprivileged) accounts</p> </li> <li> <p>GID</p> </li> <li>0: root</li> <li>1 – 99: System Groups</li> <li>100 – 499: Dynamically Allocated System Groups</li> <li>≥ 1000: Normal Groups</li> </ul> <p>举例： <div class=highlight><pre><span></span><code>$ id postfix
uid=51(postfix) gid=51(postfix) groups=482(mail),59(maildrop),51(postfix)

$ id vagrant
uid=1000(vagrant) gid=478(wheel) groups=0(root),478(wheel)
</code></pre></div></p> <div class="admonition reference"> <p class=admonition-title>Reference</p> <p>UID和GID等编号规则，是在文件<code>/etc/login.defs</code>中约定的。</p> </div> <h2 id=selinux>SELinux<a class=headerlink href=#selinux title="Permanent link"> ¶</a></h2> <p>Security-Enhanced Linux (SELinux) 是一种Linux系统的安全架构，它允许管理员更好地控制谁可以访问系统。 SELinux于2000年向开源社区发布，并于2003年集成到上游 Linux 内核中。</p> <p>SELinux为系统上的应用程序、进程和文件定义了访问控制。 它使用安全策略（一组规则告诉SELinux什么可以访问或不可以访问）来强制执行策略允许的访问。</p> <p>当称为主体（subject）的应用程序或进程请求访问对象（如文件）时，SELinux会检查访问向量缓存(AVC, Access Vector Cache)，其中缓存了主体和对象的权限。</p> <p>如果SELinux无法根据缓存的权限做出访问决定，它会将请求发送到安全服务器。 安全服务器检查应用程序或进程和文件的安全上下文。 从SELinux策略数据库应用安全上下文（Security context），然后授予或拒绝许可。 如果权限被拒绝，<code>avc: denied</code>消息将在<code>/var/log.messages</code>中体现。</p> <p>传统上，Linux和UNIX系统都使用DAC（Discretionary Access Control）。 SELinux是Linux的MAC（Mandatory Access Control）系统的一个示例。</p> <p>在DAC方式下，文件和进程有自己的属主（所有者）。 用户可以拥有一个文件，一个组也可以拥有一个文件，或者其他人。 用户可以更改自己文件的权限。<code>root</code>用户对DAC系统具有完全访问控制权。 </p> <p>但是在像SELinux这样的MAC系统上，对于访问的管理是通过设置策略来实现的。即使用户主目录上的DAC设置发生更改，用于防止其他用户或进程访问该目录的SELinux策略也将继续确保系统安全。</p> <p>MAC方式是控制一个进程对具体文件系统上面的文件或目录是否拥有访问权限。判断进程是否可以访问文件或目录的依据，取决于SELinux中设定的很多策略规则。</p> <p>访问控制列表 (ACL，Access Control List) 为文件系统提供了一种额外的、更灵活的权限机制。 它旨在协助 UNIX 文件权限。ACL允许授予任何用户或组对任何磁盘资源的权限。ACL适用于在不使某个用户成为组成员的情况下，仍旧授予一些读或写访问权限。</p> <p>下面示例对比说明了SELinux和ACL在文件属性展现上的特点。</p> <ul> <li><code>-rwxr-xr-- vagrant wheel</code> ：没有selinux上下文，没有ACL</li> <li><code>-rwx--xr-x+ vagrant wheel</code> ：只有ACL，没有selinux上下文</li> <li><code>-rw-r--r--. vagrant wheel</code> ：只有selinux上下文，没有ACL</li> <li><code>-rwxrwxr--+ vagrant wheel</code> ：有selinux上下文，有ACL</li> </ul> <h3 id=selinux_1>SELinux主要概念<a class=headerlink href=#selinux_1 title="Permanent link"> ¶</a></h3> <ul> <li> <p>用户(Users)：</p> <ul> <li>SELinux的用户不等同与Linux用户。</li> <li>SELinux用户以后缀<code>_u</code>结尾。</li> </ul> </li> <li> <p>角色(Roles)：</p> <ul> <li>角色Roles是由策略Policies定义的，角色决定了使用哪个策略。</li> <li>SELinux角色以后缀<code>_r</code>结尾。</li> </ul> </li> <li> <p>类型(Types)：</p> <ul> <li>SELinux是类型强制的，类型Types决定进程能否访问某个文件。</li> <li>SELinux类型是以后缀<code>_t</code>结尾。</li> </ul> </li> <li> <p>上下文(Contexts)：</p> <ul> <li>用来标记进程和文件。分别是用户Users，角色Roles，类型Types，范围Ranges。</li> <li>格式：<code>user:role:type:range</code></li> </ul> </li> <li> <p>文件类型(Object Classes)：</p> <ul> <li>每个文件类型Types都对应一套策略Policies。策略Policies决定了进程对这类文件的访问权限。</li> <li>访问权限有4种：<ul> <li>创建create</li> <li>读取read</li> <li>写入write</li> <li>删除unlink（注意，这里不是链接的意思）</li> </ul> </li> </ul> </li> <li> <p>规则(Rules)</p> <ul> <li>格式：<code>allow user_t user_home_t:file {create read write unlink};</code></li> <li>含义：<code>user_t</code>类型对<code>user_home_t</code>类型有创建create，读取read，写入write，删除unlink权限。</li> </ul> </li> </ul> <h3 id=selinux-in-opensuse>SELinux in openSUSE<a class=headerlink href=#selinux-in-opensuse title="Permanent link"> ¶</a></h3> <p>作为SELinux的替代品，2005年被Novell收购的Immunix公司开发了AppArmor。SUSE在openSUSE Leap中提供对SELinux框架的支持。这并不意味着openSUSE Leap的默认安装会在不久的将来从AppArmor切换到SELinux。</p> <p>添加SELinux的源。可以从<code>https://download.opensuse.org/repositories/security:/SELinux/</code>下载对应的策略policy。 <div class=highlight><pre><span></span><code>$ sudo zypper ar -f https://download.opensuse.org/repositories/security:/SELinux/openSUSE_Factory/ Security-SELinux
</code></pre></div></p> <p>安装C++等基础开发包： <div class=highlight><pre><span></span><code># 列出当前可安装的Pattern
sudo zypper pt

# 安装下面几个开发相关的Pattern
sudo zypper in -t pattern devel_C_C++ devel_basis devel_kernel
</code></pre></div></p> <p>安装SELinux packages： <div class=highlight><pre><span></span><code>$ zypper se --search-descriptions selinux
$ sudo zypper in restorecond policycoreutils setools-console
$ sudo zypper in selinux-tools libselinux-devel
</code></pre></div></p> <p>安装SELinux policy： <div class=highlight><pre><span></span><code>$ sudo zypper in selinux-policy-targeted selinux-policy-devel selinux-autorelabel
</code></pre></div></p> <p>更新GRUB2 bootloader（GRUB2引导加载程序）：</p> <p>编辑文件<code>/etc/default/grub</code>，添加下面内容到<code>GRUB_CMDLINE_LINUX_DEFAULT=</code>这一行： <div class=highlight><pre><span></span><code>security=selinux selinux=1
</code></pre></div> 记录这一行的原始信息： <div class=highlight><pre><span></span><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;splash=silent resume=/dev/disk/by-uuid/47c36ad7-f49f-4ecd-9b72-4801c5bb3a04 preempt=full mitigations=auto quiet security=apparmor&quot;
</code></pre></div> 运行下面的命令生成新的GRUB2引导加载程序配置文件。 <div class=highlight><pre><span></span><code>$ sudo grub2-mkconfig -o /boot/grub2/grub.cfg
</code></pre></div></p> <p>编辑文件<code>/etc/selinux/config</code> 并设置 <code>SELINUX=permissive</code>来启用SElinux。这与前面GRUB2的启动配置是一致的。 如文件不存在，则创建。 <div class=highlight><pre><span></span><code>$ sudo cat /etc/selinux/config
SELINUX=permissive
SELINUXTYPE=targeted
</code></pre></div></p> <p>重启系统。系统启动可能需要一些时间，SELinux需要给整个文件系统重新进行标签化。</p> <p>重启后，运行下面的命令来查看SELinux是否运行正常。 <div class=highlight><pre><span></span><code>$ sudo getenforce
Permissive
</code></pre></div></p> <div class=highlight><pre><span></span><code>$ sudo sestatus -v
SELinux status:                 enabled
SELinuxfs mount:                /sys/fs/selinux
SELinux root directory:         /etc/selinux
Loaded policy name:             targeted
Current mode:                   permissive
Mode from config file:          permissive
Policy MLS status:              enabled
Policy deny_unknown status:     allowed
Memory protection checking:     requested (insecure)
Max kernel policy version:      33

Process contexts:
Current context:                unconfined_u:unconfined_r:unconfined_t:s0
Init context:                   system_u:system_r:kernel_t:s0
/sbin/agetty                    system_u:system_r:kernel_t:s0
/usr/sbin/sshd                  system_u:system_r:kernel_t:s0

File contexts:
Controlling terminal:           unconfined_u:object_r:devpts_t:s0
/etc/passwd                     system_u:object_r:unlabeled_t:s0
/etc/shadow                     system_u:object_r:unlabeled_t:s0
/bin/bash                       system_u:object_r:unlabeled_t:s0 -&gt; system_u:object_r:unlabeled_t:s0
/bin/login                      system_u:object_r:unlabeled_t:s0
/bin/sh                         system_u:object_r:unlabeled_t:s0 -&gt; system_u:object_r:unlabeled_t:s0
/sbin/agetty                    system_u:object_r:unlabeled_t:s0 -&gt; system_u:object_r:unlabeled_t:s0
/sbin/init                      system_u:object_r:unlabeled_t:s0 -&gt; system_u:object_r:unlabeled_t:s0
/usr/sbin/sshd                  system_u:object_r:unlabeled_t:s0
</code></pre></div> <div class="admonition reference"> <p class=admonition-title>Reference</p> <p>GRUB2引导加载程序中添加的三个参数的解释：</p> <p><code>security=selinux</code>: This option tells the kernel to use SELinux and not AppArmor.</p> <p><code>selinux=1</code>: This option switches on SELinux.</p> <p><code>enforcing=0</code>: This option puts SELinux in permissive mode. In this mode, SELinux is fully functional, but does not enforce any of the security settings in the policy. Use this mode for testing and configuring your system. To switch on SELinux protection, when the system is fully operational, change the option to <code>enforcing=1</code> and add <code>SELINUX=enforcing</code> in <code>/etc/selinux/config</code>. </p> </div> <div class="admonition tips"> <p class=admonition-title>Tips</p> <p>在首次启用SELinux后，如果只在grub2里面添加selinux=1，通过<code>getenforce</code>命令看的SELinux一直就是disabled的状态，需要手工创建/etc/selinux/config文件添加配置才行。感觉grub2里面无需设置，直接配置/etc/selinux/config文件。不确定这个想法是否正确。</p> <p>在grub2中设定selinux=1，在/etc/selinux/config文件中：</p> <ul> <li>设定SELINUX=permissive，重启后通过<code>getenforce</code>命令看到的是permissive。</li> <li>设定SELINUX=disabled，则重启后<code>getenforce</code>命令看到的是disabled。</li> </ul> <p>这说明配置文件后启动，覆盖了内核设置。</p> <p>注意，如果仅仅完成了上面的enable SELinux，立刻设定SELINUX=enforcing，会引起ssh无法登录，错误信息是<code>/bin/bash: Permission denied</code>。</p> </div> <p>配置SELinux。</p> <p><div class=highlight><pre><span></span><code>sudo semanage boolean -l
</code></pre></div> Failed to use semanage</p> <p>添加下面内容到.bashrc文件。 <div class=highlight><pre><span></span><code>export PATH=/usr/local/bin:/home/$USER/.local/bin:$PATH
</code></pre></div> 更新pip3. <div class=highlight><pre><span></span><code>pip3 install --upgrade pip
</code></pre></div></p> <p>安装下面几个包 <div class=highlight><pre><span></span><code>sudo zypper in libselinux libselinux-devel
sudo zypper in python3-semanage
sudo zypper in libsemanage-devel libsemanage-devel-static
sudo zypper in policycoreutils-python-utils
sudo zypper in cross-x86_64-linux-glibc-devel glibc-utils glibc-profile

sudo zypper in policycoreutils-devel
</code></pre></div></p> <h3 id=selinux-in-ubuntu>SELinux in Ubuntu<a class=headerlink href=#selinux-in-ubuntu title="Permanent link"> ¶</a></h3> <h3 id=selinux-in-rocky>SELinux in Rocky<a class=headerlink href=#selinux-in-rocky title="Permanent link"> ¶</a></h3> <h2 id=_3>用户和组的配置文件<a class=headerlink href=#_3 title="Permanent link"> ¶</a></h2> <ul> <li><code>/etc/passwd</code>：用户及其属性信息（用户名，UID，主组ID等）</li> <li><code>/etc/shadow</code>：用户密码机器属性</li> <li><code>/etc/group</code>：组及其属性</li> <li><code>/etc/gshadow</code>：组密码及其属性</li> </ul> <h3 id=etcpasswd>/etc/passwd<a class=headerlink href=#etcpasswd title="Permanent link"> ¶</a></h3> <p>格式说明： <div class=highlight><pre><span></span><code>vagrant:x:1001:474:vagrant:/home/vagrant:/bin/bash
[-----] - [--] [-] [-----] [-----------] [-------]
   |    |  |    |     |          |           +--------&gt; 7. Login shell
   |    |  |    |     |          +--------------------&gt; 6. Home directory
   |    |  |    |     +-------------------------------&gt; 5. GECOS or the full name of the user
   |    |  |    +-------------------------------------&gt; 4. GID
   |    |  +------------------------------------------&gt; 3. UID
   |    +---------------------------------------------&gt; 2. Password
   +--------------------------------------------------&gt; 1. Username
</code></pre></div></p> <h3 id=etcshadow>/etc/shadow<a class=headerlink href=#etcshadow title="Permanent link"> ¶</a></h3> <p>格式说明： <div class=highlight><pre><span></span><code>vagrant:$6$.n.:17736:0:99999:7:::
[-----] [----] [---] - [---] ----
|         |      |   |   |   |||+-----------&gt; 9. Unused
|         |      |   |   |   ||+------------&gt; 8. Expiration date since Jan 1, 1970
|         |      |   |   |   |+-------------&gt; 7. Inactivity period 密码过期后的宽限期
|         |      |   |   |   +--------------&gt; 6. Warning period, default 7 days
|         |      |   |   +------------------&gt; 5. Maximum password age
|         |      |   +----------------------&gt; 4. Minimum password age
|         |      +--------------------------&gt; 3. Last password change since Jan 1, 1970
|         +---------------------------------&gt; 2. Encrypted Password
+-------------------------------------------&gt; 1. Username
</code></pre></div></p> <h3 id=etcgroup>/etc/group<a class=headerlink href=#etcgroup title="Permanent link"> ¶</a></h3> <p>格式说明： <div class=highlight><pre><span></span><code>audio:x:492:pulse
[---] - [-] [---]
  |   |  |    +----&gt; 4. username-list, who have this group as their supplementary
  |   |  +---------&gt; 3. GID
  |   +------------&gt; 2. group-password. Real password is in /etc/gshadow
  +----------------&gt; 1. groupname
</code></pre></div></p> <h3 id=etcgshadow>/etc/gshadow<a class=headerlink href=#etcgshadow title="Permanent link"> ¶</a></h3> <p>格式说明： <div class=highlight><pre><span></span><code>general:!!:shelley:juan,bob
[-----] -- [-----] [------]
   |     |     |       +-------&gt; 4. group members (in a comma delimited list)
   |     |     +---------------&gt; 3. group adminstrators (in a comma delimited list)
   |     +---------------------&gt; 2. encrypted password. `!`, `!!`, and null
   +---------------------------&gt; 1. group name
</code></pre></div></p> <p>Encrypted password</p> <ul> <li><code>!</code>：no user is allowed to access the group using the newgrp command.</li> <li><code>!!</code>：the same as a value of <code>!</code> — however, it also indicates that a password has never been set before. </li> <li>null：only group members can log into the group.</li> </ul> <h3 id=_4>生成随机密码<a class=headerlink href=#_4 title="Permanent link"> ¶</a></h3> <div class=highlight><pre><span></span><code># 通过`/dev/urandom`生成随机数，通过`tr -dc`过滤随机数，只保留字母和数字，通过`head -c`保留指定位数
$ tr -dc &#39;[:alnum:]&#39; &lt; /dev/urandom | head -c 12
xFw7vfma54D8

$ openssl rand -base64 9
I5TZXJfpd3Pg
</code></pre></div> <h3 id=vipwvigrpwckgrpck>vipw/vigr/pwck/grpck命令<a class=headerlink href=#vipwvigrpwckgrpck title="Permanent link"> ¶</a></h3> <p><code>vipw</code>和<code>vigr</code>命令分别编辑文件<code>/etc/passwd</code>和<code>/etc/group</code>。 如果指定了<code>-s</code>标志，这些命令将分别编辑其文件的影子（安全）版本：<code>/etc/shadow</code>和<code>/etc/gshadow</code>。 <code>vipw</code>和<code>vigr</code>命令在编辑文件时会设置锁以防止文件损坏。 <code>vipw</code>和<code>vigr</code>命令会首先尝试环境变量<code>$VISUAL</code>，然后是环境变量<code>$EDITOR</code>，最后是默认编辑器<code>vi</code>。</p> <div class=highlight><pre><span></span><code>$ sudo vipw
$ sudo vipw -s
$ sudo vigr
$ sudo vigr -s
</code></pre></div> <p><code>pwck</code>命令实现验证系统认证信息的完整性。 检查<code>/etc/passwd</code>和<code>/etc/shadow</code>中的所有条目每个字段是否具有正确的格式和有效数据。 系统会提示用户删除格式不正确或存在其他错误的条目。</p> <p><code>pwck</code>返回值：</p> <ul> <li><code>0</code>: success</li> <li><code>1</code>: invalid command syntax</li> <li><code>2</code>: one or more bad password entries</li> <li><code>3</code>: can’t open password files</li> <li><code>4</code>: can’t lock password files</li> <li><code>5</code>: can’t update password files </li> </ul> <p><code>grpck</code>命令实现验证系统认证信息的完整性。 检查<code>/etc/group</code>和<code>/etc/gshadow</code>中的所有条目每个字段是否具有正确的格式和有效数据。 系统会提示用户删除格式不正确或存在其他错误的条目。</p> <p><code>grpck</code>返回值：</p> <ul> <li><code>0</code>: success</li> <li><code>1</code>: invalid command syntax</li> <li><code>2</code>: one or more bad group entries</li> <li><code>3</code>: can’t open group files</li> <li><code>4</code>: can’t lock group files</li> <li><code>5</code>: can’t update group files </li> </ul> <h2 id=_5>用户管理<a class=headerlink href=#_5 title="Permanent link"> ¶</a></h2> <p>用户管理命令：</p> <ul> <li><code>useradd</code></li> <li><code>usermod</code></li> <li><code>userdel</code></li> </ul> <h3 id=useradd>创建用户<code>useradd</code><a class=headerlink href=#useradd title="Permanent link"> ¶</a></h3> <p>举例： <div class=highlight><pre><span></span><code># 普通用户
$ useradd -m -g wheel -G root -c &quot;vagrant&quot; vagrant

# 非交互用户
$ useradd -r -u 48 -g apache -d /var/www -s /sbin/nologin -g postfix -c &quot;Apache&quot; apache 2&gt;/dev/null
</code></pre></div></p> <p><code>useradd</code>命令的默认值是在<code>/etc/default/useradd</code>文件中设定。</p> <p>openSUSE的<code>/etc/default/useradd</code>文件内容： <div class=highlight><pre><span></span><code>GROUP=100
HOME=/home
INACTIVE=-1              # 对应/etc/shadow文件第7列，Inactivity period，密码过期后的宽限期，-1表示不限制
EXPIRE=                  # 对应/etc/shadow文件第8列，Expiration date since Jan 1, 1970，即账号有效期
SHELL=/bin/bash
SKEL=/etc/skel           # 用于生成用户主目录的模版文件
USRSKEL=/usr/etc/skel
CREATE_MAIL_SPOOL=yes
</code></pre></div></p> <p>Rocky的<code>/etc/default/useradd</code>文件内容： <div class=highlight><pre><span></span><code>GROUP=100
HOME=/home
INACTIVE=-1
EXPIRE=
SHELL=/bin/bash
SKEL=/etc/skel
CREATE_MAIL_SPOOL=yes
</code></pre></div></p> <p>在Ubuntu中<code>/etc/default/useradd</code>文件只有下面这一行。 <div class=highlight><pre><span></span><code>SHELL=/bin/sh
</code></pre></div></p> <h4 id=newusers>批量创建用户<code>newusers</code><a class=headerlink href=#newusers title="Permanent link"> ¶</a></h4> <p>格式：<code>newusers &lt;filename&gt;</code>。其中文件<code>&lt;filename&gt;</code>的格式如下： <div class=highlight><pre><span></span><code>&lt;Username&gt;:&lt;Password&gt;:&lt;UID&gt;:&lt;GID&gt;:&lt;User Info&gt;:&lt;Home Dir&gt;:&lt;Default Shell&gt;
</code></pre></div> 举例，创建文件<code>users.txt</code>： <div class=highlight><pre><span></span><code>$ cat ~/users.txt
tester1:123:600:1530:&quot;Test User1,testuser1@abc.com&quot;:/home/tester1:/bin/bash
tester2:123:601:1529:::/bin/bash
tester3:123:::::
tester4:123::::/home/tester4:/bin/tsh
</code></pre></div> 看结果： <div class=highlight><pre><span></span><code>$ cat /etc/passwd | grep tester
tester1:x:600:1530:&quot;Test User1,testuser1@abc.com&quot;:/home/tester1:/bin/bash
tester2:x:601:1529:::/bin/bash
tester3:x:1001:1001:::
tester4:x:1002:1002::/home/tester4:/bin/tsh

$ cat /etc/group | grep tester
tester1:*:1530:
tester2:*:1529:
tester3:*:1001:
tester4:*:1002:

$ sudo cat /etc/shadow | grep tester
tester1:!:19321:0:99999:7:::
tester2:!:19321:0:99999:7:::
tester3:!:19321:0:99999:7:::
tester4:!:19321:0:99999:7:::

$ ls -ld /home/tester*
drwxr-xr-x. 1 tester1 tester1 0 Nov 26 00:32 /home/tester1
drwxr-xr-x. 1 tester4 tester4 0 Nov 26 00:32 /home/tester4
</code></pre></div></p> <h4 id=chpasswd>批量修改密码<code>chpasswd</code><a class=headerlink href=#chpasswd title="Permanent link"> ¶</a></h4> <p>不同方法： <div class=highlight><pre><span></span><code>$ echo username:password | chpasswd

$ chpasswd &lt; file.txt  # file.txt每行的格式是username:password

$ paste -d &quot;:&quot; user.txt passwd.txt | chpasswd
</code></pre></div></p> <p>参数<code>-e</code>：口令以加密的方式传递。否则口令以明文的形式传递。</p> <p>注意：</p> <ul> <li>用户名username必须是已存在的用户</li> <li>普通用户没有使用这个指令的权限</li> <li>如果输入文件是按非加密方式传递的话，请对该文件进行适当的加密。</li> <li>指令文件不能有空行</li> </ul> <p>举例： <div class=highlight><pre><span></span><code>$ echo tester1:112233 | sudo chpasswd
</code></pre></div> <div class=highlight><pre><span></span><code>$ cat chpasswd.txt
tester1:112233
tester2:33445566

$ sudo chpasswd &lt; chpasswd.txt
</code></pre></div></p> <h4 id=openssl-passwd>生成加密密码<code>openssl passwd</code><a class=headerlink href=#openssl-passwd title="Permanent link"> ¶</a></h4> <p>命令<code>openssl passwd</code>格式可以如下方法获得。 <div class=highlight><pre><span></span><code>$ man -f passwd
passwd (1)           - change user password
passwd (1ssl)        - compute password hashes
passwd (5)           - password file

$ man passwd
Man: find all matching manual pages (set MAN_POSIXLY_CORRECT to avoid this)
 * passwd (1)
   passwd (5)
   passwd (1ssl)
Man: What manual page do you want?
Man: 1ssl
</code></pre></div></p> <p>举例（这里用<code>&lt;your_pwsswd_string&gt;</code>代替实际密码）： <div class=highlight><pre><span></span><code># 基于给定字串newpasswd生成sha256加密码，
$ openssl passwd -6 newpasswd
&lt;your_pwsswd_string&gt;

# 创建新用户tester5，赋予加密密码
$ useradd -p &#39;&lt;your_pwsswd_string&gt;&#39; tester1

# 读取用户tester5的密码，可以验证是否和之前的一致
$ sudo getent shadow tester5
tester5:&lt;your_pwsswd_string&gt;:19321:0:99999:7:::
</code></pre></div></p> <h3 id=usermod>修改用户属性<code>usermod</code><a class=headerlink href=#usermod title="Permanent link"> ¶</a></h3> <p>添加用户到附加组 <div class=highlight><pre><span></span><code>$ usermod -a -G GROUP USER
$ usermod -a -G GROUP1,GROUP2,GROUP3 USER
</code></pre></div></p> <p>修改用户主组 <div class=highlight><pre><span></span><code>$ usermod -a -g GROUP USER
</code></pre></div></p> <p>修改用户信息 <div class=highlight><pre><span></span><code>$ usermod -c &quot;GECOS Comments&quot; USER
</code></pre></div></p> <p>修改用户主目录，使用绝对路径，<code>-m</code>参数会把原主目录的内容移动到新主目录。 <div class=highlight><pre><span></span><code>$ usermod -d NEW_HOME_DIR USER
$ usermod -d NEW_HOME_DIR -m USER
</code></pre></div></p> <p>修改用户shell <div class=highlight><pre><span></span><code>$ usermod -s SHELL USER
</code></pre></div></p> <p>修改用户UID <div class=highlight><pre><span></span><code>$ usermod -u UID USER
</code></pre></div></p> <p>修改用户名（不常用），同时也需要修改用户主目录。 <div class=highlight><pre><span></span><code>$ usermod -l NEW_USER USER
</code></pre></div></p> <p>修改用户过期属性，日期格式是<code>YYYY-MM-DD</code> <div class=highlight><pre><span></span><code>$ usermod -e DATE USER
</code></pre></div> 如果设定永不过期，则置空日期： <div class=highlight><pre><span></span><code>$ usermod -e &quot;&quot; USER
</code></pre></div> 查看当前用户的过期日期 <div class=highlight><pre><span></span><code>$ sudo chage -l vagrant
Last password change                    : Oct 30, 2022
Password expires                    : never
Password inactive                   : never
Account expires                     : never
Minimum number of days between password change      : 0
Maximum number of days between password change      : 99999
Number of days of warning before password expires   : 7
</code></pre></div></p> <p>锁定用户。 此命令将在加密密码前插入一个感叹号 (!) 标记。 当<code>/etc/shadow</code>文件中的密码字段包含感叹号时，用户将无法使用密码验证登录系统。 其他登录方法仍然允许，例如基于密钥的身份验证或切换到用户。 如果要锁定账户并禁用所有登录方式，还需要将到期日期设置为1。 <div class=highlight><pre><span></span><code>$ usermod -L USER
$ usermod -L -e 1 USER
</code></pre></div></p> <p>解锁用户 <div class=highlight><pre><span></span><code>$ usermod -U USER
</code></pre></div></p> <h3 id=userdel>删除用户<code>userdel</code><a class=headerlink href=#userdel title="Permanent link"> ¶</a></h3> <p><code>userdel</code>命令执行时，会读取<code>/etc/login.defs</code>文件的内容。 此文件中定义的属性会覆盖<code>userdel</code>的默认行为。 如果在此文件中将<code>USERGROUPS_ENAB</code>设置为<code>yes</code>，<code>userdel</code>将删除与用户同名的组，前提是没有其他用户是该组的成员。</p> <p><code>userdel</code>命令从<code>/etc/passwd</code>和<code>/etc/shadow</code>文件中删除用户条目。</p> <p><code>userdel</code>命令删除用户帐户时，一般不会删除用户主目录和邮件假脱机mail spool目录。 使用<code>-r</code>选项强制删除用户的主目录和邮件假脱机目录。</p> <p>如果要删除的用户仍然处于登录状态，或者有属于该用户的正在运行的进程，则<code>userdel</code>命令不允许删除该用户。</p> <p>使用<code>-f</code>选项强制删除用户帐户，即使用户仍然登录或有属于该用户的正在运行的进程也是如此。</p> <div class=highlight><pre><span></span><code>$ userdel USER
$ userdel -r USER
</code></pre></div> <h3 id=id>查看用户信息<code>id</code><a class=headerlink href=#id title="Permanent link"> ¶</a></h3> <p>类Unix操作系统中的每个用户都由一个不同的整数标识，这个唯一的数字称为UserID。</p> <p>为进程process定义了三种类型的UID，可以根据任务的权限动态更改。</p> <p>定义的三种不同类型的UID是：</p> <ol> <li>真实用户ID（Real UserId）：对于一个进程，Real UserId就是启动它的用户的 UserID。 它定义了这个进程可以访问哪些文件。</li> <li>有效用户名（Effective UserID）：它通常与 Real UserID 相同，但有时会更改为使非特权用户能够访问那些只能由特权用户（如<code>root</code>）访问的文件。</li> <li>保存的用户ID（Saved UserID） ：当一个以提升的权限（通常是<code>root</code>）运行的进程需要做一些低权限的任务时使用，可以通过临时切换到非特权帐户来实现。在执行低权限任务时，有效的<code>UID</code>被更改为某个较低权限的值，并且<code>euid</code>被保存到已保存的<code>userID</code>(suid)中，以便在任务完成时用于切换回特权帐户。</li> </ol> <p>在一个终端窗口执行下面命令，暂停在新密码输入这一步。 <div class=highlight><pre><span></span><code>$ ls -ltr /usr/bin/passwd
-rwsr-xr-x. 1 root shadow 65208 May  8  2022 /usr/bin/passwd

$ passwd
Changing password for vagrant.
Current password:
New password:
</code></pre></div> 新开一个终端窗口。 <div class=highlight><pre><span></span><code>$ ps -a | grep passwd
  3040 pts/0    00:00:00 passwd

$ ps -eo pid,euid,ruid | grep 3040
  3040     0  1000
</code></pre></div> 上面输出可以看出，<code>passwd</code>这个进程的Effective UserID是<code>0</code>。Real UserId是<code>1000</code>.</p> <p><code>id</code>命令查看用户有效的UID和GID。</p> <p>查看当前用户的信息： <div class=highlight><pre><span></span><code>$ id
uid=1000(vagrant) gid=478(wheel) groups=478(wheel),0(root) context=unconfined_u:unconfined_r:unconfined_t:s0
</code></pre></div></p> <p>查看指定用户的信息： <div class=highlight><pre><span></span><code>$ id vagrant
uid=1000(vagrant) gid=478(wheel) groups=0(root),478(wheel)
</code></pre></div></p> <p>查看当前用户的GID： <div class=highlight><pre><span></span><code>$ id -g
478
</code></pre></div></p> <p>查看当前用户的UID： <div class=highlight><pre><span></span><code>$ id -u
1000
</code></pre></div></p> <p>查看当前用户所有组的GID： <div class=highlight><pre><span></span><code>$ id -G
478 0
</code></pre></div></p> <p>查看当前用户名： <div class=highlight><pre><span></span><code>$ id -un
vagrant
</code></pre></div></p> <p>查看当前用户的GID <div class=highlight><pre><span></span><code>$ id -ur
1000
</code></pre></div></p> <p>只有SELinux激活后才有 <div class=highlight><pre><span></span><code>$ id -Z
unconfined_u:unconfined_r:unconfined_t:s0
</code></pre></div></p> <p>类似于<code>whoami</code>命令 <div class=highlight><pre><span></span><code>$ id -znG
wheelroot
</code></pre></div></p> <h3 id=su>切换用户<code>su</code><a class=headerlink href=#su title="Permanent link"> ¶</a></h3> <p>命令<code>su - username</code>是登录式切换用户。会读取目标用户的配置文件，切换至目标用户的主目录。</p> <p>命令<code>su username</code>是非登录式切换用户。不读取目标用户的配置文件，不改变当前工作目录。</p> <p>切换成root用户，并使用zsh shell。 <div class=highlight><pre><span></span><code>$ su -s /usr/bin/zsh
$ su -s /usr/bin/zsh root
</code></pre></div></p> <p>切换成tester1用户，使用bash shell <div class=highlight><pre><span></span><code>$ su - tester1 -s /bin/bash
$ su - -s /bin/bash tester1
</code></pre></div></p> <p>保留当前用户环境不变。 <div class=highlight><pre><span></span><code>$ su -p root
</code></pre></div></p> <p>不交互式切换用户，只用目标用户执行某些命令。 <div class=highlight><pre><span></span><code>$ su -c ps
$ su - root -c &quot;getent passwd&quot;
$ su - root -s /bin/bash -c &quot;getent passwd&quot;
</code></pre></div></p> <p><code>root</code>用户切换至其他用户不需要密码，非<code>root</code>用户切换其他用户需要密码。</p> <h3 id=_6>设置密码<a class=headerlink href=#_6 title="Permanent link"> ¶</a></h3> <h4 id=passwd><code>passwd</code><a class=headerlink href=#passwd title="Permanent link"> ¶</a></h4> <p>修改当前用户自己的密码： <div class=highlight><pre><span></span><code>$ passwd
</code></pre></div></p> <p>修改其他用户的密码： <div class=highlight><pre><span></span><code>$ sudo passwd root
</code></pre></div></p> <p>查看某个用户密码状态： <div class=highlight><pre><span></span><code>$ sudo passwd -S root
root P 10/30/2022 -1 -1 -1 -1

$ sudo passwd -S vagrant
vagrant P 10/30/2022 0 99999 7 -1
</code></pre></div></p> <p>检查全部用户的密码状态： <div class=highlight><pre><span></span><code>$ sudo passwd -Sa
</code></pre></div></p> <p>密码状态说明： <div class=highlight><pre><span></span><code>Username    Status  Date Last Changed   Minimum Age     Maximum Age     Warning Period   Inactivity Period
vagrant     P       10/30/2022          0               99999           7                -1
root        P       10/30/2022          -1              -1              -1               -1
</code></pre></div></p> <p>Status的描述：</p> <ul> <li><code>P</code>: Usable password</li> <li><code>NP</code>: No password</li> <li><code>L</code>: Locked password</li> </ul> <p>Age的一些特殊值：</p> <ul> <li><code>9999</code>: Never expires</li> <li><code>0</code>: Can be changed at anytime</li> <li><code>-1</code>: Not active</li> </ul> <p>强制要求用户下次登录时修改密码： <div class=highlight><pre><span></span><code>$ sudo passwd -e tester1

$ sudo passwd -S tester1
tester1 P 01/01/1970 0 99999 7 -1
</code></pre></div> 用户tester1的密码日期已经被改成<code>01/01/1970</code>了。这个日期算是Unix的“纪元（epoch）”日期，意味着Unix的日期起点，0天。</p> <p>锁定某个用户： <div class=highlight><pre><span></span><code>$ sudo passwd -l tester1

$ sudo passwd -S tester1
tester1 L 01/01/1970 0 99999 7 -1
</code></pre></div> 此时用户<code>tester1</code>的状态栏已经变成了<code>L</code>，锁定状态。</p> <p>解锁某个用户： <div class=highlight><pre><span></span><code>$ sudo passwd -u tester1

$ sudo passwd -S tester1
tester1 P 01/01/1970 0 99999 7 -1
</code></pre></div> 此时用户<code>tester1</code>的状态栏已经从<code>L</code>变回了<code>P</code>，解除了锁定状态。</p> <p>删除用户密码。这个操作慎重，密码删除后该用户可以不需要密码就能访问系统。 <div class=highlight><pre><span></span><code>$ sudo passwd -d tester1

$ sudo passwd -S tester1
tester1 NP 01/01/1970 0 99999 7 -1
</code></pre></div> 此时用户<code>tester1</code>的状态栏是<code>NP</code>。</p> <h4 id=pwgen><code>pwgen</code><a class=headerlink href=#pwgen title="Permanent link"> ¶</a></h4> <p>安装包。</p> <p>mkpasswd命令有歧义，2个同名命令实现不同功能，生成随机密码建议使用<code>pwgen</code>命令。Rocky9没有找到pwgen包。 <div class=highlight><pre><span></span><code>$ sudo zypper in pwgen
$ sudo apt install pwgen
</code></pre></div></p> <p>随机生成长度8位安全密码。 <div class=highlight><pre><span></span><code>$ pwgen -s -1
</code></pre></div></p> <p>随机生成长度14位安全密码。 <div class=highlight><pre><span></span><code>$ pwgen -s -1 14
</code></pre></div></p> <p>随机生成2个长度15位安全密码。 <div class=highlight><pre><span></span><code>$ pwgen -s -1 15 2
</code></pre></div></p> <p>随机生成5个密码，长度10位，每个密码至少含一个特殊字符，结果以列形式输出。 <div class=highlight><pre><span></span><code>$ pwgen -s -1 -y 10 5
</code></pre></div></p> <p>生成长度8，含有数字，含有大小写字母的密码4个，列打印 <div class=highlight><pre><span></span><code>$ pwgen -s -n -c -C -1 8 4
</code></pre></div></p> <p>生成长度8，不含数字，只含小写字母，列打印 <div class=highlight><pre><span></span><code>$ pwgen -s -c -A -0 -1 8 4
</code></pre></div></p> <p>生成长度16，含有数字，含有大小写字母，含有特殊字符的密码3个，行打印 <div class=highlight><pre><span></span><code>$ pwgen -s -n -c -y -1 16 3
</code></pre></div></p> <p>生成长度80，不含元音和数字，至少含有一个大写字母，行打印 <div class=highlight><pre><span></span><code>$ pwgen -s -v -c -0 80 1
</code></pre></div></p> <h4 id=_7>非交互式设置密码<a class=headerlink href=#_7 title="Permanent link"> ¶</a></h4> <p>方法1： <div class=highlight><pre><span></span><code>$ echo -e &#39;123456\n123456&#39; | sudo passwd tester1
New password: BAD PASSWORD: it is too simplistic/systematic
BAD PASSWORD: is too simple
Retype new password: passwd: password updated successfully
</code></pre></div></p> <p>方法2：</p> <p>Rocky中可以使用下面方法。 <div class=highlight><pre><span></span><code>$ pwgen -ncy1 16 1 | tee passwd.txt | sudo passwd --stdin tester1
</code></pre></div> openSUSE和Ubuntu可以用下面方法。 <div class=highlight><pre><span></span><code>$ echo &quot;tester1:&quot;`pwgen -ncy1 16 1` | tee passwd.txt | sudo chpasswd
</code></pre></div></p> <p>方法3：根据预先给定的用户列表，批量生成密码。 <div class=highlight><pre><span></span><code>$ cat &gt; user-list.txt &lt;&lt;EOF
user0
user1
user2
user3
user4
user5
user6
user7
user8
user9
EOF

$ for i in $(cat user-list.txt); do sudo useradd $i; echo &quot;$i:&quot;`pwgen -s -1 15 1` | tee passwd_$i.txt | sudo chpasswd; done

$ for i in $(cat user-list.txt); do sudo userdel $i; done
</code></pre></div></p> <h3 id=_8>设置用户密码策略<a class=headerlink href=#_8 title="Permanent link"> ¶</a></h3> <p>命令<code>chage</code>修改用户密码策略。</p> <p>总结：</p> <ul> <li><code>-d</code>: Last password change : 上一次密码更改的日期。</li> <li><code>-M</code>: Password expires : 密码保持有效的最大天数。基于Last password change日期计算。设为<code>-1</code>表示不过期。</li> <li><code>-I</code>: Password inactive : 密码失效时间，在<code>Password expires</code>后，直至账号锁定之间的天数。设为<code>-1</code>表示不过期。</li> <li><code>-E</code>: Account expires : 帐号到期的日期。到期后，此帐号将不可用。设为<code>-1</code>表示不过期。</li> <li><code>-m</code>: Minimum number of days between password change : 两次改变密码之间相距的最小天数。</li> <li><code>-M</code>: Maximum number of days between password change : 两次改变密码之间相距的最大天数。</li> <li><code>-W</code>: Number of days of warning before password expires : 用户密码到期前，提前收到警告信息的天数。</li> </ul> <p>显示用户密码策略（时效信息）： <div class=highlight><pre><span></span><code>$ sudo chage -l tester1
Last password change                    : Nov 27, 2022
Password expires                    : never
Password inactive                   : never
Account expires                     : never
Minimum number of days between password change      : 0
Maximum number of days between password change      : 99999
Number of days of warning before password expires   : 7
</code></pre></div></p> <p>设置用户密码的最后修改日期： <div class=highlight><pre><span></span><code>$ sudo chage -d 2022-11-11 tester1

$ sudo chage -l tester1
Last password change                    : Nov 11, 2022
Password expires                    : never
Password inactive                   : never
Account expires                     : never
Minimum number of days between password change      : 0
Maximum number of days between password change      : 99999
Number of days of warning before password expires   : 7
</code></pre></div></p> <p>设置用户账号的过期日期： <div class=highlight><pre><span></span><code>$ sudo chage -E 2022-12-31 tester1

$ sudo chage -l tester1
Last password change                    : Nov 11, 2022
Password expires                    : never
Password inactive                   : never
Account expires                     : Dec 31, 2022
Minimum number of days between password change      : 0
Maximum number of days between password change      : 99999
Number of days of warning before password expires   : 7
</code></pre></div></p> <p>设置用户密码最小/最大修改天数。注意，密码过期日期<code>Password expires</code>是按照max days来计算的。 <div class=highlight><pre><span></span><code>$ sudo chage -M 35 tester1
$ sudo chage -m 30 tester1

$ sudo chage -l tester1
Last password change                    : Nov 11, 2022
Password expires                    : Dec 16, 2022
Password inactive                   : never
Account expires                     : Dec 31, 2022
Minimum number of days between password change      : 30
Maximum number of days between password change      : 35
Number of days of warning before password expires   : 7
</code></pre></div></p> <p>设置用户账号在密码过期<code>Password expires</code>后，直至账号锁定之间的天数，即密码失效时间Password inactive。 <div class=highlight><pre><span></span><code>$ sudo chage -I 3 tester1

$ sudo chage -l tester1
Last password change                    : Nov 11, 2022
Password expires                    : Dec 16, 2022
Password inactive                   : Dec 19, 2022
Account expires                     : Dec 31, 2022
Minimum number of days between password change      : 30
Maximum number of days between password change      : 35
Number of days of warning before password expires   : 7
</code></pre></div></p> <p>设置用户密码到期前，提前收到警告信息的天数。默认值是7天。 <div class=highlight><pre><span></span><code>$ sudo chage -W 5 tester1

$ sudo chage -l tester1
Last password change                    : Nov 11, 2022
Password expires                    : Dec 16, 2022
Password inactive                   : Dec 19, 2022
Account expires                     : Dec 31, 2022
Minimum number of days between password change      : 30
Maximum number of days between password change      : 35
Number of days of warning before password expires   : 5
</code></pre></div></p> <h2 id=_9>组管理<a class=headerlink href=#_9 title="Permanent link"> ¶</a></h2> <p>组管理命令：</p> <ul> <li><code>groupadd</code></li> <li><code>groupmod</code></li> <li><code>groupdel</code></li> <li><code>groupmems</code></li> </ul> <h3 id=groupadd>创建组<code>groupadd</code><a class=headerlink href=#groupadd title="Permanent link"> ¶</a></h3> <p>创建普通组。 <div class=highlight><pre><span></span><code>$ sudo groupadd developers
</code></pre></div></p> <p>创建系统组，并指定GID。 <div class=highlight><pre><span></span><code>$ sudo groupadd -g 48 -r apache
$ sudo groupadd -g 1100 -r developers
</code></pre></div></p> <p>覆盖配置文件<code>/ect/login.defs</code> <div class=highlight><pre><span></span><code>$ groupadd -K GID_MIN=500 -K GID_MAX=700
</code></pre></div></p> <h3 id=groupmod>修改组<code>groupmod</code><a class=headerlink href=#groupmod title="Permanent link"> ¶</a></h3> <p>命令<code>groupmod</code>涉及下面这些文件：</p> <p><code>/etc/group</code>: Group Account Information. <code>/etc/gshadow</code>: Secured group account information. <code>/etc/login.def</code>: Shadow passwd suite configuration. <code>/etc/passwd:</code> User account information.</p> <p>组改名： <div class=highlight><pre><span></span><code>$ sudo groupmod -n group_new group_old
</code></pre></div></p> <h3 id=groupdel>删除组<code>groupdel</code><a class=headerlink href=#groupdel title="Permanent link"> ¶</a></h3> <p>命令<code>groupdel</code>涉及下面这些文件：</p> <ul> <li><code>/etc/group</code> : It contains the account information of the Group.</li> <li><code>/etc/gshadow</code>: It contains the secure group account information.</li> </ul> <p>如果组中包含有用户，则必须先删除这些用户后，才能删除组。 <div class=highlight><pre><span></span><code>$ sudo groupdel group_name
</code></pre></div></p> <h3 id=gpasswd>更改组成员和密码<code>gpasswd</code><a class=headerlink href=#gpasswd title="Permanent link"> ¶</a></h3> <p>命令<code>gpasswd</code>用来修改组成员和密码。</p> <p>涉及到的文件：</p> <ul> <li><code>/etc/group</code>: Group account information.</li> <li><code>/etc/gshadow</code>: Secure group account information. </li> </ul> <p>给组<code>developers</code>设密码。 <div class=highlight><pre><span></span><code>$ sudo gpasswd developers
</code></pre></div></p> <p>取消组<code>developers</code>密码。 <div class=highlight><pre><span></span><code>$ sudo gpasswd -r developers
</code></pre></div></p> <p>给组<code>developers</code>添加用户。 <div class=highlight><pre><span></span><code>$ sudo gpasswd -a tester1,tester2,tester3 developers
</code></pre></div></p> <p>从组<code>developers</code>中删除用户。 <div class=highlight><pre><span></span><code>$ sudo gpasswd -d tester3 developers
</code></pre></div></p> <p>设定用户<code>tester1</code>成为组<code>developers</code>的管理员。 <div class=highlight><pre><span></span><code>$ sudo gpasswd -A tester1 developers
</code></pre></div></p> <p>注意：添加用户到某一个组 也可以通过<code>usermod -G group_name user_name</code>这个实现，但是该用户以前的组会被清空掉。 所以，如果要添加一个用户到一个新组，同时希望保留该用户以前的组时，使用<code>gpasswd</code>这个命令来添加用户到新组中。</p> <h3 id=groupmems>修改组成员<code>groupmems</code><a class=headerlink href=#groupmems title="Permanent link"> ¶</a></h3> <p>使用命令<code>groupmems</code>，需要安装软件包。 <div class=highlight><pre><span></span><code># openSUSE
sudo zypper in libvshadow-tools
# Ubuntu
sudo apt install libvshadow-utils
# Rocky
sudo yum search shadow-utils
</code></pre></div></p> <p>添加用户到组。 <div class=highlight><pre><span></span><code>$ sudo groupmems -a tester1 -g developers
$ sudo groupmems -a tester2 -g developers

$ cat /etc/group | grep developers
developers:x:1002:tester1,tester2
</code></pre></div></p> <p>从组中删除用户。 <div class=highlight><pre><span></span><code>$ sudo groupmems -d tester2 -g developers

$ cat /etc/group | grep developers
developers:x:1002:tester1
</code></pre></div></p> <p>列出组中用户。 <div class=highlight><pre><span></span><code>$ sudo groupmems -l -g developers
tester1
</code></pre></div></p> <p>切换当前组为<code>developers_sre</code>，添加用户<code>tester2</code>到当前组，可以不用在后续命令中使用<code>-g</code>指定组。 <div class=highlight><pre><span></span><code>$ sudo groupmems -g developers_sre

$ sudo groupmems -a tester2

$ sudo groupmems -l
tester2
</code></pre></div></p> <p>切换当前组为<code>developers_sre</code>，从当前组中删除所有用户（这里无法指定某用户）。 <div class=highlight><pre><span></span><code>$ sudo groupmems -g developers_sre
$ sudo groupmems -p
</code></pre></div></p> <h3 id=group>查看组关系<code>group</code><a class=headerlink href=#group title="Permanent link"> ¶</a></h3> <p>显示当前用户所属主的信息。 <div class=highlight><pre><span></span><code>$ whoami
vagrant

$ groups
sudo adm cdrom dip plugdev lxd
</code></pre></div></p> <p>查看指定用户所属组的信息。 <div class=highlight><pre><span></span><code>$ groups vagrant
vagrant : sudo adm cdrom dip plugdev lxd
</code></pre></div></p> <h2 id=_10>练习<a class=headerlink href=#_10 title="Permanent link"> ¶</a></h2> <ol> <li> <p>创建用户<code>gentoo</code>，附加组为<code>bin</code>和<code>root</code>，默认shell为<code>/bin/csh</code>，注释信息为"Gentoo Distribution" <div class=highlight><pre><span></span><code>$ sudo useradd -G bin,root -s /bin/csh -c &quot;Gentoo Distribution&quot; gentoo
</code></pre></div></p> </li> <li> <p>创建下面的用户、组和组成员关系</p> </li> <li> <p>名字为<code>webs</code>的组</p> </li> <li>用户<code>nginx</code>，使用<code>webs</code>作为附属组</li> <li>用户<code>varnish</code>，也使用<code>webs</code>作为附属组</li> <li>用户<code>mysql</code>，不可交互登录系统，且不是<code>webs</code>的成员，<code>nginx</code>，<code>varnish</code>，<code>mysql</code>密码都是<code>opensuse</code>。</li> </ol> <div class=highlight><pre><span></span><code>$ sudo groupadd webs
$ sudo useradd -G webs nginx
$ sudo useradd -G webs varnish
$ sudo useradd -s /sbin/nologin mysql

$ echo &quot;nginx:opensuse&quot; | sudo chpasswd
$ echo -e &quot;opensuse\nopensuse&quot; | sudo passwd varnish
$ echo &quot;mysql:opensuse&quot; | sudo chpasswd
</code></pre></div> <ol> <li> <p>查看UID、GID范围的配置文件,修改为501-60000。并查看密码加密算法 <div class=highlight><pre><span></span><code>$ cat /etc/login.defs
...
GID_MIN             1000
GID_MAX            60000
...
UID_MIN             1000
UID_MAX            60000
...
ENCRYPT_METHOD SHA512
...
</code></pre></div></p> </li> <li> <p>查看创建用户时的模板配置文件 <div class=highlight><pre><span></span><code>$ cat /etc/default/useradd
# useradd defaults file
GROUP=100
HOME=/home
INACTIVE=-1
EXPIRE=
SHELL=/bin/bash
SKEL=/etc/skel
USRSKEL=/usr/etc/skel
CREATE_MAIL_SPOOL=yes
</code></pre></div></p> </li> <li> <p>创建一个新用户<code>webuser</code>，指定登录时起始目录<code>/www</code>，同时加入<code>apache</code>附加组中,指定UID为<code>999</code>且不检查uid唯一性。 <div class=highlight><pre><span></span><code>$ sudo useradd -d /www -G apache -u 999 -o webuser
</code></pre></div></p> </li> <li> <p>修改创建用户时的默认设置，主目录/www，默认shell <code>csh</code>。查看创建用户的配置文件是否更改，若更改则恢复默认值 <div class=highlight><pre><span></span><code>$ sudo useradd -Db /www -s /bin/csh

$ sudo cat /etc/default/useradd
# useradd defaults file
GROUP=100
HOME=/www
INACTIVE=-1
EXPIRE=
SHELL=/bin/csh
SKEL=/etc/skel
USRSKEL=/usr/etc/skel
CREATE_MAIL_SPOOL=yes

$ sudo useradd -Db /home -s /bin/bash
</code></pre></div></p> </li> <li> <p>批量创建用户<code>admin1</code>、<code>admin2</code>、<code>admin3</code>。 <div class=highlight><pre><span></span><code>$ cat &gt; user.txt &lt;&lt;EOF
admin1
admin2
admin3
EOF

$ for i in $(cat user.txt); do sudo useradd $i; echo &quot;$i:&quot;`pwgen -s -1 15 1` | tee passwd_$i.txt | sudo chpasswd; done
</code></pre></div></p> </li> <li> <p>只查看用户<code>admin2</code>、<code>admin3</code>在<code>/etc/passwd</code>的配置信息。 <div class=highlight><pre><span></span><code>$ getent passwd admin2 admin3
admin2:x:1019:100::/home/admin2:/bin/bash
admin3:x:1020:100::/home/admin3:/bin/bash
</code></pre></div></p> </li> <li> <p>修改<code>admin2</code>用户UID为<code>2002</code>、主组<code>root</code>、添加新的附加组<code>apache</code>且保留旧的附加组。然后锁定用户。 <div class=highlight><pre><span></span><code>$ sudo usermod -u 2002 -g root -G apache -a admin2
$ sudo usermod -L admin2

$ getent passwd admin2
admin2:x:2002:0::/home/admin2:/bin/bash

$ sudo passwd -S admin2
admin2 L 11/27/2022 0 99999 7 -1
</code></pre></div></p> </li> <li> <p>修改用户<code>admin2</code>用户名为<code>smith</code>，设置账号过期时间为<code>2022-12-31</code>。 <div class=highlight><pre><span></span><code>$ sudo usermod -l smith -e 2022-12-31 admin2

$ sudo chage -l smith
Last password change                   : Nov 27, 2022
Password expires                   : never
Password inactive                  : never
Account expires                        : Dec 31, 2022
Minimum number of days between password change     : 0
Maximum number of days between password change     : 99999
Number of days of warning before password expires  : 7
</code></pre></div></p> </li> <li> <p>给<code>admin1</code>设置密码<code>hello</code>，然后指定新的主目录并把旧目录移动过去。 <div class=highlight><pre><span></span><code>$ sudo usermod -d /home/admin_new -m admin1
$ echo &quot;admin1:hello&quot; | sudo chpasswd 
</code></pre></div></p> </li> <li> <p>显示<code>smith</code>用户UID、GID、显示用户名、显示用户所属组ID <div class=highlight><pre><span></span><code>$ id -u smith
2002

$ id -g smith
0

$ id -un smith
smith

$ id -gn smith
root
</code></pre></div></p> </li> <li> <p>锁定<code>smith</code>用两种方法 <div class=highlight><pre><span></span><code>$ sudo passwd -l smith
$ sudo usermod -L smith
</code></pre></div></p> </li> <li> <p>指定<code>admin3</code>的密码最短使用日期为5天，最常使用日期为10天，提前2天提示修改密码。 <div class=highlight><pre><span></span><code>$ sudo chage -M 10 -m 5 -W 2 admin3

$ sudo chage -l admin3
Last password change                   : Nov 27, 2022
Password expires                   : Dec 07, 2022
Password inactive                  : never
Account expires                        : never
Minimum number of days between password change     : 5
Maximum number of days between password change     : 10
Number of days of warning before password expires  : 2
</code></pre></div></p> </li> <li> <p>创建系统组<code>newadm</code>，指定GID为<code>66</code>。 <div class=highlight><pre><span></span><code>$ sudo groupadd -r -g 66 newadm
</code></pre></div></p> </li> <li> <p>修改<code>newadm</code>组名为<code>newgrp</code> 修改GID为<code>67</code>。 <div class=highlight><pre><span></span><code>$ sudo groupmod -n newgrp -g 67 newadm
</code></pre></div></p> </li> <li> <p>将用户<code>admin1</code>添加进组<code>newgrp</code>，然后删除组<code>newgrp</code>。 <div class=highlight><pre><span></span><code>$ sudo usermod -g newgrp admin1
$ sudo groupdel -f newgrp
</code></pre></div></p> </li> <li> <p>设置<code>smith</code>用户的详细描述，然后用finger查看。 <div class=highlight><pre><span></span><code>$ chfn smith

$ finger smith
Login: smith                   Name:
Directory: /home/admin2                Shell: /bin/bash
Never logged in.
No Mail.
No Plan.
</code></pre></div></p> </li> <li> <p>删除用户<code>admin1</code>，并删除其主目录。 <div class=highlight><pre><span></span><code>$ sudo userdel -r admin1
$ sudo userdel -r admin2
</code></pre></div></p> </li> </ol> <h2 id=_11>权限管理<a class=headerlink href=#_11 title="Permanent link"> ¶</a></h2> <p>执行命令<code>ls -ihl</code>，可以得到下面的输出结果（Rocky 9）。 <div class=highlight><pre><span></span><code>67274680 -rw-r--r--. 3 vagrant wheel 31 Nov  1 11:14 file
67274680 -rw-r--r--. 3 vagrant wheel 31 Nov  1 11:14 hardlinkfile1
67274680 -rw-r--r--. 3 vagrant wheel 31 Nov  1 11:14 hardlinkfile2
67274681 lrwxrwxrwx. 1 vagrant wheel  4 Nov  1 10:43 symlinkfile1 -&gt; file
67274683 lrwxrwxrwx. 1 vagrant wheel 12 Nov  1 11:20 symlinkfile1-1 -&gt; symlinkfile1
67274682 lrwxrwxrwx. 1 vagrant wheel  4 Nov  1 10:43 symlinkfile2 -&gt; file
33555262 drwxr-xr-x. 2 vagrant wheel  6 Nov  1 11:30 typelink
</code></pre></div></p> <p>以<code>67274680 -rw-r--r--. 3 vagrant wheel 31 Nov 1 11:14 file</code>为例：</p> <ul> <li><code>67274680</code>: inode 索引节点编号。</li> <li><code>-rw-r--r--</code>：文件类型及权限</li> <li><code>-</code>：文件类型，例子中出现了三种，<code>-</code>，<code>l</code>和<code>d</code>。<ul> <li><code>-</code>：普通文件</li> <li><code>d</code>：目录</li> <li><code>l</code>：符号链接文件（link）</li> <li><code>b</code>：块设备（block）</li> <li><code>c</code>：字符设备（character）</li> <li><code>p</code>：管道文件（pipe）</li> <li><code>s</code>：套接字文件（socket）</li> </ul> </li> <li><code>rw-r--r--</code>：文件权限，从左到右依次为：（用户的最终权限，是从左向右匹配，一旦匹配则权限立即生效，不再向右继续匹配）<ul> <li><code>rw-</code>：文件属主权限（u），例子中是<code>vagrant</code>。</li> <li><code>r--</code>：文件属组的权限（g），例子中是<code>wheel</code>。</li> <li><code>r--</code>：其他组的权限（o）。</li> </ul> </li> <li><code>.</code>：这个点表示文件带有SELinux的安全上下文（SELinux Contexts）。关闭SELinux，新创建的文件就不会再有这个点了。但是，以前创建的文件本来有这个点的还会显示这个点（虽然SELinux不起作用了）。</li> <li><code>3</code>：硬链接数，例子中<code>file</code>和<code>hardlinkfile1</code>和<code>hardlinkfile2</code>之间是硬链接，所以这三个文件的硬链接数都是<code>3</code>。</li> <li><code>vagrant</code>：文件属主owner</li> <li><code>wheel</code>：文件属组group</li> <li><code>31</code>：文件或目录的大小</li> <li><code>Nov 1 11:14</code>：文件或目录的创建日期和时间</li> <li><code>file</code>：文件或目录名称</li> </ul> <p>下面是命令<code>ls -ihl</code>在openSUSE和Ubuntu上的显示结果。 <div class=highlight><pre><span></span><code>$ ls -ihl
233647 -rw-r--r-- 3 vagrant wheel 31 Nov  1 15:52 file
233647 -rw-r--r-- 3 vagrant wheel 31 Nov  1 15:52 hardlinkfile1
233647 -rw-r--r-- 3 vagrant wheel 31 Nov  1 15:52 hardlinkfile2
233648 lrwxrwxrwx 1 vagrant wheel  4 Nov  1 15:52 symlinkfile1 -&gt; file
233650 lrwxrwxrwx 1 vagrant wheel 12 Nov  1 15:52 symlinkfile1-1 -&gt; symlinkfile1
233649 lrwxrwxrwx 1 vagrant wheel  4 Nov  1 15:52 symlinkfile2 -&gt; file
233646 drwxr-xr-x 1 vagrant wheel  0 Nov  1 15:51 typelink
</code></pre></div></p> <h3 id=chown>修改属主<code>chown</code><a class=headerlink href=#chown title="Permanent link"> ¶</a></h3> <p><code>chown</code>命令修改文件属主（所有者，owner）。</p> <p>修改文件属主为root。 <div class=highlight><pre><span></span><code>$ ll f1.txt
-rw-r--r--. 1 vagrant wheel 41 Nov 14 22:23 f1.txt

$ sudo chown root f1.txt

$ ll f1.txt
-rw-r--r--. 1 root wheel 41 Nov 14 22:23 f1.txt
</code></pre></div></p> <p>修改文件的属组为bin。 <div class=highlight><pre><span></span><code>$ sudo chown :bin f1.txt

$ ll f1.txt
-rw-r--r--. 1 root bin 41 Nov 14 22:23 f1.txt
</code></pre></div></p> <p>同时修改文件的属主和属组。 <div class=highlight><pre><span></span><code>$ sudo chown vagrant.wheel f1.txt

$ ll f1.txt
-rw-r--r--. 1 vagrant wheel 41 Nov 14 22:23 f1.txt
</code></pre></div></p> <p>参照某文件修改另一文件的属性。 <div class=highlight><pre><span></span><code>$ ll file.py
-rw-r--r--. 1 vagrant wheel  56 Nov 13 22:50 file.py

$ ll user.txt
-rw-r--r--. 1 root bin 21 Nov 27 23:59 user.txt

$ sudo chown root.bin user.txt

$ sudo chown --reference=user.txt file.py

$ ll file.py
-rw-r--r--. 1 root bin 56 Nov 13 22:50 file.py
</code></pre></div></p> <p>递归修改所有子目录及文件的属主和属组。 <div class=highlight><pre><span></span><code>$ sudo chown -R vagrant.wheel ~
</code></pre></div></p> <h3 id=chgrp>修改属组<code>chgrp</code><a class=headerlink href=#chgrp title="Permanent link"> ¶</a></h3> <p>修改目录的属组。 <div class=highlight><pre><span></span><code>sudo chgrp bin ~~
</code></pre></div></p> <p>修改目录及子目录及文件的属组。 <div class=highlight><pre><span></span><code>sudo chgrp -R bin ~~
</code></pre></div></p> <h3 id=_12>文件和目录权限<a class=headerlink href=#_12 title="Permanent link"> ¶</a></h3> <p>文件：</p> <ul> <li><code>r</code>：可以读取该文件内容，比如通过<code>cat</code>命令。</li> <li><code>w</code>：可以修改该文件内容，可以只有<code>w</code>而没有<code>r</code>。</li> <li><code>x</code>：可以把该文件提请内核启动为一个进程，即可以执行该文件（该文件的内容必须是可以执行）。</li> </ul> <p>目录：（对目录而言，通常需要给<code>r</code>和<code>x</code>权限）（从目录角度看，目录内文件列表等于目录节点的内容）</p> <ul> <li><code>r</code>：能看文件列表，但不能访问所含文件的内容及其属性信息，包括inode号。</li> <li><code>w</code>：能在该目录内创建和删除文件，不由目录内文件本身的权限决定。</li> <li><code>x</code>：能cd进目录，能通过<code>ls -l file</code>和<code>stat file</code>查看该目录中制定文件的元数据。</li> <li> <p><code>X</code>：表示只有当该文件是个子目录或者该文件已经被设定过为可执行。</p> </li> <li> <p>有只读权限的用户不能用cd进入该目录，还必须有执行权限才能进入。</p> </li> <li>有执行权限的用户只有在知道文件名，并拥有读权利的情况下才可以访问目录下的文件。</li> <li>必须有读和执行权限才可以ls列出目录清单，或使用cd命令进入目录。</li> <li>有目录的写权限，可以创建、删除或修改目录下的任何文件或子目录，即使使该文件或子目录属于其他用户也是如此。</li> </ul> <p>常用权限例子： <div class=highlight><pre><span></span><code>-rw------- (600) 只有所有者才有读和写的权限
-rw-r--r-- (644) 只有所有者才有读和写的权限，组和其他人只有读的权限
-rwx------ (700) 只有所有者才有读，写，执行的权限
-rwxr-xr-x (755) 只有所有者才有读，写，执行的权限，组和其他人只有读和执行的权限
-rwx--x--x (711) 只有所有者才有读，写，执行的权限，组和其他人只有执行的权限
-rw-rw-rw- (666) 每个人都有读写的权限
-rwxrwxrwx (777) 每个人都有读写和执行的权限
</code></pre></div></p> <h3 id=chmod>权限修改<code>chmod</code><a class=headerlink href=#chmod title="Permanent link"> ¶</a></h3> <p>命令格式： <div class=highlight><pre><span></span><code>chmod [-cfvR] [--help] [--version] mode file
</code></pre></div></p> <p><code>mode</code>字串格式为： <div class=highlight><pre><span></span><code>[ugoa][+-=][rwxXst]
</code></pre></div></p> <p>who:</p> <ul> <li><code>u</code>文件所有者</li> <li><code>g</code>文件所有者所在组</li> <li><code>o</code>其他用户</li> <li><code>a</code>所有用户，相当于<code>ugo</code></li> </ul> <p>operator:</p> <ul> <li><code>+</code>为指定的用户类型增加权限</li> <li><code>-</code>去除指定用户类型的权限</li> <li><code>=</code>设置指定用户权限的设置，即将用户类型的所有权限重新设置</li> </ul> <p>permission:</p> <ul> <li><code>r</code>设置为可读权限</li> <li><code>w</code>设置为可写权限</li> <li><code>x</code>设置为可执行权限</li> <li><code>X</code>特殊执行权限，只有当文件为目录文件，或者其他类型的用户有可执行权限时，才将文件权限设置可执行</li> <li><code>s</code>当文件被执行时，根据who参数指定的用户类型设置文件的<code>setuid</code>或者<code>setgid</code>权限</li> <li><code>t</code>设置粘贴位，只有超级用户可以设置该位，只有文件所有者u可以使用该位。</li> </ul> <p>示例：</p> <p>将文件<code>file1.txt</code>设为所有人皆可读取。 <div class=highlight><pre><span></span><code>chmod ugo+r file1.txt
</code></pre></div> 将文件<code>file1.txt</code>设为所有人皆可读取。 <div class=highlight><pre><span></span><code>chmod a+r file1.txt
</code></pre></div> 将文件<code>file1.txt</code>与<code>file2.txt</code>设为该文件属主和属组都可写入，但其他用户不可写入。 <div class=highlight><pre><span></span><code>chmod ug+w,o-w file1.txt file2.txt
</code></pre></div> 为<code>ex1.py</code>文件属主增加可执行权限。 <div class=highlight><pre><span></span><code>chmod u+x ex1.py
</code></pre></div> 将目前目录下的所有文件与子目录皆设为任何人可读取。 <div class=highlight><pre><span></span><code>chmod -R a+r *
</code></pre></div> 给<code>file</code>的所有用户增加读权限 <div class=highlight><pre><span></span><code>chmod a+r file
</code></pre></div> 删除<code>file</code>的所有用户的执行权限 <div class=highlight><pre><span></span><code>chmod a-x file
</code></pre></div> 给<code>file</code>的所有用户增加读写权限 <div class=highlight><pre><span></span><code>chmod a+rw file
</code></pre></div> 给<code>file</code>的所有用户增加读写执行权限 <div class=highlight><pre><span></span><code>chmod +rwx file
</code></pre></div> 对<code>file</code>的属主设置读写权限，清空属组和其他用户对<code>file</code>的所有权限（空格代表无权限） <div class=highlight><pre><span></span><code>chmod u=rw,go= file
</code></pre></div> 对目录<code>docs</code>和其子目录中的所有文件给属主增加读权限，而对属组和其他用户删除读权限 <div class=highlight><pre><span></span><code>chmod -R u+r,go-r docs
</code></pre></div> 对<code>file</code>的属主和属组设置读写权限, 为其他用户设置读权限 <div class=highlight><pre><span></span><code>chmod 664 file
</code></pre></div> 对<code>file</code>的属主设置读写执行权限，相当于<code>u=rwx</code>(4+2+1)，设置属组读和执行权限，相当于<code>go=rx</code>(4+1 &amp; 4+1)。<code>0</code>没有特殊模式 <div class=highlight><pre><span></span><code>chmod 0755 file
</code></pre></div> <code>4</code>设置了设置用户ID位，剩下的相当于<code>u=rwx</code>(4+2+1)和<code>go=rx</code>(4+1 &amp; 4+1)。 <div class=highlight><pre><span></span><code>chmod 4755 file
</code></pre></div> 删除可执行权限对<code>path/</code>以及其所有的目录（不包括文件）的所有用户，使用<code>-type f</code>匹配文件 <div class=highlight><pre><span></span><code>find path/ -type d -exec chmod a-x {} \;
</code></pre></div> 允许所有用户浏览或通过目录<code>path/</code> <div class=highlight><pre><span></span><code>find path/ -type d -exec chmod a+x {} \;
</code></pre></div></p> <h3 id=umask>默认权限<code>umask</code><a class=headerlink href=#umask title="Permanent link"> ¶</a></h3> <p><code>umask</code>的值，定义了所有新建的文件和目录的初始权限的。</p> <p>查看当前权限掩码： <div class=highlight><pre><span></span><code>$ umask
0022
</code></pre></div></p> <p>在不考虑<code>umask</code>的情况下，文件的默认权限是<code>666</code>(rw-rw-rw-)，目录的默认权限是<code>777</code>(rwxrwxrwx)。</p> <p>在<code>umask</code>的值为<code>0022</code>的情况下，文件的默认权限是<code>644</code>(rw-r--r--)，目录的默认权限是<code>755</code>(rwxr-xr-x)。</p> <p>计算方法： <div class=highlight><pre><span></span><code>    Files: 
        (Default) 6 6 6
        (umask)   0 2 2
        ----------------
        (Result)  6 4 4

  Directories: 
        (Default) 7 7 7
        (umask)   0 2 2
        ----------------
    (Result)  7 5 5
</code></pre></div></p> <p>如果<code>umask</code>的值为<code>0077</code>的情况下，文件的默认权限是<code>600</code>(rw-------)，目录的默认权限是<code>700</code>(rwx------)。</p> <p>计算方法： <div class=highlight><pre><span></span><code>    Files: 
        (Default) 6 6 6
        (umask)   0 7 7
        ----------------
        (Result)  6 0 0

  Directories: 
        (Default) 7 7 7
        (umask)   0 7 7
        ----------------
    (Result)  7 0 0
</code></pre></div></p> <p>举例： <div class=highlight><pre><span></span><code>$ umask 022
$ touch file2
$ ll file2
-rw-r--r--. 1 vagrant wheel 0 Nov 28 23:13 file2

$ umask 077
$ touch file1
$ ll file1
-rw-------. 1 vagrant wheel 0 Nov 28 23:12 file1
</code></pre></div> <div class=highlight><pre><span></span><code>$ umask 022
$ mkdir ./tmp1
$ umask 077
$ mkdir ./tmp2

$ ls -dl tmp*
drwxr-xr-x. 1 vagrant wheel 0 Nov 28 23:14 tmp1
drwx------. 1 vagrant wheel 0 Nov 28 23:14 tmp2
</code></pre></div></p> <h3 id=_13>特殊权限<a class=headerlink href=#_13 title="Permanent link"> ¶</a></h3> <p>除了三种常见的权限rwx，还有三种特殊权限：SUID，SGID，Sticky。</p> <p>SUID：属主s权限，称为Set UID</p> <ul> <li> <p>前提：进程有属主和属组，文件有属主和属组</p> <ul> <li>任何可执行程序文件能不能启动为进程，取决于发起者对程序文件是否拥有执行权限。</li> <li>启动为进程之后，其进程的属主为发起者。</li> <li>进程访问文件是的权限，取决于进程的发起者。</li> </ul> </li> <li> <p>只对二进制可执行程序文件有效。当执行该文件时，发起者将自动具有该文件所有者的权限。</p> </li> <li>对目录无效。</li> </ul> <div class=highlight><pre><span></span><code>$ ll file1
-rw-------. 1 vagrant wheel   0 Nov 28 23:12 file1

$ sudo chmod u+s file1

$ ll file1
-rwS------. 1 vagrant wheel 0 Nov 28 23:12 file1
</code></pre></div> <p>如果属主的<code>x</code>位上是-，则在属主的<code>x</code>位上标记大写<code>S</code>，否则标记小写<code>s</code>。如下： <div class=highlight><pre><span></span><code>$ chmod 777 file1

$ ll file1
-rwxrwxrwx. 1 vagrant wheel 0 Nov 28 23:12 file1

$ sudo chmod u+s file1

$ ll file1
-rwsrwxrwx. 1 vagrant wheel 0 Nov 28 23:12 file1
</code></pre></div> 下面2组命令实现同样效果。 <div class=highlight><pre><span></span><code>$ sudo chmod 4xxx file1

$ chmod 777 file1
$ sudo chmod u+s file1
</code></pre></div> 取消SUID。 <div class=highlight><pre><span></span><code>$ sudo chmod u-s file1
</code></pre></div></p> <p>SGID：属组s权限，称为Set GID</p> <ul> <li>如果作用于二进制可执行文件上，当执行该文件为进程之后，发起者将自动具有该文件所属组的权限，进程的属组为发起者的属组。</li> <li>如果作用于目录上，则该目录下新建立的目录和文件都自动从此目录继承。</li> </ul> <p><div class=highlight><pre><span></span><code>$ sudo chmod g+s file2

$ ll file2
-rw-r-Sr--. 1 vagrant wheel 0 Nov 28 23:13 file2
</code></pre></div> 如果属组的<code>x</code>位上是-，则在属组的<code>x</code>位上标记大写<code>S</code>，否则标记小写<code>s</code>。如下： <div class=highlight><pre><span></span><code>$ chmod 777 file2

$ ll file2
-rwxrwxrwx. 1 vagrant wheel 0 Nov 28 23:13 file2

$ sudo chmod g+s file2

$ ll file2
-rwxrwsrwx. 1 vagrant wheel 0 Nov 28 23:13 file2
</code></pre></div></p> <p>下面2组命令实现同样效果。 <div class=highlight><pre><span></span><code>$ sudo chmod 2xxx file2

$ chmod 777 file2
$ sudo chmod g+s file2
</code></pre></div> 取消SGID。 <div class=highlight><pre><span></span><code>$ sudo chmod g-s file2
</code></pre></div></p> <p>对于目录，下面演示可以看到目录下的文件和子目录的继承性。 <div class=highlight><pre><span></span><code>$ ll -d data
drwxr-xr-x. 1 vagrant bin 0 Nov 28 20:55 data

$ sudo chmod g+s .~

$ ll -d data
drwxr-sr-x. 1 vagrant bin 0 Nov 28 20:55 data

$ cd data
$ touch file2
$ ll file2
-rw-r--r--. 1 vagrant bin 0 Nov 29 21:10 file2

$ mkdir tmp3
$ ll -d tmp3
drwxr-sr-x. 1 vagrant bin 0 Nov 29 21:10 tmp3
</code></pre></div></p> <p>Sticky Bit：简称为SBIT权限</p> <ul> <li>只针对目录有效。它表示只能让其属主以及root可以删除、重命名、移动该目录下的文件。</li> <li>Sticky设置在文件上无意义。</li> </ul> <p>如果其他的<code>x</code>位上是-，则在其他的<code>x</code>位上标记大写<code>T</code>，否则标记小写<code>t</code>。 <div class=highlight><pre><span></span><code>$ ll -d .~
drwxr-sr-x. 1 vagrant bin 18 Nov 29 21:10 .~

$ sudo chmod o+t .~

$ ll -d .~
drwxr-sr-t. 1 vagrant bin 18 Nov 29 21:10 .~

$ cd data
$ touch file1
$ mkdir tmp1

$ ll file1
-rw-r--r--. 1 vagrant bin 0 Nov 29 21:37 file1
$ ll -d tmp1
drwxr-sr-x. 1 vagrant bin 0 Nov 29 21:37 tmp1
</code></pre></div></p> <p>特殊权限设置数字法：</p> <p>设置SUID <div class=highlight><pre><span></span><code>              User    Group   Others
              r w s   r w s   r w x
              r w S
    BIN 100   1 1 1   1 1 1   1 1 1
              1 1 0
    OCT   4       7       7       7
                  6
</code></pre></div> 设置SGID <div class=highlight><pre><span></span><code>              User    Group   Others
              r w x   r w s   r w x
              r w S
    BIN 010   1 1 1   1 1 1   1 1 1
                      1 1 0
    OCT   2       7       7       7
                          6
</code></pre></div> 设置Sticky Bit - SBIT <div class=highlight><pre><span></span><code>              User    Group   Others
              r w x   r w x   r w t
                      r w T
    BIN 001   1 1 1   1 1 1   1 1 1
                              1 1 0
    OCT   1       7       7       7
                                  6
</code></pre></div></p> <h3 id=chattr>设定文件特殊属性<code>chattr</code><a class=headerlink href=#chattr title="Permanent link"> ¶</a></h3> <p>命令格式：<code>chattr [ -RVf ] [ -v version ] [ mode ] files...</code></p> <p>其中mode的字串格式：<code>{+|-|=}[aAcCdDeijsStTu]</code></p> <p>属性<code>i</code>： </p> <ul> <li>如果对文件设置<code>i</code>属性，那么不允许对文件进行删除、改名，也不能添加和修改数据；</li> <li>如果对目录设置<code>i</code>属性，那么只能修改目录下文件中的数据，但不允许建立和删除文件；</li> </ul> <p>在openSUSE下执行，分区文件类型是btrfs格式。 <div class=highlight><pre><span></span><code>$ touch filetest
$ lsattr filetest
---------------------- filetest

$ chattr +i filetest
chattr: Operation not permitted while setting flags on filetest
$ sudo chattr +i filetest

$ lsattr filetest
----i----------------- filetest

$ rm filetest
rm: cannot remove &#39;filetest&#39;: Operation not permitted
$ sudo rm filetest
rm: cannot remove &#39;filetest&#39;: Operation not permitted

$ echo &quot;test&quot; &gt;&gt; filetest
-bash: filetest: Operation not permitted
$ sudo echo &quot;test&quot; &gt;&gt; filetest
-bash: filetest: Operation not permitted

$ sudo chattr -i filetest
</code></pre></div></p> <p>属性<code>a</code>：</p> <ul> <li>如果对文件设置<code>a</code>属性，那么只能在文件中増加数据，但是不能删除和修改数据；</li> <li>如果对目录设置<code>a</code>属性，那么只允许在目录中建立和修改文件，但是不允许删除文件；</li> </ul> <p>在openSUSE下执行，分区文件类型是btrfs格式。 <div class=highlight><pre><span></span><code>lsattr filetest
---------------------- filetest
$ chattr +a filetest
chattr: Operation not permitted while setting flags on filetest
$ sudo chattr +a filetest

$ echo &quot;test&quot; &gt;&gt; filetest

$ rm filetest
rm: cannot remove &#39;filetest&#39;: Operation not permitted
$ sudo rm filetest
rm: cannot remove &#39;filetest&#39;: Operation not permitted

$ sudo chattr -a filetest
</code></pre></div></p> <p>属性<code>u</code>：</p> <ul> <li>设置此属性的文件或目录，在删除时，其内容会被保存，以保证后期能够恢复，常用来防止意外删除文件或目录。</li> </ul> <p>在Ubuntu下执行，分区文件类型是ext4格式。 <div class=highlight><pre><span></span><code>$ touch filetest
$ sudo chattr +u filetest

$ lsattr filetest
-u------------e------- filetest

$ rm filetest
</code></pre></div></p> <p>属性<code>s</code>：</p> <ul> <li>和<code>u</code>相反，删除文件或目录时，会被彻底删除（直接从硬盘上删除，然后用0填充所占用的区域），不可恢复。</li> </ul> <div class="admonition attention"> <p class=admonition-title>Attention</p> <p>命令<code>chattr</code>和<code>lsattr</code>的可操作属性依赖于文件所处分区的文件系统类型，例如，ext4和xfs的结果会有不同。</p> <p>历史：命令<code>chattr</code>（用于操作属性）和<code>lsattr</code>（用于列出属性）最初专用于第二个扩展文件系统系列（ext2、ext3、ext4），并且作为<code>e2fsprogs</code>包的一部分提供。然而，此功能已全部或部分扩展到许多其他系统，包括 XFS、ReiserFS、JFS 和 OCFS2。 btrfs 文件系统包括属性功能，包括<code>C</code>标志，由于与<code>CoW</code>相关的性能较慢，它关闭了btrfs的内置写时复制 (CoW) 功能。</p> </div> <h2 id=acl>访问控制列表ACL<a class=headerlink href=#acl title="Permanent link"> ¶</a></h2> <h3 id=acl_1>ACL<a class=headerlink href=#acl_1 title="Permanent link"> ¶</a></h3> <p>ACL的全称是Access Control List。</p> <p>传统的POSIX权限概念使用三种用户类型来分配文件系统中的权限：所有者Owning Owner，所有者组Owning Group和其他用户Other Users。可以为每个用户类型设置三个权限位，赋予读（r），写（w）和执行（x）的权限。</p> <ul> <li>所有者Owning Owner权限（属主权限）</li> <li>属组Owning Group权限</li> <li>其他（经过身份验证的）用户Other Users的权限</li> </ul> <p>传统的三种权限适用于大多数实际案例。但是，对于更复杂的场景或更高级的应用程序，系统管理员必须使用许多技巧来规避传统权限的限制。</p> <p>访问控制列表ACL提供了对传统文件权限概念的扩展。它们允许我们为单个用户或组分配权限，即使这些用户或组与原始所有者或属组不对应。</p> <p>ACL是Linux内核的一项功能，支持Ext&#8532;/4，XFS和BtrFS文件系统以及其他文件系统。</p> <p>使用ACL，我们可以创建复杂的方案，而无需在应用程序级别上去实现复杂的权限模型。在使用提供Samba文件和打印服务的Linux服务器替换Windows服务器的情况下，ACL的优势非常明显。由于Samba支持ACL，因此可以在Linux服务器和Windows中配置用户权限。</p> <p>通过ACL来允许对所有者用户之外的单个用户进行文件写权限是一种简单的方案。使用传统方法，我们必须创建一个新组，使两个用户成为该组的成员，将该文件的所有组更改为新组，然后授予该组文件的写权限。创建组并使两个用户成为该组的成员则需要利用root权限来实现。</p> <p>使用ACL，我们可以通过使所有者和指定用户对文件具有写权限来实现相同的结果。</p> <p>此方法的另一个优点是系统管理员无需参与创建组。用户可以自己决定授予谁访问其文件的权限。</p> <div class="admonition attention"> <p class=admonition-title>Attention</p> <p>使用ACL时<code>ls</code>的输出结果会发生变化。添加一个加号+ 来说明已为此文件定义ACL，且定义ACL后，所显示的属组权限是ACL掩码的值，而不再是原来属组的权限。</p> </div> <h3 id=acl_2>ACL的基本类型<a class=headerlink href=#acl_2 title="Permanent link"> ¶</a></h3> <ul> <li>Minimal ACLs（最小ACL）（实际用途：与POSIX权限相同）<ul> <li>与文件模式权限位等效的ACL称为最小ACL</li> <li>分三种类型的ACL条目，这些对应于文件和目录的传统权限位<ul> <li>Owning User 所有者</li> <li>Owning Group 所有者组</li> <li>Others 其他组 </li> </ul> </li> </ul> </li> <li>Extended ACLs（扩展ACL）<ul> <li>具有多于上述三个ACL条目的ACL称为扩展ACL</li> <li>扩展ACL还包含掩码条目，可以包含任意数量的指定用户和指定组条目</li> </ul> </li> </ul> <h3 id=acl_3>ACL术语<a class=headerlink href=#acl_3 title="Permanent link"> ¶</a></h3> <ul> <li>用户类（User classes）。 传统的POSIX权限概念使用三种用户类来分配文件系统中的权限：所有者Owning Owner，所有者组Owning Group和其他用户Other Users。可以为每个用户类型设置三个权限位，赋予读（r），写（w）和执行（x）的权限。<ul> <li>Owner class 所有者类</li> <li>Group class 组类</li> <li>Other class 其他类</li> </ul> </li> <li>ACL访问权限（Access ACL）：确定各种文件系统对象（文件和目录）的用户和组的访问权限。</li> <li>默认ACL（Default ACL）：只能应用于目录。 它们确定文件系统对象在创建时从其父目录继承的权限。</li> <li>ACL条目（ACL entry）：<ul> <li>每个ACL由一组ACL条目组成。 </li> <li>ACL条目包含类型（type），条目引用的用户或组的限定符（qualifier），以及一组权限（permissions）。</li> <li>对于某些条目类型，未定义组或用户的限定符。</li> </ul> </li> </ul> <p><img alt="The mapping of minimal ACLs" src=../assets/Mapping%20of%20Minimal%20ACLs.png></p> <h3 id=acl_4>ACL权限分类<a class=headerlink href=#acl_4 title="Permanent link"> ¶</a></h3> <ul> <li>Named user 指定用户: Lets you assign permissions to individual users. 允许我们为指定用户分配权限。</li> <li>Named group 指定组: Lets you assign permissions to individual groups. 允许我们为制定组分配权限。</li> <li>Mask 掩码: Lets you limit the permissions granted to named users or groups. 允许我们限制给予指定用户或指定组的权限。</li> </ul> <p>所以可能的ACL类型 ß | Type | Text Form | |--------------|-----------------------| | owner | user::rwx | | named user | user:name:rwx | | owning group | group::rwx | | named group | group:name:rwx | | mask | mask::rwx | | other | other::rwx |</p> <p>与POSIX.1权限模型不同，组类group class可以包含具有不同权限集的ACL条目，因此单独的组类权限不再足以表示它包含的所有ACL条目的所有详细权限。</p> <p>因此，组类型权限的含义被重新定义。在新语义下，组类型权限表示组类中的任何条目将授予的权限的**上限**（upper bound）。 此上限属性可确保在使用ACL控制后，应用程序不会突然或者意外地授予额外的权限。</p> <p>在最小ACL中，组类权限与所有者组权限相同。在扩展ACL中，组类可以包含其他用户或组的条目。这会导致一个问题：这些附加条目中的一些可能拥有未包含在所有者组条目（owning group entry）中的权限，因此所有者组条目权限可能与组类权限（group class）不同。 </p> <p>通过掩码（mask entry）解决了这个问题。</p> <ul> <li>使用最小ACL，组类权限映射到所有者组条目权限。With minimal ACLs, the group class permissions map to the owning group entry permissions. </li> <li>使用扩展ACL时，组类权限映射到掩码条目权限，而所有者组条目仍定义拥有组权限。With extended ACLs, the group class permissions map to the mask entry permissions, whereas the owning group entry still defines the owning group permissions.</li> </ul> <h3 id=acl_5>ACL操作命令<a class=headerlink href=#acl_5 title="Permanent link"> ¶</a></h3> <p>设定ACL权限：<code>setfacl</code></p> <ul> <li>Syntax: setfacl [OPTIONS] [ACL-ENTRIES] <file></li> <li>Option Description<ul> <li><code>-m</code>: Add or modify an ACL entry</li> <li><code>-x</code>: Remove an ACL entry</li> <li><code>-d</code>: Set a default ACL</li> <li><code>-b</code>: Remove all extended ACL entries</li> <li><code>-M</code>: restore ACLs that have been written to a file</li> </ul> </li> </ul> <p>注意：--set选项会把原有的ACL项都删除，用新的替代，所以一定要包含UGO的设置，不能像-m医院只添加ACL。 <div class=highlight><pre><span></span><code>setfacl --set u::rw,u:vagrant:rw,g::r,o::- file1
</code></pre></div></p> <p>读取ACL权限：<code>getfacl</code></p> <ul> <li>Syntax: getfacl [OPTIONS] <file></li> <li>Option Description<ul> <li><code>-a</code>: Display the file access control list</li> <li><code>-d</code>: Display the default access control list</li> <li><code>-R</code>: List the ACLs of all files and directories recursively</li> </ul> </li> </ul> <h3 id=acl_6>ACL实例解析<a class=headerlink href=#acl_6 title="Permanent link"> ¶</a></h3> <h4 id=_14>实例描述<a class=headerlink href=#_14 title="Permanent link"> ¶</a></h4> <ul> <li>项目目录<code>~/project1</code><ul> <li>项目经理<code>pm1</code>对这个目录拥有访问和修改权限</li> <li>项目成员<code>tm1</code>可以访问和修改这个目录</li> <li>非项目成员<code>tm2</code>不能访问<code>~/project1</code>目录。</li> </ul> </li> <li>项目目录<code>~/project1</code>的权限规划<ul> <li>项目经理<code>pm1</code>是这个目录的属主，权限为<code>rwx</code></li> <li>项目经理<code>pm1</code>属于<code>project1</code>组</li> <li>项目成员<code>tm1</code>与<code>pm1</code>在同一个<code>project1</code>组，权限是<code>rw</code></li> <li>其他人的权限设定为<code>0</code></li> </ul> </li> <li>项目临时成员tm2的权限需求<ul> <li>能访问<code>project1</code>目录，但只能具有<code>r</code>和<code>x</code>权限</li> </ul> </li> </ul> <p>解决方法</p> <ul> <li>当出现这种情况时，普通权限中的三种身份（owner，group，others）就不能解决这个问题，而ACL权限可以。 在使用ACL权限给用户<code>tm2</code>陚予权限时，<code>tm2</code>既不是<code>~/project1</code>目录的属主，也不是属组，仅仅赋予用户<code>tm2</code>针对<code>~/project1</code>目录的r-x权限， 属于单独指定用户并单独分配权限，解决了用户身份不足的问题。</li> </ul> <p>拓展问题</p> <ul> <li>给<code>~/project1</code>目录添加其他组<code>project2</code>的访问权限</li> <li>通过<code>mask</code>来调整用户<code>tm2</code>实际有效权限</li> <li>默认ACL权限</li> <li>递归ACL权限</li> <li>删除ACL权限</li> </ul> <h4 id=_15>初始化环境<a class=headerlink href=#_15 title="Permanent link"> ¶</a></h4> <p>创建测试用户</p> <div class=highlight><pre><span></span><code>$ whoami
vagrant

$ sudo groupadd project1
$ sudo groupadd project2

$ sudo useradd -m -g project1 pm1
$ sudo useradd -m -g project1 tm1
$ sudo useradd -m -g project2 tm2

$ sudo passwd pm1
$ sudo passwd tm1
$ sudo passwd tm2

$ cat /etc/group
......
project1:x:1535:
project2:x:1536:
......

$ cat /etc/passwd
......
pm1:x:2003:1535::/home/pm1:/bin/bash
tm1:x:2004:1535::/home/tm1:/bin/bash
tm2:x:2005:1536::/home/tm2:/bin/bash
......
</code></pre></div> <p>创建测试目录<code>project1</code>, 指定<code>project1</code>目录的权限，创建测试文件<code>file1</code>。</p> <div class=highlight><pre><span></span><code>$ su - pm1
$ cd ~

$ mkdir project1

$ ls -dl project1
drwxr-xr-x. 1 pm1 project1 0 Dec  4 06:25 project1

$ chmod 770 project1/

$ ls -dl project1
drwxrwx---. 1 pm1 project1 0 Dec  4 06:25 project1

$ echo &quot;hello from $USER&quot; &gt; ./project1/file1

$  cat ./project1/file1
hello from pm1
</code></pre></div> <p>目录<code>project1</code>当前权限快照</p> <ul> <li>属主：<code>pm1</code>，对<code>~/project1</code>目录有<code>rwx</code>权限</li> <li>属组：<code>project1</code>，包含用户<code>pm1</code>和<code>tm1</code>，对<code>~/project1</code>目录有<code>rwx</code>权限</li> <li>其他组：没有访问权限</li> </ul> <p>目录<code>~/project1</code>当前的ACL快照 <div class=highlight><pre><span></span><code>$ getfacl ./project1/
# file: home/pm1/project1/
# owner: pm1
# group: project1
user::rwx
group::rwx
other::---
</code></pre></div></p> <h4 id=acl_7>添加ACL权限<a class=headerlink href=#acl_7 title="Permanent link"> ¶</a></h4> <p>给<code>~/project1</code>目录添加新用户<code>tm2</code>，权限为<code>rwx</code>。目录<code>~/project1</code>的更新后的权限位变成了<code>drwxrwx---+</code>。 <div class=highlight><pre><span></span><code>$ su - pm1

$ setfacl -m u:tm2:rx ./project1/

$ ls -dl ./project1
drwxrwx---+ 1 pm1 project1 0 Dec  4 06:25 project1

$ getfacl ~/project1/
# file: project1   （文件名）
# owner: pm1       （Owner 文件属主）
# group: project1  （Owing Group 文件属组）
user::rwx          （Ower文件属主的权限，用户名栏是空的，说明是属主Owner的权限）
user:tm2:r-x       （Named User 指定用户的权限，用户tm2的权限）
group::rwx         （Owing Group 文件属组的权限，组名栏是空的，说明是属组的权限）
                   （Named Group 指定用户组的权限，此时未指定）
mask::rwx          （mask权限）
other::---         （其他人other的权限）
</code></pre></div></p> <p>给<code>~/project1</code>目录添加新组<code>project2</code>的权限<code>rwx</code> <div class=highlight><pre><span></span><code>$ su - pm1

$ setfacl -m g:project2:rwx ./project1/

$ ls -dl ./project1
drwxrwx---+ 1 pm1 project1 0 Dec  4 06:46 ./project1

$ getfacl ./project1
# file: project1
# owner: pm1
# group: project1
user::rwx
user:tm2:r-x         (用户tm2拥有了r-x权限）
group::rwx
group:project2:rwx   (用户组project2拥有了rwx权限）
mask::rwx
other::---
</code></pre></div></p> <p>有效权限的计算：</p> <p>当前<code>~/project1</code>目录的<code>mask</code>是<code>rwx</code>，<code>tm2</code>的权限是<code>r-x</code>，二者进行AND操作，<code>tm2</code>的实际权限是<code>r-x</code> <div class=highlight><pre><span></span><code>   tm2: r - x (1 0 1)
  mask: r w x (1 1 1)
---------------------
result: r - x (1 0 1)
</code></pre></div></p> <p>对照下面的规则，验证用户<code>tm2</code>对<code>~/project1</code>目录的实际权限。 <div class=highlight><pre><span></span><code>su - tm2
</code></pre></div> 能进入目录<code>project1</code>，说明当前用户具有目录<code>project1</code>的<code>r-x</code>权限。 <div class=highlight><pre><span></span><code>$ whoami
tm2

$ cd /home/pm1/project1/
</code></pre></div> 能列出目录<code>project1</code>下文件列表，可以查看文件<code>file</code>的内容，说明当前用户具有目录<code>project1</code>的<code>r-x</code>权限。 <div class=highlight><pre><span></span><code>$ pwd
/home/pm1/project1

$ whoami
tm2

$ ls -l
-rw-r--r--. 1 pm1 project1 15 Dec  4 07:15 file1

$ cat file1
hello from pm1
</code></pre></div> 对目录<code>project1</code>不具有<code>w</code>权限，所以无法创建、删除或修改目录下的任何文件或子目录。 <div class=highlight><pre><span></span><code>$ pwd
/home/pm1/project1

$ whoami
tm2

$ touch file2
touch: cannot touch &#39;file2&#39;: Permission denied

$ echo &quot;hello from $USER&quot; &gt;&gt; file1
-bash: file1: Permission denied
</code></pre></div></p> <h4 id=mask>修改mask权限<a class=headerlink href=#mask title="Permanent link"> ¶</a></h4> <p>调整<code>~/project1</code>目录的<code>mask</code>为<code>r--</code>，则<code>tm2</code>的实际权限是<code>r--</code> <div class=highlight><pre><span></span><code>$ su - pm1
$ cd ~
$ setfacl -m m::r ./project1/

$ getfacl ./project1/
# file: project1/
# owner: pm1
# group: project1
user::rwx
user:tm2:r-x          #effective:r--  (用户tm2的实际有效权限变为r--)
group::rwx            #effective:r--  (属组project1组的实际有效权限变为r--)
group:project2:rwx    #effective:r--  (其他组project2组的实际有效权限变为r--)
mask::r--                             (mask变化，导致上述两个group的有效权限都发生了变化)
other::---
</code></pre></div></p> <p>有效权限的计算：</p> <p>当前<code>~/project1</code>目录的<code>mask</code>是<code>r--</code>，用户<code>tm2</code>、组<code>project2</code>的实际权限是<code>r--</code>。 <div class=highlight><pre><span></span><code>   tm2: r - w (1 0 1)
  mask: r - - (1 0 0)
---------------------
result: r - - (1 0 0)
</code></pre></div></p> <div class="admonition attention"> <p class=admonition-title>Attention</p> <p>用户和用户组所设定的权限必须在mask权限设定的范围之内才能生效，mask权限就是最大有效权限。</p> </div> <h4 id=_16>有效权限分析<a class=headerlink href=#_16 title="Permanent link"> ¶</a></h4> <p>在POSIX权限模型和ACL权限叠加作用下，用户的实际权限分析。</p> <div class=highlight><pre><span></span><code>$ getfacl ./project1/
# file: project1/
# owner: pm1                            &lt;----Owner
# group: project1                       &lt;----owning group
user::rwx                               &lt;----owner&#39;s permissions
user:tm2:r-x          #effective:r--    &lt;----named user&#39;s permissions
group::rwx            #effective:r--    &lt;----owning group&#39;s permissions
group:project2:rwx    #effective:r--    &lt;----named group&#39;s permissions
mask::r--                               &lt;----masks for named user and named group
other::---
default:user::rwx
default:user:tm2:r-x
default:group::rwx
default:mask::rwx
default:other::---
</code></pre></div> <p>所有者ower和其他用户other条目中定义的权限总是有效的。上例中的user条目和other条目。 除了掩码条目，所有其他条目（比如指定用户named user）可以是有效的或被屏蔽的。</p> <p>指定用户（named user），所有者组（owning group）或指定组（named group）以及掩码mask条目中定义的权限，有效权限是他们权限进行逻辑AND后的结果，而不是单独的掩码中定义的权限或者各自条目中定义的权。</p> <p>有效权限计算方法如下，注意，<code>ls</code>命令中显示出来的权限，与实际的ACL权限是有差别的。 <div class=highlight><pre><span></span><code>        tm2: r - w (1 0 1)
      group: r w x (1 1 1)
named group: r w x (1 1 1)
       mask: r - - (1 0 0)
---------------------------
     result: r - - (1 0 0)
</code></pre></div></p> <div class="admonition reference"> <p class=admonition-title>Reference</p> <p>与文件模式权限位等效的ACL称为最小ACL，即POSIX传统权限。</p> <p>含掩码mask等其他权限条目的ACL称为扩展ACL。</p> <p>在最小和扩展ACL情形下，所有者类权限（owner）都是映射到ACL的所有者条目。 其他类权限映射到其各自的ACL条目。 </p> <p>在扩展ACL情形下，组类权限的映射是不同的。</p> <p>对于没有掩码的最小ACL，组类权限将映射到ACL所有者组条目。</p> <p>对于带有掩码的扩展ACL，组类权限将映射到掩码条目。</p> <p>通过权限位进行分配的权限代表了通过ACL进行分配的权限的上限。 没有在这里体现的任何权限，要么不在ACL中，要么无效。</p> <p>对权限位所做的更改将由ACL反映，反之亦然。</p> </div> <h4 id=acl_8>默认ACL权限<a class=headerlink href=#acl_8 title="Permanent link"> ¶</a></h4> <div class=highlight><pre><span></span><code>$ su - pm1

$ touch ./project1/file2
$ mkdir ./project1/cloud

$ ll ./project1/
drwxr-xr-x. 1 pm1 project1  0 Dec  4 08:52 cloud
-rw-r--r--. 1 pm1 project1 15 Dec  4 07:15 file1
-rw-r--r--. 1 pm1 project1  0 Dec  4 08:52 file2

$ ll -d project1/
drwxr-----+ 1 pm1 project1 30 Dec  4 08:52 project1/
</code></pre></div> <p>文件<code>file1</code>和目录<code>cloud</code>没有继承<code>project1</code>目录的ACL权限。</p> <div class="admonition attetion"> <p class=admonition-title>Attetion</p> <p>默认 ACL限只对目录生效。</p> <p>默认ACL权限的作用是：如果给父目录设定了默认 ACL 权限，那么父目录中所有新建的子文件都会继承父目录的ACL权限。</p> </div> <p>下面增加<code>~/project1</code>目录的默认ACL权限。 <div class=highlight><pre><span></span><code>$ su - pm1
$ cd ~

$ getfacl ./project1/
# file: project1/
# owner: pm1
# group: project1
user::rwx
user:tm2:r-x          #effective:r--
group::rwx            #effective:r--
group:project2:rwx    #effective:r--
mask::r--
other::---

$ setfacl -m d:u:tm2:rx ./project1/

$ getfacl ./project1/
# file: project1/
# owner: pm1
# group: project1
user::rwx
user:tm2:r-x         #effective:r--
group::rwx           #effective:r--
group:project2:rwx   #effective:r--
mask::r--
other::---
default:user::rwx
default:user:tm2:r-x
default:group::rwx
default:mask::rwx
default:other::---
</code></pre></div></p> <p>创建新子目录<code>leonardo</code>，就继承了<code>~/project1</code>目录的default ACL权限设定。</p> <p>注意，默认ACL权限是针对新建立的文件生效的，目录cloud和文件file1并没有因为增加了父目录的默认ACL设定而继承默认ACL权限设定. <div class=highlight><pre><span></span><code>$ su - pm1
$ cd ~
$ mkdir ./project1/leonardo

$ ll ./project1/
drwxr-xr-x. 1 pm1 project1  0 Dec  4 08:52 cloud
-rw-r--r--. 1 pm1 project1 15 Dec  4 07:15 file1
-rw-r--r--. 1 pm1 project1  0 Dec  4 08:52 file2
drwxrwx---+ 1 pm1 project1  0 Dec  4 09:07 leonardo
</code></pre></div></p> <h4 id=acl_9>递归ACL权限<a class=headerlink href=#acl_9 title="Permanent link"> ¶</a></h4> <p>递归 ACL 权限，是指父目录在设定ACL权限时，所有的子目录也会拥有相同的ACL权限。 <div class=highlight><pre><span></span><code>$ su - pm1
$ cd ~

$ getfacl ./project1/
# file: project1/
# owner: pm1
# group: project1
user::rwx
user:tm2:r-x          #effective:r--
group::rwx            #effective:r--
group:project2:rwx    #effective:r--
mask::r--
other::---
default:user::rwx
default:user:tm2:r-x
default:group::rwx
default:mask::rwx
default:other::---

$ setfacl -m d:u:tm2:rx -R ./project1/

$ ll ./project1
drwxr-xr-x+ 1 pm1 project1  0 Dec  4 08:52 cloud
-rw-r--r--. 1 pm1 project1 15 Dec  4 07:15 file1
-rw-r--r--. 1 pm1 project1  0 Dec  4 08:52 file2
drwxrwx---+ 1 pm1 project1  0 Dec  4 09:07 leonardo
</code></pre></div></p> <h4 id=acl_10>删除ACL权限<a class=headerlink href=#acl_10 title="Permanent link"> ¶</a></h4> <p>删除用户<code>tm2</code>的ACL权限。 <div class=highlight><pre><span></span><code>$ su - pm1
$ cd ~

$ setfacl -x u:tm2 ./project1/

$ getfacl ./project1/
# file: project1/
# owner: pm1
# group: project1
user::rwx
group::rwx
group:project2:rwx
mask::rwx
other::---
default:user::rwx
default:user:tm2:r-x
default:group::rwx
default:mask::rwx
default:other::---
</code></pre></div></p> <p>删除所有的ACL权限。 <div class=highlight><pre><span></span><code>$ setfacl -b ./project1

$ getfacl ./project1
# file: project1/
# owner: pm1
# group: project1
user::rwx
group::rwx
other::---

$ ll ./project1
drwxr-xr-x+ 1 pm1 project1  0 Dec  4 08:52 cloud
-rw-r--r--. 1 pm1 project1 15 Dec  4 07:15 file1
-rw-r--r--. 1 pm1 project1  0 Dec  4 08:52 file2
drwxrwx---+ 1 pm1 project1  0 Dec  4 09:07 leonardo
</code></pre></div> 递归删除全部ACL权限。 <div class=highlight><pre><span></span><code>$ setfacl -b -R ./project1

$ ll ./project1/
total 4
drwxr-xr-x. 1 pm1 project1  0 Dec  4 08:52 cloud
-rw-r--r--. 1 pm1 project1 15 Dec  4 07:15 file1
-rw-r--r--. 1 pm1 project1  0 Dec  4 08:52 file2
drwxrwx---. 1 pm1 project1  0 Dec  4 09:07 leonardo
</code></pre></div></p> <h3 id=acl_11>ACL目录实例解析<a class=headerlink href=#acl_11 title="Permanent link"> ¶</a></h3> <h4 id=acl_12>目录ACL<a class=headerlink href=#acl_12 title="Permanent link"> ¶</a></h4> <p>切换到pm1用户，在其主目录中，基于不同的掩码创建2个子目录。 <div class=highlight><pre><span></span><code>$ su - pm1

$ umask 0022
$ mkdir mydir1

$ umask 0027
$ mkdir mydir2

$ ll -d mydir*
drwxr-xr-x. 1 pm1 project1 0 Dec  4 12:30 mydir1
drwxr-x---. 1 pm1 project1 0 Dec  4 12:31 mydir2
</code></pre></div></p> <p>这2个目录当前的ACL状态如下： <div class=highlight><pre><span></span><code>$ getfacl mydir1
# file: mydir1
# owner: pm1
# group: project1
user::rwx
group::r-x
other::r-x

$ getfacl mydir2
# file: mydir2
# owner: pm1
# group: project1
user::rwx
group::r-x
other::---
</code></pre></div></p> <p>修改目录<code>mydir2</code>的ACL。 <div class=highlight><pre><span></span><code>$ setfacl -m u:tm2:rwx,g:project2:rwx mydir2

$ getfacl mydir2
getfacl mydir2
# file: mydir2
# owner: pm1
# group: project1
user::rwx
user:tm2:rwx
group::r-x
group:project2:rwx
mask::rwx
other::---

$ ll -d mydir2
drwxrwx---+ 1 pm1 project1 0 Dec  4 12:31 mydir2
</code></pre></div></p> <p>现在，用户<code>tm2</code>和组<code>project2</code>对目录<code>mydir2</code>都具有rwx权限，传统POSIX权限和ACL权限一致。</p> <p>现在对mydir2目录组权限撤销w权限。 用户<code>tm2</code>和组<code>project2</code>对目录<code>mydir2</code>的有效权限变成了<code>r-x</code>。 mask也受组权限变化影响，变成了<code>r-x</code>。 <div class=highlight><pre><span></span><code>$ chmod g-w mydir2

$ ll -d mydir2
drwxr-x---+ 1 pm1 project1 0 Dec  4 12:31 mydir2

$ getfacl mydir2
# file: mydir2
# owner: pm1
# group: project1
user::rwx
user:tm2:rwx          #effective:r-x
group::r-x
group:project2:rwx    #effective:r-x
mask::r-x
other::---
</code></pre></div></p> <p>通过<code>chmod</code>和<code>setfacl</code>两种不同的方法对目录<code>mydir2</code>的组权限进行修改，在ls命令中体现是一样的，对组的实际有效权限的影响也是一样的。</p> <p><code>chmod</code>修改的是<code>mask</code>，<code>mask</code>只影响除所有者和other的之外的人和组的最大权限，<code>mask</code>需要与用户的权限进行逻辑与运算后，才能变成有效权限，用户或组的设置必须在mask权限设定范围内才会生效。</p> <p><code>setfacl</code>可以不修改mask的情况下只修改<code>owning group</code>的权限，下面的例子说明了这一情况。POSIX组权限仍然是<code>rwx</code>，但ACL中所有者组的权限变成了<code>r--</code>。 <div class=highlight><pre><span></span><code>$ setfacl -m g::r mydir2

$ ll -d mydir2
drwxrwx---+ 1 pm1 project1 0 Dec  4 12:31 mydir2

$ getfacl mydir2
# file: mydir2
# owner: pm1
# group: project1
user::rwx
user:tm2:rwx
group::r--
group:project2:rwx
mask::rwx
other::---
</code></pre></div></p> <h4 id=acl_13>目录的默认ACL<a class=headerlink href=#acl_13 title="Permanent link"> ¶</a></h4> <p>目录可以具有默认ACL，这是一种特殊的ACL，用于定义目录下的对象在创建时继承的访问权限。默认ACL会影响子目录和文件。</p> <p>目录的默认ACL的权限有两种不同的方式传递给其中的文件和子目录：</p> <ul> <li>子目录继承父目录的默认ACL，既作为自己的默认ACL，又作为自己的访问ACL。</li> <li>文件继承目录默认ACL作为其自己的访问ACL。</li> </ul> <p>创建文件系统对象的所有系统函数都使用mode参数，该参数定义了新创建的文件系统对象的访问权限。</p> <ul> <li>如果父目录没有默认ACL，则根据umask的设置设置权限位。</li> <li>如果父目录存在默认ACL，则分配给新对象的权限位则是mode参数权限与默认ACL中定义的权限的逻辑与的结果。在这种情况下，忽略umask命令。</li> <li>默认ACL不会立即影响访问权限。它们仅在创建文件系统对象时才起作用。这些新对象仅从其父目录的默认ACL继承权限。<ul> <li>命令<code>mkdir</code>在创建目录时会继承默认ACL。</li> </ul> </li> </ul> <div class=highlight><pre><span></span><code>$ su - pm1

$ getfacl mydir2
# file: mydir2
# owner: pm1
# group: project1
user::rwx
user:tm2:rwx
group::r--
group:project2:rwx
mask::rwx
other::---

$ mkdir ./mydir2/sub1

$ ll ./mydir2
drwxr-x---. 1 pm1 project1 0 Dec  4 13:23 sub1

$ setfacl -d -m g:project2:-w- mydir2

$ mkdir ./mydir2/sub2

$ ll ./mydir2
drwxr-x---. 1 pm1 project1 0 Dec  4 13:23 sub1
drwxrw----+ 1 pm1 project1 0 Dec  4 13:27 sub2

$ getfacl ./mydir2/sub2
# file: mydir2/sub2
# owner: pm1
# group: project1
user::rwx
group::r--
group:project2:-w-
mask::rw-
other::---
default:user::rwx
default:group::r--
default:group:project2:-w-
default:mask::rw-
default:other::---
</code></pre></div> <p>在对<code>mydir2</code>目录添加默认ACL前，创建子目录<code>sub1</code>，添加后创建子目录<code>sub2</code>。可以观察到<code>sub2</code>到继承了<code>mydir2</code>的默认ACL。 <div class=highlight><pre><span></span><code>$ su - tm2

$ cd /home/pm1/mydir2/sub2
-bash: cd: /home/pm1/mydir2/sub2: Permission denied
</code></pre></div> 上例中，默认ACL中指定组<code>project2</code>只具有w权限，所以无法执行<code>cd</code>命令进入该目录。 这说明模式值mode中给予的权限<code>r</code>被屏蔽了，只保留了ACL中最小的权限<code>w</code>。</p> <h3 id=acl_14>ACL检查逻辑<a class=headerlink href=#acl_14 title="Permanent link"> ¶</a></h3> <p>ACL检查顺序：</p> <ul> <li>Owner</li> <li>Named user</li> <li>Owning group</li> <li>Named group</li> <li> <p>Other</p> <p>If 进程的用户标识是Owner，则owner的ACL条目决定访问权限 else if 进程的用户标识是named user，则name user的ACL条目的权限决定申请的访问权限 else if 进程的组属于owning group，且owning group的ACL条目包含所请求的访问权限，则授予所请求的权限 else if 进程的组属于named group，且named group的ACL条目包含所请求的访问权限，则授予所请求的权限 else if 进程的组属于owning group或者named group，但owning group或者named group的ACL条目不包含所请求的访问权限，则拒绝所请求的权限 else ACL中的other条目处理申请的权限 If 如果进程匹配到owner或者other条目中包含所申请的权限，则授予权限 else if 如果进程匹配到named user，owning group，或者named group条目中包含所申请的权限，且maks条目也包含所申请的权限，则授予权限 else 拒绝权限申请</p> </li> </ul> <p>实际应用举例：</p> <ul> <li>udev使用ACL给予登录到图形界面的用户访问设备的权限，例如DVD驱动器</li> <li>某些应用程序不支持ACL</li> <li>Star Archiver是一个完全保留ACL的备份应用程序，其他人可能会也可能不会保留它 </li> <li>许多编辑器和文件管理器不允许在应用程序中查看或设置ACL</li> </ul> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../02-filesystem/ class="md-footer__link md-footer__link--prev" aria-label="Previous: File System" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> File System </div> </div> </a> <a href=../04-TextTools/ class="md-footer__link md-footer__link--next" aria-label="Next: Text Tools" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Text Tools </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.instant", "navigation.top"], "search": "../../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../../assets/javascripts/bundle.2ab50757.min.js></script> </body> </html>