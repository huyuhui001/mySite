<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://huyuhui001.github.io/mySite/k8s/installation/multiple-local/ rel=canonical><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.3.0, mkdocs-material-7.3.6"><title>Multiple Nodes Installation - MEMO</title><link rel=stylesheet href=../../../assets/stylesheets/main.a57b2b03.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.3f5d1f46.min.css><meta name=theme-color content=#009485><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style><link rel=stylesheet href=../../../extra.css></head> <body dir=ltr data-md-color-scheme data-md-color-primary=teal data-md-color-accent=green> <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#multiple-nodes-installation class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title=MEMO class="md-header__button md-logo" aria-label=MEMO data-md-component=logo> <img src=../../../assets/logo.jpg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> MEMO </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Multiple Nodes Installation </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/huyuhui001/mySite title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> huyuhui001/mySite </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../linux/Administration/linux_admin/ class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../single-local/ class="md-tabs__link md-tabs__link--active"> Kubernetes </a> </li> <li class=md-tabs__item> <a href=../../../python/Foundation/python_foundation_index/ class=md-tabs__link> Python </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title=MEMO class="md-nav__button md-logo" aria-label=MEMO data-md-component=logo> <img src=../../../assets/logo.jpg alt=logo> </a> MEMO </label> <div class=md-nav__source> <a href=https://github.com/huyuhui001/mySite title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> huyuhui001/mySite </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1> Linux <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Linux data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../linux/Administration/linux_admin/ class=md-nav__link> SUSE Linux Administration </a> </li> <li class=md-nav__item> <a href=../../../linux/SES/linux_ses/ class=md-nav__link> SUSE Enterprise Storage Foundation </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Kubernetes data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_1 type=checkbox id=__nav_2_1 checked> <label class=md-nav__link for=__nav_2_1> Installation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Installation data-md-level=2> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> Installation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../single-local/ class=md-nav__link> Single Node Installation </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Multiple Nodes Installation <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Multiple Nodes Installation </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#local-vm-setting class=md-nav__link> Local VM setting </a> </li> <li class=md-nav__item> <a href=#ubuntu-post-installation class=md-nav__link> Ubuntu Post Installation </a> </li> <li class=md-nav__item> <a href=#install-containerd class=md-nav__link> Install Containerd </a> </li> <li class=md-nav__item> <a href=#install-nerdctl class=md-nav__link> Install nerdctl </a> </li> <li class=md-nav__item> <a href=#install-kubernetes class=md-nav__link> Install Kubernetes </a> </li> <li class=md-nav__item> <a href=#setup-master-node class=md-nav__link> Setup Master Node </a> </li> <li class=md-nav__item> <a href=#install-flannel class=md-nav__link> Install Flannel </a> </li> <li class=md-nav__item> <a href=#setup-work-nodes class=md-nav__link> Setup Work Nodes </a> </li> <li class=md-nav__item> <a href=#check-cluster-status class=md-nav__link> Check Cluster Status </a> </li> <li class=md-nav__item> <a href=#reset-cluster class=md-nav__link> Reset cluster </a> </li> <li class=md-nav__item> <a href=#install-helm class=md-nav__link> Install Helm </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../aliyun-opensuse/ class=md-nav__link> Installation on Aliyun openSUSE </a> </li> <li class=md-nav__item> <a href=../aliyun-ubuntu/ class=md-nav__link> Installation on Aliyun Ubuntu </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2 type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2> Foundamentals <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Foundamentals data-md-level=2> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Foundamentals </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../foundamentals/memo/ class=md-nav__link> Memo </a> </li> <li class=md-nav__item> <a href=../../foundamentals/docker/ class=md-nav__link> Docker Fundamentals </a> </li> <li class=md-nav__item> <a href=../../foundamentals/overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../foundamentals/basics/ class=md-nav__link> kubectl basics </a> </li> <li class=md-nav__item> <a href=../../foundamentals/namespace/ class=md-nav__link> Namespace </a> </li> <li class=md-nav__item> <a href=../../foundamentals/pod/ class=md-nav__link> Work on pod </a> </li> <li class=md-nav__item> <a href=../../foundamentals/deployment/ class=md-nav__link> Deployment </a> </li> <li class=md-nav__item> <a href=../../foundamentals/statefulset/ class=md-nav__link> StatefulSet </a> </li> <li class=md-nav__item> <a href=../../foundamentals/daemonset/ class=md-nav__link> DaemonSet </a> </li> <li class=md-nav__item> <a href=../../foundamentals/job/ class=md-nav__link> Job and Cronjob </a> </li> <li class=md-nav__item> <a href=../../foundamentals/hpa/ class=md-nav__link> Horizontal Pod Autoscaling </a> </li> <li class=md-nav__item> <a href=../../foundamentals/service/ class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../../foundamentals/ingress/ class=md-nav__link> Ingress </a> </li> <li class=md-nav__item> <a href=../../foundamentals/persistence/ class=md-nav__link> Persistence </a> </li> <li class=md-nav__item> <a href=../../foundamentals/scheduling/ class=md-nav__link> Scheduling </a> </li> <li class=md-nav__item> <a href=../../foundamentals/policy/ class=md-nav__link> Policy </a> </li> <li class=md-nav__item> <a href=../../foundamentals/configuration/ class=md-nav__link> Configuration </a> </li> <li class=md-nav__item> <a href=../../foundamentals/rbac/ class=md-nav__link> Role Based Access Control (RBAC) </a> </li> <li class=md-nav__item> <a href=../../foundamentals/networkpolicy/ class=md-nav__link> Network Policy </a> </li> <li class=md-nav__item> <a href=../../foundamentals/clustermgt/ class=md-nav__link> Cluster Management </a> </li> <li class=md-nav__item> <a href=../../foundamentals/helming/ class=md-nav__link> Helming </a> </li> <li class=md-nav__item> <a href=../../foundamentals/troubleshooting/ class=md-nav__link> Troubleshooting </a> </li> <li class=md-nav__item> <a href=../../foundamentals/healthcheck/ class=md-nav__link> Health Check </a> </li> <li class=md-nav__item> <a href=../../foundamentals/casestudy/ class=md-nav__link> Case Study </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> Python <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Python data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../python/Foundation/python_foundation_index/ class=md-nav__link> Python Foundamentals </a> </li> <li class=md-nav__item> <a href=../../../python/DataAnalysis/python_data_analysis_index/ class=md-nav__link> Data Analysis </a> </li> <li class=md-nav__item> <a href=../../../python/Demo/python_demo_index/ class=md-nav__link> Demos </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#local-vm-setting class=md-nav__link> Local VM setting </a> </li> <li class=md-nav__item> <a href=#ubuntu-post-installation class=md-nav__link> Ubuntu Post Installation </a> </li> <li class=md-nav__item> <a href=#install-containerd class=md-nav__link> Install Containerd </a> </li> <li class=md-nav__item> <a href=#install-nerdctl class=md-nav__link> Install nerdctl </a> </li> <li class=md-nav__item> <a href=#install-kubernetes class=md-nav__link> Install Kubernetes </a> </li> <li class=md-nav__item> <a href=#setup-master-node class=md-nav__link> Setup Master Node </a> </li> <li class=md-nav__item> <a href=#install-flannel class=md-nav__link> Install Flannel </a> </li> <li class=md-nav__item> <a href=#setup-work-nodes class=md-nav__link> Setup Work Nodes </a> </li> <li class=md-nav__item> <a href=#check-cluster-status class=md-nav__link> Check Cluster Status </a> </li> <li class=md-nav__item> <a href=#reset-cluster class=md-nav__link> Reset cluster </a> </li> <li class=md-nav__item> <a href=#install-helm class=md-nav__link> Install Helm </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/huyuhui001/mySite/edit/main/docs/k8s/installation/multiple-local.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1 id=multiple-nodes-installation>Multiple Nodes Installation<a class=headerlink href=#multiple-nodes-installation title="Permanent link"> ¶</a></h1> <h2 id=local-vm-setting>Local VM setting<a class=headerlink href=#local-vm-setting title="Permanent link"> ¶</a></h2> <p>VMWare Setting.</p> <ul> <li>VMnet1: host-only, subnet: 192.168.150.0/24</li> <li>VMnet8: NAT, subnet: 11.0.1.0/24</li> </ul> <p>Create guest machine with VMWare Player.</p> <ul> <li>4 GB RAM</li> <li>2 CPUs with 2 Cores</li> <li>Ubuntu Server 22.04</li> <li>NAT</li> </ul> <p>Kubernetes running on Containerd.</p> <h2 id=ubuntu-post-installation>Ubuntu Post Installation<a class=headerlink href=#ubuntu-post-installation title="Permanent link"> ¶</a></h2> <p>Create user <code>james</code> on all guests. <div class=highlight><pre><span></span><code>sudo adduser james
sudo usermod -aG adm,sudo,syslog,cdrom,dip,plugdev,lxd james
sudo passwd james
</code></pre></div></p> <p>Set password for <code>root</code> on all guests. <div class=highlight><pre><span></span><code>sudo passwd root
</code></pre></div></p> <p>Update all guests' hostname, <code>ubu01</code>,<code>ubu02</code>,<code>ubu03</code>,<code>ubu04</code>. <div class=highlight><pre><span></span><code>sudo hostnamectl set-hostname ubu01
sudo hostnamectl set-hostname ubu01 --pretty
</code></pre></div> Verify if the hostname is set to expected name, e.g., <code>ubu01</code>. <div class=highlight><pre><span></span><code>cat /etc/machine-info
</code></pre></div> Verify if the hostname is set to expected name, e.g., <code>ubu01</code>. <div class=highlight><pre><span></span><code>cat /etc/hostname
</code></pre></div> Verify if the hostname of <code>127.0.1.1</code> is set to expected name, e.g., <code>ubu01</code>. And add all nodes into the file <code>/etc/hosts</code>. <div class=highlight><pre><span></span><code>cat /etc/hosts
</code></pre></div> <div class=highlight><pre><span></span><code>127.0.0.1 localhost
127.0.1.1 ubu01

11.0.1.131 ubu01
11.0.1.132 ubu02
11.0.1.133 ubu03
11.0.1.134 ubu04

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
</code></pre></div></p> <p>Set all guests with fixed IP, e.g, <code>11.0.1.131</code>. <div class=highlight><pre><span></span><code>sudo vi 00-installer-config.yaml
</code></pre></div> <div class=highlight><pre><span></span><code>network:
  ethernets:
    ens33:
      dhcp4: false
      addresses:
      - 11.0.1.131/24
      nameservers:
        addresses:
        - 11.0.1.2
      routes:
      - to: default
        via: 11.0.1.2
  version: 2
</code></pre></div> <div class=highlight><pre><span></span><code>sudo netplan apply
</code></pre></div></p> <p>Disable swap and firewall on all nodes. <div class=highlight><pre><span></span><code>sudo swapoff -a
sudo ufw disable
sudo ufw status verbose
</code></pre></div> And comment the last line of swap setting in file <code>/etc/fstab</code>. Need <em>reboot</em> guest here. <div class=highlight><pre><span></span><code>/dev/disk/by-uuid/df370d2a-83e5-4895-8c7f-633f2545e3fe / ext4 defaults 0 1
# /swap.img     none    swap    sw      0       0
</code></pre></div></p> <p>Setup timezone on all nodes <div class=highlight><pre><span></span><code>sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
sudo echo &#39;LANG=&quot;en_US.UTF-8&quot;&#39; &gt;&gt; /etc/profile
source /etc/profile
</code></pre></div> Something like this after execute command <code>ll /etc/localtime</code> <div class=highlight><pre><span></span><code>lrwxrwxrwx 1 root root 33 Jul 15 22:00 /etc/localtime -&gt; /usr/share/zoneinfo/Asia/Shanghai
</code></pre></div></p> <p>Kernel setting on all nodes. <div class=highlight><pre><span></span><code>cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf
overlay
br_netfilter
EOF
</code></pre></div> <div class=highlight><pre><span></span><code>sudo modprobe overlay
sudo modprobe br_netfilter
</code></pre></div> <div class=highlight><pre><span></span><code>cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF
</code></pre></div> <div class=highlight><pre><span></span><code>sudo sysctl --system
</code></pre></div></p> <h2 id=install-containerd>Install Containerd<a class=headerlink href=#install-containerd title="Permanent link"> ¶</a></h2> <p>Install Containerd sevice on all nodes.</p> <p>Backup source file. <div class=highlight><pre><span></span><code>sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
</code></pre></div></p> <p>Install Containered. <div class=highlight><pre><span></span><code>sudo apt-get update &amp;&amp; sudo apt-get install -y containerd
</code></pre></div></p> <p>Configure Containerd. Modify file <code>/etc/containerd/config.toml</code>. <div class=highlight><pre><span></span><code>sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml
vi /etc/containerd/config.toml
</code></pre></div> Update <code>sandbox_image</code> with new value <code>"registry.aliyuncs.com/google_containers/pause:3.6"</code>. Update <code>SystemdCgroup</code> with new value <code>true</code>. <div class=highlight><pre><span></span><code>[plugins]
  [plugins.&quot;io.containerd.gc.v1.scheduler&quot;]

  [plugins.&quot;io.containerd.grpc.v1.cri&quot;]
    sandbox_image = &quot;registry.aliyuncs.com/google_containers/pause:3.6&quot;

    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.cni]
    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd]
      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.default_runtime]
        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.default_runtime.options]
      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes]
        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]

          [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]
            SystemdCgroup = true
</code></pre></div></p> <p>Restart Containerd service. <div class=highlight><pre><span></span><code>sudo systemctl restart containerd
sudo systemctl status containerd
</code></pre></div></p> <h2 id=install-nerdctl>Install nerdctl<a class=headerlink href=#install-nerdctl title="Permanent link"> ¶</a></h2> <p>Install nerdctl sevice on all nodes.</p> <p>The goal of <a href=https://github.com/containerd/nerdctl><code>nerdctl</code></a> is to facilitate experimenting the cutting-edge features of containerd that are not present in Docker.</p> <div class=highlight><pre><span></span><code>wget https://github.com/containerd/nerdctl/releases/download/v0.21.0/nerdctl-0.21.0-linux-amd64.tar.gz

tar -zxvf nerdctl-0.21.0-linux-amd64.tar.gz

cp nerdctl /usr/bin/
</code></pre></div> <p>Verify nerdctl. <div class=highlight><pre><span></span><code># nerdctl --help
</code></pre></div></p> <p>To list local Kubernetes containers. <div class=highlight><pre><span></span><code># nerdctl -n k8s.io ps
</code></pre></div></p> <h2 id=install-kubernetes>Install Kubernetes<a class=headerlink href=#install-kubernetes title="Permanent link"> ¶</a></h2> <p>Install Kubernetes on all nodes.</p> <p>Install dependencied packages. <div class=highlight><pre><span></span><code>sudo apt-get update &amp;&amp; sudo apt-get install -y apt-transport-https ca-certificates curl
</code></pre></div></p> <p>Install gpg certificate. <div class=highlight><pre><span></span><code># For Ubuntu 20.04 release
curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -

# For Ubuntu 22.04 release
sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg
</code></pre></div> Add Kubernetes repo. <div class=highlight><pre><span></span><code># For Ubuntu 20.04 release
cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list
deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
EOF

# For Ubuntu 22.04 release
echo &quot;deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main&quot; | sudo tee /etc/apt/sources.list.d/kubernetes.list
</code></pre></div></p> <p>Update and install dependencied packages. <div class=highlight><pre><span></span><code>sudo apt-get update
sudo apt-get install ebtables
sudo apt-get install libxtables12
sudo apt-get upgrade iptables
</code></pre></div></p> <p>Check available versions of kubeadm. <div class=highlight><pre><span></span><code>apt policy kubeadm
</code></pre></div></p> <p>Install <code>1.23.8-00</code> version. <div class=highlight><pre><span></span><code>sudo apt-get -y install kubelet=1.23.8-00 kubeadm=1.23.8-00 kubectl=1.23.8-00 --allow-downgrades
</code></pre></div></p> <p>Set <code>kubectl</code> <a href=https://github.com/scop/bash-completion>auto-completion</a> following the <a href=https://kubernetes.io/docs/tasks/tools/included/optional-kubectl-configs-bash-linux/ >guideline</a>. <div class=highlight><pre><span></span><code>sudo apt install -y bash-completion
source /usr/share/bash-completion/bash_completion
source &lt;(kubectl completion bash)
echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc
</code></pre></div></p> <p>If we set an alias for kubectl, we can extend shell completion to work with that alias: <div class=highlight><pre><span></span><code>echo &#39;alias k=kubectl&#39; &gt;&gt;~/.bashrc
echo &#39;complete -o default -F __start_kubectl k&#39; &gt;&gt;~/.bashrc
</code></pre></div></p> <h2 id=setup-master-node>Setup Master Node<a class=headerlink href=#setup-master-node title="Permanent link"> ¶</a></h2> <p>Check kubeadm default parameters for initialization. <div class=highlight><pre><span></span><code>sudo kubeadm config print init-defaults
</code></pre></div></p> <p>Dry run <div class=highlight><pre><span></span><code>sudo kubeadm init --dry-run --pod-network-cidr=10.244.0.0/16 --image-repository=registry.aliyuncs.com/google_containers --kubernetes-version=v1.23.8
</code></pre></div></p> <p>Initialize master node. Save the output, which will be used later on work nodes. <div class=highlight><pre><span></span><code>sudo kubeadm init --pod-network-cidr=10.244.0.0/16 --image-repository=registry.aliyuncs.com/google_containers --kubernetes-version=v1.23.8
</code></pre></div></p> <p>Set <code>kubeconfig</code> file for current user. <div class=highlight><pre><span></span><code>mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre></div></p> <h2 id=install-flannel>Install Flannel<a class=headerlink href=#install-flannel title="Permanent link"> ¶</a></h2> <p>If NetworkPolicy is the case, then install Calico. Refer to the "Install Calico or Flannel" of below section "Installation on Aliyun Ubuntu".</p> <p><a href=https://github.com/flannel-io/flannel>Flannel</a> is a simple and easy way to configure a layer 3 network fabric designed for Kubernetes.</p> <p>Deploy Flannel on master node. In the kube-flannel.yml we can get the default network setting of Flannel, which is same with <code>--pod-network-cidr=10.244.0.0/16</code> we defined before when we initiated <code>kubeadm</code>. <div class=highlight><pre><span></span><code>  net-conf.json: |
    {
      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,
      &quot;Backend&quot;: {
        &quot;Type&quot;: &quot;vxlan&quot;
      }
    }
</code></pre></div></p> <p><div class=highlight><pre><span></span><code>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre></div> Output: <div class=highlight><pre><span></span><code>Warning: policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+
podsecuritypolicy.policy/psp.flannel.unprivileged created
clusterrole.rbac.authorization.k8s.io/flannel created
clusterrolebinding.rbac.authorization.k8s.io/flannel created
serviceaccount/flannel created
configmap/kube-flannel-cfg created
daemonset.apps/kube-flannel-ds created
</code></pre></div></p> <h2 id=setup-work-nodes>Setup Work Nodes<a class=headerlink href=#setup-work-nodes title="Permanent link"> ¶</a></h2> <p>Command usage: <div class=highlight><pre><span></span><code>kubeadm join &lt;your master node eth0 ip&gt;:6443 --token &lt;token generated by kubeadm init&gt; --discovery-token-ca-cert-hash &lt;hash key generated by kubeadm init&gt;
</code></pre></div> Use <code>kubeadm token</code> to generate the join token and hash value. <div class=highlight><pre><span></span><code>kubeadm token create --print-join-command
</code></pre></div></p> <h2 id=check-cluster-status>Check Cluster Status<a class=headerlink href=#check-cluster-status title="Permanent link"> ¶</a></h2> <div class=highlight><pre><span></span><code>kubectl cluster-info
kubectl get nodes -owide
kubectl get pod -A
</code></pre></div> <h2 id=reset-cluster>Reset cluster<a class=headerlink href=#reset-cluster title="Permanent link"> ¶</a></h2> <p>CAUTION: below steps will destroy current cluster. </p> <p>Delete all nodes in the cluster. <div class=highlight><pre><span></span><code>kubeadm reset
</code></pre></div></p> <p>Clean up rule of <code>iptables</code>. <div class=highlight><pre><span></span><code>iptables -F &amp;&amp; iptables -t nat -F &amp;&amp; iptables -t mangle -F &amp;&amp; iptables -X
</code></pre></div></p> <p>Clean up rule of <code>IPVS</code> if using <code>IPVS</code>. <div class=highlight><pre><span></span><code>ipvsadm --clear
</code></pre></div></p> <h2 id=install-helm>Install Helm<a class=headerlink href=#install-helm title="Permanent link"> ¶</a></h2> <p>Helm is the Kubernetes package manager. It doesn't come with Kubernetes. </p> <p>Three concepts of helm:</p> <ul> <li>A <em>Chart</em> is a Helm package. <ul> <li>It contains all of the resource definitions necessary to run an application, tool, or service inside of a Kubernetes cluster. </li> <li>Think of it like the Kubernetes equivalent of a Homebrew formula, an Apt dpkg, or a Yum RPM file.</li> </ul> </li> <li>A <em>Repository</em> is the place where charts can be collected and shared. <ul> <li>It's like Perl's CPAN archive or the Fedora Package Database, but for Kubernetes packages.</li> </ul> </li> <li>A <em>Release</em> is an instance of a chart running in a Kubernetes cluster. <ul> <li>One chart can often be installed many times into the same cluster. And each time it is installed, a new release is created. </li> <li>Consider a MySQL chart. If you want two databases running in your cluster, you can install that chart twice. Each one will have its own release, which will in turn have its own release name.</li> </ul> </li> </ul> <p>Reference:</p> <ul> <li><a href=https://helm.sh/docs/intro/install/ >installation guide</a></li> <li><a href=https://github.com/helm/helm/releases>binary release</a></li> <li><a href=https://github.com/helm/helm>source code</a>.</li> </ul> <p>Helm Client Installation: <div class=highlight><pre><span></span><code>curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
</code></pre></div> <div class=highlight><pre><span></span><code>chmod 700 get_helm.sh
</code></pre></div> <div class=highlight><pre><span></span><code>./get_helm.sh
</code></pre></div> Output: <div class=highlight><pre><span></span><code>Downloading https://get.helm.sh/helm-v3.9.1-linux-amd64.tar.gz
Verifying checksum... Done.
Preparing to install helm into /usr/local/bin
helm installed into /usr/local/bin/helm
</code></pre></div></p> <p>Note: <a href=https://helm.sh/docs/helm/helm_init/ ><code>helm init</code></a> does not exist in Helm 3, following the removal of Tiller. You no longer need to install Tiller in your cluster in order to use Helm.</p> <p><code>helm search</code> can be used to search two different types of source:</p> <ul> <li><code>helm search hub</code> searches the <a href=https://artifacthub.io/ >Artifact Hub</a>, which lists helm charts from dozens of different repositories.</li> <li><code>helm search repo</code> searches the repositories that you have added to your local helm client (with helm repo add). This search is done over local data, and no public network connection is needed.</li> </ul> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top data-md-state=hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../single-local/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Single Node Installation" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Single Node Installation </div> </div> </a> <a href=../aliyun-opensuse/ class="md-footer__link md-footer__link--next" aria-label="Next: Installation on Aliyun openSUSE" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Installation on Aliyun openSUSE </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.instant", "navigation.top"], "search": "../../../assets/javascripts/workers/search.fcfe8b6d.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.b1047164.min.js></script> </body> </html>