<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://huyuhui001.github.io/mySite/k8s/cka_en/foundamentals/casestudy-calico/ rel=canonical><link rel=icon href=../../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.3.1, mkdocs-material-8.4.3"><title>Calico Installation - UPSkilling</title><link rel=stylesheet href=../../../../assets/stylesheets/main.6b80c2a2.min.css><link rel=stylesheet href=../../../../assets/stylesheets/palette.cbb835fc.min.css><meta name=theme-color content=#009485><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../../extra.css><script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme data-md-color-primary=teal data-md-color-accent=green> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#case-study-install-calico class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../.. title=UPSkilling class="md-header__button md-logo" aria-label=UPSkilling data-md-component=logo> <img src=../../../../assets/logo.jpg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> UPSkilling </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Calico Installation </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/huyuhui001/mySite title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> huyuhui001/mySite </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../.. class=md-tabs__link> UPSkilling </a> </li> <li class=md-tabs__item> <a href=../../../../linux/ class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../../ class="md-tabs__link md-tabs__link--active"> Kubernetes </a> </li> <li class=md-tabs__item> <a href=../../../../python/ class=md-tabs__link> Python </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../.. title=UPSkilling class="md-nav__button md-logo" aria-label=UPSkilling data-md-component=logo> <img src=../../../../assets/logo.jpg alt=logo> </a> UPSkilling </label> <div class=md-nav__source> <a href=https://github.com/huyuhui001/mySite title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> huyuhui001/mySite </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1> UPSkilling <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=UPSkilling data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> UPSkilling </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../.. class=md-nav__link> Welcome </a> </li> <li class=md-nav__item> <a href=../../../../about/ class=md-nav__link> About </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Linux <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Linux data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../linux/ class=md-nav__link> Index </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2 type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2> Linux SRE <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Linux SRE" data-md-level=2> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Linux SRE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../linux/SRE/01-fundamentals/ class=md-nav__link> 第一章 Linux基础 </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/02-filesystem/ class=md-nav__link> 第二章 文件系统 </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/03-identity-security/ class=md-nav__link> 第三章 身份与安全 </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/04-TextTools/ class=md-nav__link> 第四章 文本编辑 </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/05-RegExpress/ class=md-nav__link> 第五章 正则表达式 </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/06-FileLookup/ class=md-nav__link> 第六章 文件查找 </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/07-FilePacking/ class=md-nav__link> 第七章 文件打包和解包 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_3 type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3> SUSE Linux Administration <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="SUSE Linux Administration" data-md-level=2> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> SUSE Linux Administration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../linux/Administration/01/ class=md-nav__link> Linux File System Overview </a> </li> <li class=md-nav__item> <a href=../../../../linux/Administration/02/ class=md-nav__link> Useful Commands </a> </li> <li class=md-nav__item> <a href=../../../../linux/Administration/03/ class=md-nav__link> Shell </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_4 type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4> SUSE Enterprise Storage Foundation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="SUSE Enterprise Storage Foundation" data-md-level=2> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> SUSE Enterprise Storage Foundation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../linux/SES/linux_ses_memo/ class=md-nav__link> SUSE Enterprise Storage Foundation </a> </li> <li class=md-nav__item> <a href=../../../../linux/SES/linux_ses_demo/ class=md-nav__link> SUSE Enterprise Storage Basic Operation </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Kubernetes data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../ class=md-nav__link> Index </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2 type=checkbox id=__nav_3_2 checked> <label class=md-nav__link for=__nav_3_2> CKA Learning Memo <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="CKA Learning Memo" data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> CKA Learning Memo </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_1 type=checkbox id=__nav_3_2_1> <label class=md-nav__link for=__nav_3_2_1> Installation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Installation data-md-level=3> <label class=md-nav__title for=__nav_3_2_1> <span class="md-nav__icon md-icon"></span> Installation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../installation/single-local/ class=md-nav__link> Single Node Installation </a> </li> <li class=md-nav__item> <a href=../../installation/multiple-local/ class=md-nav__link> Multiple Nodes Installation </a> </li> <li class=md-nav__item> <a href=../../installation/aliyun-ubuntu/ class=md-nav__link> Installation on Aliyun ECS </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_2 type=checkbox id=__nav_3_2_2> <label class=md-nav__link for=__nav_3_2_2> Docker <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Docker data-md-level=3> <label class=md-nav__title for=__nav_3_2_2> <span class="md-nav__icon md-icon"></span> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../docker/ class=md-nav__link> Fundamentals </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_3 type=checkbox id=__nav_3_2_3> <label class=md-nav__link for=__nav_3_2_3> Foundamentals <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Foundamentals data-md-level=3> <label class=md-nav__title for=__nav_3_2_3> <span class="md-nav__icon md-icon"></span> Foundamentals </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../memo/ class=md-nav__link> Memo </a> </li> <li class=md-nav__item> <a href=../overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../basics/ class=md-nav__link> kubectl basics </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_4 type=checkbox id=__nav_3_2_4> <label class=md-nav__link for=__nav_3_2_4> Core Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Core Kubernetes" data-md-level=3> <label class=md-nav__title for=__nav_3_2_4> <span class="md-nav__icon md-icon"></span> Core Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../pod/ class=md-nav__link> Pod </a> </li> <li class=md-nav__item> <a href=../deployment/ class=md-nav__link> Deployment </a> </li> <li class=md-nav__item> <a href=../service/ class=md-nav__link> Service </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_5 type=checkbox id=__nav_3_2_5> <label class=md-nav__link for=__nav_3_2_5> Application Modeling <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Application Modeling" data-md-level=3> <label class=md-nav__title for=__nav_3_2_5> <span class="md-nav__icon md-icon"></span> Application Modeling </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../namespace/ class=md-nav__link> Namespace </a> </li> <li class=md-nav__item> <a href=../statefulset/ class=md-nav__link> StatefulSet </a> </li> <li class=md-nav__item> <a href=../daemonset/ class=md-nav__link> DaemonSet </a> </li> <li class=md-nav__item> <a href=../job/ class=md-nav__link> Job and Cronjob </a> </li> <li class=md-nav__item> <a href=../configuration/ class=md-nav__link> Configuration </a> </li> <li class=md-nav__item> <a href=../secrets/ class=md-nav__link> Secrets </a> </li> <li class=md-nav__item> <a href=../persistence/ class=md-nav__link> Persistence </a> </li> <li class=md-nav__item> <a href=../rbac/ class=md-nav__link> Role Based Access Control (RBAC) </a> </li> <li class=md-nav__item> <a href=../ingress/ class=md-nav__link> Ingress </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_6 type=checkbox id=__nav_3_2_6> <label class=md-nav__link for=__nav_3_2_6> Advanced Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Advanced Kubernetes" data-md-level=3> <label class=md-nav__title for=__nav_3_2_6> <span class="md-nav__icon md-icon"></span> Advanced Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../scheduling/ class=md-nav__link> Scheduling </a> </li> <li class=md-nav__item> <a href=../hpa/ class=md-nav__link> Horizontal Pod Autoscaling </a> </li> <li class=md-nav__item> <a href=../policy/ class=md-nav__link> Policy </a> </li> <li class=md-nav__item> <a href=../networkpolicy/ class=md-nav__link> Network Policy </a> </li> <li class=md-nav__item> <a href=../clustermgt/ class=md-nav__link> Cluster Management </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_7 type=checkbox id=__nav_3_2_7> <label class=md-nav__link for=__nav_3_2_7> Operating Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Operating Kubernetes" data-md-level=3> <label class=md-nav__title for=__nav_3_2_7> <span class="md-nav__icon md-icon"></span> Operating Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../troubleshooting/ class=md-nav__link> Troubleshooting </a> </li> <li class=md-nav__item> <a href=../healthcheck/ class=md-nav__link> Health Check </a> </li> <li class=md-nav__item> <a href=../helming/ class=md-nav__link> Helming </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_8 type=checkbox id=__nav_3_2_8 checked> <label class=md-nav__link for=__nav_3_2_8> Topics <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Topics data-md-level=3> <label class=md-nav__title for=__nav_3_2_8> <span class="md-nav__icon md-icon"></span> Topics </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../casestudy-operation-resources/ class=md-nav__link> Operations on Resources </a> </li> <li class=md-nav__item> <a href=../casestudy-health-check/ class=md-nav__link> Health Check </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Calico Installation <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Calico Installation </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#the-calico-datastore class=md-nav__link> The Calico Datastore </a> </li> <li class=md-nav__item> <a href=#configure-ip-pools class=md-nav__link> Configure IP Pools </a> </li> <li class=md-nav__item> <a href=#install-cni-plugin class=md-nav__link> Install CNI plugin </a> </li> <li class=md-nav__item> <a href=#install-typha class=md-nav__link> Install Typha </a> </li> <li class=md-nav__item> <a href=#install-caliconode class=md-nav__link> Install calico/node </a> </li> <li class=md-nav__item> <a href=#test-networking class=md-nav__link> Test networking </a> <nav class=md-nav aria-label="Test networking"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pod-to-pod-pings class=md-nav__link> Pod to pod pings </a> </li> <li class=md-nav__item> <a href=#check-routes class=md-nav__link> Check routes </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../kyma/ class=md-nav__link> Kyma </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3 type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3> CKA学习笔记 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=CKA学习笔记 data-md-level=2> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> CKA学习笔记 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_1 type=checkbox id=__nav_3_3_1> <label class=md-nav__link for=__nav_3_3_1> 安装 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=安装 data-md-level=3> <label class=md-nav__title for=__nav_3_3_1> <span class="md-nav__icon md-icon"></span> 安装 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_cn/installation/single-local/ class=md-nav__link> 单节点虚拟机安装Kubernetes </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/installation/multiple-local/ class=md-nav__link> 多节点虚拟机安装Kubernetes </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/installation/aliyun-ubuntu/ class=md-nav__link> 阿里云ECS安装Kubernetes </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_2 type=checkbox id=__nav_3_3_2> <label class=md-nav__link for=__nav_3_3_2> Docker <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Docker data-md-level=3> <label class=md-nav__title for=__nav_3_3_2> <span class="md-nav__icon md-icon"></span> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/docker/ class=md-nav__link> Docker基础 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_3 type=checkbox id=__nav_3_3_3> <label class=md-nav__link for=__nav_3_3_3> 基础知识 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=基础知识 data-md-level=3> <label class=md-nav__title for=__nav_3_3_3> <span class="md-nav__icon md-icon"></span> 基础知识 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/memo/ class=md-nav__link> Kubernetes随笔 </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/overview/ class=md-nav__link> Kubernetes集群概览 </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/basics/ class=md-nav__link> kubectl基础 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_4 type=checkbox id=__nav_3_3_4> <label class=md-nav__link for=__nav_3_3_4> 核心概念 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=核心概念 data-md-level=3> <label class=md-nav__title for=__nav_3_3_4> <span class="md-nav__icon md-icon"></span> 核心概念 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/pod/ class=md-nav__link> Pod </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/deployment/ class=md-nav__link> Deployment </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/service/ class=md-nav__link> Service </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_5 type=checkbox id=__nav_3_3_5> <label class=md-nav__link for=__nav_3_3_5> 应用体系 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=应用体系 data-md-level=3> <label class=md-nav__title for=__nav_3_3_5> <span class="md-nav__icon md-icon"></span> 应用体系 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/namespace/ class=md-nav__link> Namespace </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/statefulset/ class=md-nav__link> StatefulSet </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/daemonset/ class=md-nav__link> DaemonSet </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/job/ class=md-nav__link> Job and Cronjob </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/configuration/ class=md-nav__link> Configuration </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/secrets/ class=md-nav__link> secrets </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/persistence/ class=md-nav__link> Persistence </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/rbac/ class=md-nav__link> RBAC鉴权 </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/ingress/ class=md-nav__link> Ingress-nginx </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_6 type=checkbox id=__nav_3_3_6> <label class=md-nav__link for=__nav_3_3_6> 进阶概念 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=进阶概念 data-md-level=3> <label class=md-nav__title for=__nav_3_3_6> <span class="md-nav__icon md-icon"></span> 进阶概念 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/scheduling/ class=md-nav__link> Scheduling </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/hpa/ class=md-nav__link> Horizontal Pod Autoscaling (HPA) </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/policy/ class=md-nav__link> Policy </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/networkpolicy/ class=md-nav__link> Network Policy </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/clustermgt/ class=md-nav__link> Cluster Management </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_7 type=checkbox id=__nav_3_3_7> <label class=md-nav__link for=__nav_3_3_7> 日常维护 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=日常维护 data-md-level=3> <label class=md-nav__title for=__nav_3_3_7> <span class="md-nav__icon md-icon"></span> 日常维护 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/troubleshooting/ class=md-nav__link> Troubleshooting </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/healthcheck/ class=md-nav__link> 健康检查 </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/helming/ class=md-nav__link> Helm Chart </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_8 type=checkbox id=__nav_3_3_8> <label class=md-nav__link for=__nav_3_3_8> 主题讨论 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=主题讨论 data-md-level=3> <label class=md-nav__title for=__nav_3_3_8> <span class="md-nav__icon md-icon"></span> 主题讨论 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/casestudy-operation-resources/ class=md-nav__link> Kubernetes资源常见操作 </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/casestudy-health-check/ class=md-nav__link> 健康检查 </a> </li> <li class=md-nav__item> <a href=../../../cka_cn/foundamentals/casestudy-calico/ class=md-nav__link> 安装Calico </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_4 type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4> Demos <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Demos data-md-level=2> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Demos </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../demo/cap_on_kyma/ class=md-nav__link> Build CAP Application on Kyma </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Python <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Python data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../python/ class=md-nav__link> Index </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2 type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2> Python基础 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Python基础 data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Python基础 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../python/Foundation/ch00/ class=md-nav__link> Python安装 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/ch01/ class=md-nav__link> Python语言基础 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/ch02/ class=md-nav__link> Python打包和解包 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/ch03/ class=md-nav__link> Python内置函数及文件 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/ch04/ class=md-nav__link> Python面向对象概念 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/ch05/ class=md-nav__link> Python面向对象三大特性 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/Algorithms/ class=md-nav__link> Python数据结构和算法 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3 type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3> Python数据分析基础 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Python数据分析基础 data-md-level=2> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Python数据分析基础 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch01/ class=md-nav__link> NumPy基础 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch10/ class=md-nav__link> NumPy进阶 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch02/ class=md-nav__link> Pandas入门 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch03/ class=md-nav__link> 数据载入、存储及文件格式 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch04/ class=md-nav__link> 数据清洗与准备 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch05/ class=md-nav__link> 数据规整：连接、联合与重塑 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch06/ class=md-nav__link> 绘图与可视化 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch07/ class=md-nav__link> 数据聚合与分组操作 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch08/ class=md-nav__link> 时间序列 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch09/ class=md-nav__link> 高阶pandas </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch11/ class=md-nav__link> Python建模库介绍 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4 type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4> 数据结构和算法 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=数据结构和算法 data-md-level=2> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> 数据结构和算法 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../python/DataStructure/01_PythonFundmantal/ class=md-nav__link> 基础知识回顾 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataStructure/02_CollectionsOverview/ class=md-nav__link> 多项集的概述 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataStructure/03_TimeComplexity/ class=md-nav__link> 搜索、排序以及复杂度分析 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_5 type=checkbox id=__nav_4_5> <label class=md-nav__link for=__nav_4_5> Demos <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Demos data-md-level=2> <label class=md-nav__title for=__nav_4_5> <span class="md-nav__icon md-icon"></span> Demos </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../python/Demo/CourseSystem/ class=md-nav__link> 选课系统 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#the-calico-datastore class=md-nav__link> The Calico Datastore </a> </li> <li class=md-nav__item> <a href=#configure-ip-pools class=md-nav__link> Configure IP Pools </a> </li> <li class=md-nav__item> <a href=#install-cni-plugin class=md-nav__link> Install CNI plugin </a> </li> <li class=md-nav__item> <a href=#install-typha class=md-nav__link> Install Typha </a> </li> <li class=md-nav__item> <a href=#install-caliconode class=md-nav__link> Install calico/node </a> </li> <li class=md-nav__item> <a href=#test-networking class=md-nav__link> Test networking </a> <nav class=md-nav aria-label="Test networking"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pod-to-pod-pings class=md-nav__link> Pod to pod pings </a> </li> <li class=md-nav__item> <a href=#check-routes class=md-nav__link> Check routes </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/huyuhui001/mySite/edit/main/docs/k8s/cka_en/foundamentals/casestudy-calico.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1 id=case-study-install-calico>Case Study: Install Calico<a class=headerlink href=#case-study-install-calico title="Permanent link"> ¶</a></h1> <p>Scenario: Install Calico</p> <ul> <li>Calico Datastore</li> <li>Configure IP Pools</li> <li>Install CNI plugin</li> <li>Install Typha</li> <li>Install calico/node</li> <li>Test networking</li> </ul> <h2 id=the-calico-datastore>The Calico Datastore<a class=headerlink href=#the-calico-datastore title="Permanent link"> ¶</a></h2> <p>In order to use Kubernetes as the Calico datastore, we need to define the custom resources Calico uses.</p> <p>Download and examine the list of Calico custom resource definitions, and open it in a file editor.</p> <div class=highlight><pre><span></span><code><span class=go>wget https://projectcalico.docs.tigera.io/manifests/crds.yaml</span>
</code></pre></div> <p>Create the custom resource definitions in Kubernetes.</p> <div class=highlight><pre><span></span><code><span class=go>kubectl apply -f crds.yaml</span>
</code></pre></div> <p>Install <code>calicoctl</code>. To interact directly with the Calico datastore, use the <code>calicoctl</code> client tool.</p> <p>Download the calicoctl binary to a Linux host with access to Kubernetes. The latest release of calicoctl can be found in the <a href=https://github.com/projectcalico/calico/releases>git page</a> and replace below <code>v3.23.2</code> by actual release number.</p> <div class=highlight><pre><span></span><code><span class=go>wget https://github.com/projectcalico/calico/releases/download/v3.23.3/calicoctl-linux-amd64</span>
<span class=go>chmod +x calicoctl-linux-amd64</span>
<span class=go>sudo cp calicoctl-linux-amd64 /usr/local/bin/calicoctl</span>
</code></pre></div> <p>Configure calicoctl to access Kubernetes</p> <div class=highlight><pre><span></span><code><span class=go>echo &quot;export KUBECONFIG=/root/.kube/config&quot; &gt;&gt; ~/.bashrc</span>
<span class=go>echo &quot;export DATASTORE_TYPE=kubernetes&quot; &gt;&gt; ~/.bashrc</span>

<span class=go>echo $KUBECONFIG</span>
<span class=go>echo $DATASTORE_TYPE</span>
</code></pre></div> <p>Verify <code>calicoctl</code> can reach the datastore by running：</p> <div class=highlight><pre><span></span><code><span class=go>calicoctl get nodes -o wide</span>
</code></pre></div> <p>Output similar to below:</p> <div class=highlight><pre><span></span><code><span class=go>NAME     ASN   IPV4   IPV6   </span>
<span class=go>cka001                       </span>
<span class=go>cka002                       </span>
<span class=go>cka003  </span>
</code></pre></div> <p>Nodes are backed by the Kubernetes node object, so we should see names that match <code>kubectl get nodes</code>.</p> <div class=highlight><pre><span></span><code><span class=go>kubectl get nodes -o wide</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>NAME     STATUS     ROLES                  AGE   VERSION   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME</span>
<span class=go>cka001   NotReady   control-plane,master   23m   v1.24.0   Ubuntu 20.04.4 LTS   5.4.0-113-generic   containerd://1.5.9</span>
<span class=go>cka002   NotReady   &lt;none&gt;                 22m   v1.24.0   Ubuntu 20.04.4 LTS   5.4.0-113-generic   containerd://1.5.9</span>
<span class=go>cka003   NotReady   &lt;none&gt;                 21m   v1.24.0   Ubuntu 20.04.4 LTS   5.4.0-113-generic   containerd://1.5.9</span>
</code></pre></div> <h2 id=configure-ip-pools>Configure IP Pools<a class=headerlink href=#configure-ip-pools title="Permanent link"> ¶</a></h2> <p>A workload is a container or VM that Calico handles the virtual networking for. In Kubernetes, workloads are pods. A workload endpoint is the virtual network interface a workload uses to connect to the Calico network.</p> <p>IP pools are ranges of IP addresses that Calico uses for workload endpoints.</p> <p>Get current IP pools in the cluster. So far, it's empty after fresh installation.</p> <div class=highlight><pre><span></span><code><span class=go>calicoctl get ippools</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>NAME   CIDR   SELECTOR </span>
</code></pre></div> <p>The Pod CIDR is <code>10.244.0.0/16</code> we specified via <code>kubeadm init</code>.</p> <p>Let's create two IP pools for use in the cluster. Each pool can not have any overlaps.</p> <ul> <li>ipv4-ippool-1: <code>10.244.0.0/18</code></li> <li>ipv4-ippool-2: <code>10.244.192.0/19</code></li> </ul> <div class=highlight><pre><span></span><code><span class=go>calicoctl apply -f - &lt;&lt;EOF</span>
<span class=go>apiVersion: projectcalico.org/v3</span>
<span class=go>kind: IPPool</span>
<span class=go>metadata:</span>
<span class=go>  name: ipv4-ippool-1</span>
<span class=go>spec:</span>
<span class=go>  cidr: 10.244.0.0/18</span>
<span class=go>  ipipMode: Never</span>
<span class=go>  natOutgoing: true</span>
<span class=go>  disabled: false</span>
<span class=go>  nodeSelector: all()</span>
<span class=go>EOF</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>calicoctl apply -f - &lt;&lt;EOF</span>
<span class=go>apiVersion: projectcalico.org/v3</span>
<span class=go>kind: IPPool</span>
<span class=go>metadata:</span>
<span class=go>  name: ipv4-ippool-2</span>
<span class=go>spec:</span>
<span class=go>  cidr: 10.244.192.0/19</span>
<span class=go>  ipipMode: Never</span>
<span class=go>  natOutgoing: true</span>
<span class=go>  disabled: true</span>
<span class=go>  nodeSelector: all()</span>
<span class=go>EOF</span>
</code></pre></div> <p>IP pool now looks like below.</p> <div class=highlight><pre><span></span><code><span class=go>calicoctl get ippools -o wide</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>NAME            CIDR              NAT    IPIPMODE   VXLANMODE   DISABLED   DISABLEBGPEXPORT   SELECTOR   </span>
<span class=go>ipv4-ippool-1   10.244.0.0/18     true   Never      Never       false      false              all()      </span>
<span class=go>ipv4-ippool-2   10.244.192.0/19   true   Never      Never       true       false              all()     </span>
</code></pre></div> <h2 id=install-cni-plugin>Install CNI plugin<a class=headerlink href=#install-cni-plugin title="Permanent link"> ¶</a></h2> <ul> <li>Provision Kubernetes user account for the plugin.</li> </ul> <p>Kubernetes uses the Container Network Interface (CNI) to interact with networking providers like Calico. The Calico binary that presents this API to Kubernetes is called the CNI plugin and must be installed on every node in the Kubernetes cluster.</p> <p>The CNI plugin interacts with the Kubernetes API server while creating pods, both to obtain additional information and to update the datastore with information about the pod.</p> <p>On the Kubernetes <em>master</em> node, create a key for the CNI plugin to authenticate with and certificate signing request.</p> <p>Change to directory <code>/etc/kubernetes/pki/</code>.</p> <div class=highlight><pre><span></span><code><span class=nb>cd</span> /etc/kubernetes/pki/
</code></pre></div> <div class=highlight><pre><span></span><code>openssl req -newkey rsa:4096 <span class=se>\</span>
  -keyout cni.key <span class=se>\</span>
  -nodes <span class=se>\</span>
  -out cni.csr <span class=se>\</span>
  -subj <span class=s2>&quot;/CN=calico-cni&quot;</span>
</code></pre></div> <p>We will sign this certificate using the main Kubernetes CA.</p> <div class=highlight><pre><span></span><code><span class=go>sudo openssl x509 -req -in cni.csr \</span>
<span class=go>  -CA /etc/kubernetes/pki/ca.crt \</span>
<span class=go>  -CAkey /etc/kubernetes/pki/ca.key \</span>
<span class=go>  -CAcreateserial \</span>
<span class=go>  -out cni.crt \</span>
<span class=go>  -days 3650</span>
</code></pre></div> <p>Output looks like below. User is <code>calico-cni</code>.</p> <div class=highlight><pre><span></span><code><span class=go>Signature ok</span>
<span class=go>subject=CN = calico-cni</span>
<span class=go>Getting CA Private Key</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>sudo chown $(id -u):$(id -g) cni.crt</span>
</code></pre></div> <p>Next, we create a kubeconfig file for the CNI plugin to use to access Kubernetes. Copy this <code>cni.kubeconfig</code> file to every node in the cluster.</p> <p>Stay in directory <code>/etc/kubernetes/pki/</code>.</p> <div class=highlight><pre><span></span><code><span class=go>APISERVER=$(kubectl config view -o jsonpath=&#39;{.clusters[0].cluster.server}&#39;)</span>

<span class=go>echo $APISERVER</span>

<span class=go>kubectl config set-cluster kubernetes \</span>
<span class=go>  --certificate-authority=/etc/kubernetes/pki/ca.crt \</span>
<span class=go>  --embed-certs=true \</span>
<span class=go>  --server=$APISERVER \</span>
<span class=go>  --kubeconfig=cni.kubeconfig</span>

<span class=go>kubectl config set-credentials calico-cni \</span>
<span class=go>  --client-certificate=cni.crt \</span>
<span class=go>  --client-key=cni.key \</span>
<span class=go>  --embed-certs=true \</span>
<span class=go>  --kubeconfig=cni.kubeconfig</span>

<span class=go>kubectl config set-context cni@kubernetes \</span>
<span class=go>  --cluster=kubernetes \</span>
<span class=go>  --user=calico-cni \</span>
<span class=go>  --kubeconfig=cni.kubeconfig</span>

<span class=go>kubectl config use-context cni@kubernetes --kubeconfig=cni.kubeconfig</span>
</code></pre></div> <p>The context for CNI looks like below.</p> <div class=highlight><pre><span></span><code><span class=go>kubectl config get-contexts --kubeconfig=cni.kubeconfig</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>CURRENT   NAME             CLUSTER      AUTHINFO     NAMESPACE</span>
<span class=go>*         cni@kubernetes   kubernetes   calico-cni </span>
</code></pre></div> <ul> <li>Provision RBAC</li> </ul> <p>Change to home directory</p> <div class=highlight><pre><span></span><code><span class=nb>cd</span> ~
</code></pre></div> <p>Define a cluster role the CNI plugin will use to access Kubernetes.</p> <div class=highlight><pre><span></span><code>kubectl apply -f - <span class=s>&lt;&lt;EOF</span>
<span class=s>kind: ClusterRole</span>
<span class=s>apiVersion: rbac.authorization.k8s.io/v1</span>
<span class=s>metadata:</span>
<span class=s>  name: calico-cni</span>
<span class=s>rules:</span>
<span class=s>  # The CNI plugin needs to get pods, nodes, and namespaces.</span>
<span class=s>  - apiGroups: [&quot;&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - pods</span>
<span class=s>      - nodes</span>
<span class=s>      - namespaces</span>
<span class=s>    verbs:</span>
<span class=s>      - get</span>
<span class=s>  # The CNI plugin patches pods/status.</span>
<span class=s>  - apiGroups: [&quot;&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - pods/status</span>
<span class=s>    verbs:</span>
<span class=s>      - patch</span>
<span class=s> # These permissions are required for Calico CNI to perform IPAM allocations.</span>
<span class=s>  - apiGroups: [&quot;crd.projectcalico.org&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - blockaffinities</span>
<span class=s>      - ipamblocks</span>
<span class=s>      - ipamhandles</span>
<span class=s>    verbs:</span>
<span class=s>      - get</span>
<span class=s>      - list</span>
<span class=s>      - create</span>
<span class=s>      - update</span>
<span class=s>      - delete</span>
<span class=s>  - apiGroups: [&quot;crd.projectcalico.org&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - ipamconfigs</span>
<span class=s>      - clusterinformations</span>
<span class=s>      - ippools</span>
<span class=s>    verbs:</span>
<span class=s>      - get</span>
<span class=s>      - list</span>
<span class=s>EOF</span>
</code></pre></div> <p>Bind the cluster role to the <code>calico-cni</code> account.</p> <div class=highlight><pre><span></span><code><span class=go>kubectl create clusterrolebinding calico-cni --clusterrole=calico-cni --user=calico-cni</span>
</code></pre></div> <ul> <li>Install the plugin</li> </ul> <p>Do these steps on <strong>each node</strong> in your cluster.</p> <p>Installation on <code>cka001</code>.</p> <p>Run these commands as <strong>root</strong>.</p> <div class=highlight><pre><span></span><code><span class=go>sudo su</span>
</code></pre></div> <p>Install the CNI plugin Binaries. Get right release in the link <code>https://github.com/projectcalico/cni-plugin/releases</code>, and link <code>https://github.com/containernetworking/plugins/releases</code>.</p> <div class=highlight><pre><span></span><code><span class=go>mkdir -p /opt/cni/bin</span>

<span class=go>curl -L -o /opt/cni/bin/calico https://github.com/projectcalico/cni-plugin/releases/download/v3.20.5/calico-amd64</span>
<span class=go>chmod 755 /opt/cni/bin/calico</span>

<span class=go>curl -L -o /opt/cni/bin/calico-ipam https://github.com/projectcalico/cni-plugin/releases/download/v3.20.5/calico-ipam-amd64</span>
<span class=go>chmod 755 /opt/cni/bin/calico-ipam</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>wget https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz</span>
<span class=go>tar xvf cni-plugins-linux-amd64-v1.1.1.tgz -C /opt/cni/bin</span>
</code></pre></div> <p>Create the config directory</p> <div class=highlight><pre><span></span><code><span class=go>mkdir -p /etc/cni/net.d/</span>
</code></pre></div> <p>Copy the kubeconfig from the previous section</p> <div class=highlight><pre><span></span><code><span class=go>cp /etc/kubernetes/pki/cni.kubeconfig /etc/cni/net.d/calico-kubeconfig</span>

<span class=go>chmod 600 /etc/cni/net.d/calico-kubeconfig</span>
</code></pre></div> <p>Write the CNI configuration</p> <div class=highlight><pre><span></span><code>cat &gt; /etc/cni/net.d/10-calico.conflist <span class=s>&lt;&lt;EOF</span>
<span class=s>{</span>
<span class=s>  &quot;name&quot;: &quot;k8s-pod-network&quot;,</span>
<span class=s>  &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span>
<span class=s>  &quot;plugins&quot;: [</span>
<span class=s>    {</span>
<span class=s>      &quot;type&quot;: &quot;calico&quot;,</span>
<span class=s>      &quot;log_level&quot;: &quot;info&quot;,</span>
<span class=s>      &quot;datastore_type&quot;: &quot;kubernetes&quot;,</span>
<span class=s>      &quot;mtu&quot;: 1500,</span>
<span class=s>      &quot;ipam&quot;: {</span>
<span class=s>          &quot;type&quot;: &quot;calico-ipam&quot;</span>
<span class=s>      },</span>
<span class=s>      &quot;policy&quot;: {</span>
<span class=s>          &quot;type&quot;: &quot;k8s&quot;</span>
<span class=s>      },</span>
<span class=s>      &quot;kubernetes&quot;: {</span>
<span class=s>          &quot;kubeconfig&quot;: &quot;/etc/cni/net.d/calico-kubeconfig&quot;</span>
<span class=s>      }</span>
<span class=s>    },</span>
<span class=s>    {</span>
<span class=s>      &quot;type&quot;: &quot;portmap&quot;,</span>
<span class=s>      &quot;snat&quot;: true,</span>
<span class=s>      &quot;capabilities&quot;: {&quot;portMappings&quot;: true}</span>
<span class=s>    }</span>
<span class=s>  ]</span>
<span class=s>}</span>
<span class=s>EOF</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>cp /etc/cni/net.d/calico-kubeconfig ~</span>
</code></pre></div> <p>Exit from su and go back to the logged in user.</p> <div class=highlight><pre><span></span><code><span class=go>exit</span>
</code></pre></div> <p>Installation on <code>cka002</code>.</p> <div class=highlight><pre><span></span><code><span class=go>sftp -i cka-key-pair.pem cka002</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>put calico-amd64</span>
<span class=go>put calicoctl-linux-amd64</span>
<span class=go>put calico-ipam-amd64</span>
<span class=go>put calico-kubeconfig</span>
<span class=go>put cni-plugins-linux-amd64-v1.1.1.tgz</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>ssh -i cka-key-pair.pem cka002</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>mkdir -p /opt/cni/bin</span>

<span class=go>cp calico-amd64 /opt/cni/bin/calico</span>
<span class=go>cp calico-ipam-amd64 /opt/cni/bin/calico-ipam</span>

<span class=go>tar xvf cni-plugins-linux-amd64-v1.1.1.tgz -C /opt/cni/bin</span>

<span class=go>mkdir -p /etc/cni/net.d/</span>

<span class=go>cp calico-kubeconfig /etc/cni/net.d/calico-kubeconfig</span>

<span class=go>chmod 600 /etc/cni/net.d/calico-kubeconfig</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>cat &gt; /etc/cni/net.d/10-calico.conflist &lt;&lt;EOF</span>
<span class=go>{</span>
<span class=go>  &quot;name&quot;: &quot;k8s-pod-network&quot;,</span>
<span class=go>  &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span>
<span class=go>  &quot;plugins&quot;: [</span>
<span class=go>    {</span>
<span class=go>      &quot;type&quot;: &quot;calico&quot;,</span>
<span class=go>      &quot;log_level&quot;: &quot;info&quot;,</span>
<span class=go>      &quot;datastore_type&quot;: &quot;kubernetes&quot;,</span>
<span class=go>      &quot;mtu&quot;: 1500,</span>
<span class=go>      &quot;ipam&quot;: {</span>
<span class=go>          &quot;type&quot;: &quot;calico-ipam&quot;</span>
<span class=go>      },</span>
<span class=go>      &quot;policy&quot;: {</span>
<span class=go>          &quot;type&quot;: &quot;k8s&quot;</span>
<span class=go>      },</span>
<span class=go>      &quot;kubernetes&quot;: {</span>
<span class=go>          &quot;kubeconfig&quot;: &quot;/etc/cni/net.d/calico-kubeconfig&quot;</span>
<span class=go>      }</span>
<span class=go>    },</span>
<span class=go>    {</span>
<span class=go>      &quot;type&quot;: &quot;portmap&quot;,</span>
<span class=go>      &quot;snat&quot;: true,</span>
<span class=go>      &quot;capabilities&quot;: {&quot;portMappings&quot;: true}</span>
<span class=go>    }</span>
<span class=go>  ]</span>
<span class=go>}</span>
<span class=go>EOF</span>
</code></pre></div> <p>Back to <code>cka001</code>.</p> <div class=highlight><pre><span></span><code><span class=go>exit</span>
</code></pre></div> <p>Installation on <code>cka003</code>.</p> <div class=highlight><pre><span></span><code><span class=go>sftp -i cka-key-pair.pem cka003</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>put calico-amd64</span>
<span class=go>put calicoctl-linux-amd64</span>
<span class=go>put calico-ipam-amd64</span>
<span class=go>put calico-kubeconfig</span>
<span class=go>put cni-plugins-linux-amd64-v1.1.1.tgz</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>ssh -i cka-key-pair.pem cka003</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>mkdir -p /opt/cni/bin</span>

<span class=go>cp calico-amd64 /opt/cni/bin/calico</span>
<span class=go>cp calico-ipam-amd64 /opt/cni/bin/calico-ipam</span>

<span class=go>tar xvf cni-plugins-linux-amd64-v1.1.1.tgz -C /opt/cni/bin</span>

<span class=go>mkdir -p /etc/cni/net.d/</span>

<span class=go>cp calico-kubeconfig /etc/cni/net.d/calico-kubeconfig</span>

<span class=go>chmod 600 /etc/cni/net.d/calico-kubeconfig</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>cat &gt; /etc/cni/net.d/10-calico.conflist &lt;&lt;EOF</span>
<span class=go>{</span>
<span class=go>  &quot;name&quot;: &quot;k8s-pod-network&quot;,</span>
<span class=go>  &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span>
<span class=go>  &quot;plugins&quot;: [</span>
<span class=go>    {</span>
<span class=go>      &quot;type&quot;: &quot;calico&quot;,</span>
<span class=go>      &quot;log_level&quot;: &quot;info&quot;,</span>
<span class=go>      &quot;datastore_type&quot;: &quot;kubernetes&quot;,</span>
<span class=go>      &quot;mtu&quot;: 1500,</span>
<span class=go>      &quot;ipam&quot;: {</span>
<span class=go>          &quot;type&quot;: &quot;calico-ipam&quot;</span>
<span class=go>      },</span>
<span class=go>      &quot;policy&quot;: {</span>
<span class=go>          &quot;type&quot;: &quot;k8s&quot;</span>
<span class=go>      },</span>
<span class=go>      &quot;kubernetes&quot;: {</span>
<span class=go>          &quot;kubeconfig&quot;: &quot;/etc/cni/net.d/calico-kubeconfig&quot;</span>
<span class=go>      }</span>
<span class=go>    },</span>
<span class=go>    {</span>
<span class=go>      &quot;type&quot;: &quot;portmap&quot;,</span>
<span class=go>      &quot;snat&quot;: true,</span>
<span class=go>      &quot;capabilities&quot;: {&quot;portMappings&quot;: true}</span>
<span class=go>    }</span>
<span class=go>  ]</span>
<span class=go>}</span>
<span class=go>EOF</span>
</code></pre></div> <p>Back to <code>cka001</code>.</p> <div class=highlight><pre><span></span><code><span class=go>exit</span>
</code></pre></div> <p>Stay in home directory in node <code>cka001</code>.</p> <p>At this point Kubernetes nodes will become Ready because Kubernetes has a networking provider and configuration installed.</p> <div class=highlight><pre><span></span><code><span class=go>kubectl get nodes</span>
</code></pre></div> <p>Result</p> <div class=highlight><pre><span></span><code><span class=go>NAME     STATUS   ROLES                  AGE     VERSION</span>
<span class=go>cka001   Ready    control-plane,master   4h50m   v1.24.0</span>
<span class=go>cka002   Ready    &lt;none&gt;                 4h49m   v1.24.0</span>
<span class=go>cka003   Ready    &lt;none&gt;                 4h49m   v1.24.0</span>
</code></pre></div> <h2 id=install-typha>Install Typha<a class=headerlink href=#install-typha title="Permanent link"> ¶</a></h2> <p>Typha sits between the Kubernetes API server and per-node daemons like Felix and confd (running in calico/node). It watches the Kubernetes resources and Calico custom resources used by these daemons, and whenever a resource changes it fans out the update to the daemons. This reduces the number of watches the Kubernetes API server needs to serve and improves scalability of the cluster.</p> <ul> <li>Provision Certificates</li> </ul> <p>We will use mutually authenticated TLS to ensure that calico/node and Typha communicate securely. We generate a certificate authority (CA) and use it to sign a certificate for Typha.</p> <p>Change to directory <code>/etc/kubernetes/pki/</code>.</p> <div class=highlight><pre><span></span><code><span class=go>cd /etc/kubernetes/pki/</span>
</code></pre></div> <p>Create the CA certificate and key</p> <div class=highlight><pre><span></span><code><span class=go>openssl req -x509 -newkey rsa:4096 \</span>
<span class=go>  -keyout typhaca.key \</span>
<span class=go>  -nodes \</span>
<span class=go>  -out typhaca.crt \</span>
<span class=go>  -subj &quot;/CN=Calico Typha CA&quot; \</span>
<span class=go>  -days 365</span>
</code></pre></div> <p>Store the CA certificate in a ConfigMap that Typha &amp; calico/node will access.</p> <div class=highlight><pre><span></span><code><span class=go>kubectl create configmap -n kube-system calico-typha-ca --from-file=typhaca.crt</span>
</code></pre></div> <p>Create the Typha key and certificate signing request (CSR).</p> <div class=highlight><pre><span></span><code><span class=go>openssl req -newkey rsa:4096 \</span>
<span class=go>  -keyout typha.key \</span>
<span class=go>  -nodes \</span>
<span class=go>  -out typha.csr \</span>
<span class=go>  -subj &quot;/CN=calico-typha&quot;</span>
</code></pre></div> <p>The certificate presents the Common Name (CN) as <code>calico-typha</code>. <code>calico/node</code> will be configured to verify this name.</p> <p>Sign the Typha certificate with the CA.</p> <div class=highlight><pre><span></span><code><span class=go>openssl x509 -req -in typha.csr \</span>
<span class=go>  -CA typhaca.crt \</span>
<span class=go>  -CAkey typhaca.key \</span>
<span class=go>  -CAcreateserial \</span>
<span class=go>  -out typha.crt \</span>
<span class=go>  -days 365</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>Signature ok</span>
<span class=go>subject=CN = calico-typha</span>
<span class=go>Getting CA Private Key</span>
</code></pre></div> <p>Store the Typha key and certificate in a secret that Typha will access</p> <div class=highlight><pre><span></span><code><span class=go>kubectl create secret generic -n kube-system calico-typha-certs --from-file=typha.key --from-file=typha.crt</span>
</code></pre></div> <ul> <li>Provision RBAC</li> </ul> <p>Change to home directory.</p> <div class=highlight><pre><span></span><code><span class=nb>cd</span> ~
</code></pre></div> <p>Create a ServiceAccount that will be used to run Typha.</p> <div class=highlight><pre><span></span><code>kubectl create serviceaccount -n kube-system calico-typha
</code></pre></div> <p>Define a cluster role for Typha with permission to watch Calico datastore objects.</p> <div class=highlight><pre><span></span><code>kubectl apply -f - <span class=s>&lt;&lt;EOF</span>
<span class=s>kind: ClusterRole</span>
<span class=s>apiVersion: rbac.authorization.k8s.io/v1</span>
<span class=s>metadata:</span>
<span class=s>  name: calico-typha</span>
<span class=s>rules:</span>
<span class=s>  - apiGroups: [&quot;&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - pods</span>
<span class=s>      - namespaces</span>
<span class=s>      - serviceaccounts</span>
<span class=s>      - endpoints</span>
<span class=s>      - services</span>
<span class=s>      - nodes</span>
<span class=s>    verbs:</span>
<span class=s>      # Used to discover service IPs for advertisement.</span>
<span class=s>      - watch</span>
<span class=s>      - list</span>
<span class=s>  - apiGroups: [&quot;networking.k8s.io&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - networkpolicies</span>
<span class=s>    verbs:</span>
<span class=s>      - watch</span>
<span class=s>      - list</span>
<span class=s>  - apiGroups: [&quot;crd.projectcalico.org&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - globalfelixconfigs</span>
<span class=s>      - felixconfigurations</span>
<span class=s>      - bgppeers</span>
<span class=s>      - globalbgpconfigs</span>
<span class=s>      - bgpconfigurations</span>
<span class=s>      - ippools</span>
<span class=s>      - ipamblocks</span>
<span class=s>      - globalnetworkpolicies</span>
<span class=s>      - globalnetworksets</span>
<span class=s>      - networkpolicies</span>
<span class=s>      - clusterinformations</span>
<span class=s>      - hostendpoints</span>
<span class=s>      - blockaffinities</span>
<span class=s>      - networksets</span>
<span class=s>    verbs:</span>
<span class=s>      - get</span>
<span class=s>      - list</span>
<span class=s>      - watch</span>
<span class=s>  - apiGroups: [&quot;crd.projectcalico.org&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      #- ippools</span>
<span class=s>      #- felixconfigurations</span>
<span class=s>      - clusterinformations</span>
<span class=s>    verbs:</span>
<span class=s>      - get</span>
<span class=s>      - create</span>
<span class=s>      - update</span>
<span class=s>EOF</span>
</code></pre></div> <p>Bind the cluster role to the calico-typha ServiceAccount.</p> <div class=highlight><pre><span></span><code><span class=go>kubectl create clusterrolebinding calico-typha --clusterrole=calico-typha --serviceaccount=kube-system:calico-typha</span>
</code></pre></div> <ul> <li>Install Deployment</li> </ul> <p>Since Typha is required by <code>calico/node</code>, and <code>calico/node</code> establishes the pod network, we run Typha as a host networked pod to avoid a chicken-and-egg problem. We run 3 replicas of Typha so that even during a rolling update, a single failure does not make Typha unavailable.</p> <div class=highlight><pre><span></span><code>kubectl apply -f - <span class=s>&lt;&lt;EOF</span>
<span class=s>apiVersion: apps/v1</span>
<span class=s>kind: Deployment</span>
<span class=s>metadata:</span>
<span class=s>  name: calico-typha</span>
<span class=s>  namespace: kube-system</span>
<span class=s>  labels:</span>
<span class=s>    k8s-app: calico-typha</span>
<span class=s>spec:</span>
<span class=s>  replicas: 3</span>
<span class=s>  revisionHistoryLimit: 2</span>
<span class=s>  selector:</span>
<span class=s>    matchLabels:</span>
<span class=s>      k8s-app: calico-typha</span>
<span class=s>  template:</span>
<span class=s>    metadata:</span>
<span class=s>      labels:</span>
<span class=s>        k8s-app: calico-typha</span>
<span class=s>      annotations:</span>
<span class=s>        cluster-autoscaler.kubernetes.io/safe-to-evict: &#39;true&#39;</span>
<span class=s>    spec:</span>
<span class=s>      hostNetwork: true</span>
<span class=s>      tolerations:</span>
<span class=s>        # Mark the pod as a critical add-on for rescheduling.</span>
<span class=s>        - key: CriticalAddonsOnly</span>
<span class=s>          operator: Exists</span>
<span class=s>      serviceAccountName: calico-typha</span>
<span class=s>      priorityClassName: system-cluster-critical</span>
<span class=s>      containers:</span>
<span class=s>      - image: calico/typha:v3.8.0</span>
<span class=s>        name: calico-typha</span>
<span class=s>        ports:</span>
<span class=s>        - containerPort: 5473</span>
<span class=s>          name: calico-typha</span>
<span class=s>          protocol: TCP</span>
<span class=s>        env:</span>
<span class=s>          # Disable logging to file and syslog since those don&#39;t make sense in Kubernetes.</span>
<span class=s>          - name: TYPHA_LOGFILEPATH</span>
<span class=s>            value: &quot;none&quot;</span>
<span class=s>          - name: TYPHA_LOGSEVERITYSYS</span>
<span class=s>            value: &quot;none&quot;</span>
<span class=s>          # Monitor the Kubernetes API to find the number of running instances and rebalance</span>
<span class=s>          # connections.</span>
<span class=s>          - name: TYPHA_CONNECTIONREBALANCINGMODE</span>
<span class=s>            value: &quot;kubernetes&quot;</span>
<span class=s>          - name: TYPHA_DATASTORETYPE</span>
<span class=s>            value: &quot;kubernetes&quot;</span>
<span class=s>          - name: TYPHA_HEALTHENABLED</span>
<span class=s>            value: &quot;true&quot;</span>
<span class=s>          # Location of the CA bundle Typha uses to authenticate calico/node; volume mount</span>
<span class=s>          - name: TYPHA_CAFILE</span>
<span class=s>            value: /calico-typha-ca/typhaca.crt</span>
<span class=s>          # Common name on the calico/node certificate</span>
<span class=s>          - name: TYPHA_CLIENTCN</span>
<span class=s>            value: calico-node</span>
<span class=s>          # Location of the server certificate for Typha; volume mount</span>
<span class=s>          - name: TYPHA_SERVERCERTFILE</span>
<span class=s>            value: /calico-typha-certs/typha.crt</span>
<span class=s>          # Location of the server certificate key for Typha; volume mount</span>
<span class=s>          - name: TYPHA_SERVERKEYFILE</span>
<span class=s>            value: /calico-typha-certs/typha.key</span>
<span class=s>        livenessProbe:</span>
<span class=s>          httpGet:</span>
<span class=s>            path: /liveness</span>
<span class=s>            port: 9098</span>
<span class=s>            host: localhost</span>
<span class=s>          periodSeconds: 30</span>
<span class=s>          initialDelaySeconds: 30</span>
<span class=s>        readinessProbe:</span>
<span class=s>          httpGet:</span>
<span class=s>            path: /readiness</span>
<span class=s>            port: 9098</span>
<span class=s>            host: localhost</span>
<span class=s>          periodSeconds: 10</span>
<span class=s>        volumeMounts:</span>
<span class=s>        - name: calico-typha-ca</span>
<span class=s>          mountPath: &quot;/calico-typha-ca&quot;</span>
<span class=s>          readOnly: true</span>
<span class=s>        - name: calico-typha-certs</span>
<span class=s>          mountPath: &quot;/calico-typha-certs&quot;</span>
<span class=s>          readOnly: true</span>
<span class=s>      volumes:</span>
<span class=s>      - name: calico-typha-ca</span>
<span class=s>        configMap:</span>
<span class=s>          name: calico-typha-ca</span>
<span class=s>      - name: calico-typha-certs</span>
<span class=s>        secret:</span>
<span class=s>          secretName: calico-typha-certs</span>
<span class=s>EOF</span>
</code></pre></div> <p>We set <code>TYPHA_CLIENTCN</code> to calico-node which is the common name we will use on the certificate <code>calico/node</code> will use late.</p> <p>Verify Typha is up an running with three instances</p> <div class=highlight><pre><span></span><code><span class=go>kubectl get pods -l k8s-app=calico-typha -n kube-system</span>
</code></pre></div> <p>Result looks like below.</p> <div class=highlight><pre><span></span><code><span class=go>NAME                           READY   STATUS    RESTARTS   AGE</span>
<span class=go>calico-typha-5b8669646-b2xnq   1/1     Running   0          20s</span>
<span class=go>calico-typha-5b8669646-q5glk   0/1     Pending   0          20s</span>
<span class=go>calico-typha-5b8669646-rvv86   1/1     Running   0          20s</span>
</code></pre></div> <p>Here is an error message received:</p> <div class=highlight><pre><span></span><code><span class=go>0/3 nodes are available: 1 node(s) had taint {node-role.kubernetes.io/master: }, that the pod didn&#39;t tolerate, 2 node(s) didn&#39;t have free ports for the requested pod ports.</span>
</code></pre></div> <ul> <li>Install Service</li> </ul> <p><code>calico/node</code> uses a Kubernetes Service to get load-balanced access to Typha.</p> <div class=highlight><pre><span></span><code><span class=go>kubectl apply -f - &lt;&lt;EOF</span>
<span class=go>apiVersion: v1</span>
<span class=go>kind: Service</span>
<span class=go>metadata:</span>
<span class=go>  name: calico-typha</span>
<span class=go>  namespace: kube-system</span>
<span class=go>  labels:</span>
<span class=go>    k8s-app: calico-typha</span>
<span class=go>spec:</span>
<span class=go>  ports:</span>
<span class=go>    - port: 5473</span>
<span class=go>      protocol: TCP</span>
<span class=go>      targetPort: calico-typha</span>
<span class=go>      name: calico-typha</span>
<span class=go>  selector:</span>
<span class=go>    k8s-app: calico-typha</span>
<span class=go>EOF</span>
</code></pre></div> <p>Validate that Typha is using TLS.</p> <div class=highlight><pre><span></span><code><span class=go>TYPHA_CLUSTERIP=$(kubectl get svc -n kube-system calico-typha -o jsonpath=&#39;{.spec.clusterIP}&#39;)</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>curl https://$TYPHA_CLUSTERIP:5473 -v --cacert /etc/kubernetes/pki/typhaca.crt</span>
</code></pre></div> <p>Result</p> <div class=highlight><pre><span></span><code><span class=go>*   Trying 11.244.91.165:5473...</span>
<span class=go>* TCP_NODELAY set</span>
<span class=go>* Connected to 11.244.91.165 (11.244.91.165) port 5473 (#0)</span>
<span class=go>* ALPN, offering h2</span>
<span class=go>* ALPN, offering http/1.1</span>
<span class=go>* successfully set certificate verify locations:</span>
<span class=go>*   CAfile: /etc/kubernetes/pki/typhaca.crt</span>
<span class=go>  CApath: /etc/ssl/certs</span>
<span class=go>* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span>
<span class=go>* TLSv1.3 (IN), TLS handshake, Server hello (2):</span>
<span class=go>* TLSv1.2 (IN), TLS handshake, Certificate (11):</span>
<span class=go>* TLSv1.2 (IN), TLS handshake, Server key exchange (12):</span>
<span class=go>* TLSv1.2 (IN), TLS handshake, Request CERT (13):</span>
<span class=go>* TLSv1.2 (IN), TLS handshake, Server finished (14):</span>
<span class=go>* TLSv1.2 (OUT), TLS handshake, Certificate (11):</span>
<span class=go>* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):</span>
<span class=go>* TLSv1.2 (OUT), TLS change cipher, Change cipher spec (1):</span>
<span class=go>* TLSv1.2 (OUT), TLS handshake, Finished (20):</span>
<span class=go>* TLSv1.2 (IN), TLS alert, bad certificate (554):</span>
<span class=go>* error:14094412:SSL routines:ssl3_read_bytes:sslv3 alert bad certificate</span>
<span class=go>* Closing connection 0</span>
<span class=go>curl: (35) error:14094412:SSL routines:ssl3_read_bytes:sslv3 alert bad certificate</span>
</code></pre></div> <p>This demonstrates that Typha is presenting its TLS certificate and rejecting our connection because we do not present a certificate. We will later deploy calico/node with a certificate Typha will accept.</p> <h2 id=install-caliconode>Install calico/node<a class=headerlink href=#install-caliconode title="Permanent link"> ¶</a></h2> <p><code>calico/node</code> runs three daemons:</p> <ul> <li>Felix, the Calico per-node daemon</li> <li>BIRD, a daemon that speaks the BGP protocol to distribute routing information to other nodes</li> <li> <p>confd, a daemon that watches the Calico datastore for config changes and updates BIRD’s config files</p> </li> <li> <p>Provision Certificates</p> </li> </ul> <p>Change to directory <code>/etc/kubernetes/pki/</code>.</p> <div class=highlight><pre><span></span><code><span class=go>cd /etc/kubernetes/pki/</span>
</code></pre></div> <p>Create the key <code>calico/node</code> will use to authenticate with Typha and the certificate signing request (CSR)</p> <div class=highlight><pre><span></span><code><span class=go>openssl req -newkey rsa:4096 \</span>
<span class=go>  -keyout calico-node.key \</span>
<span class=go>  -nodes \</span>
<span class=go>  -out calico-node.csr \</span>
<span class=go>  -subj &quot;/CN=calico-node&quot;</span>
</code></pre></div> <p>The certificate presents the Common Name (CN) as <code>calico-node</code>, which is what we configured Typha to accept in the last lab.</p> <p>Sign the Felix certificate with the CA we created earlier.</p> <div class=highlight><pre><span></span><code><span class=go>openssl x509 -req -in calico-node.csr \</span>
<span class=go>  -CA typhaca.crt \</span>
<span class=go>  -CAkey typhaca.key \</span>
<span class=go>  -CAcreateserial \</span>
<span class=go>  -out calico-node.crt \</span>
<span class=go>  -days 365</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>Signature ok</span>
<span class=go>subject=CN = calico-node</span>
<span class=go>Getting CA Private Key</span>
</code></pre></div> <p>Store the key and certificate in a Secret that calico/node will access.</p> <div class=highlight><pre><span></span><code><span class=go>kubectl create secret generic -n kube-system calico-node-certs --from-file=calico-node.key --from-file=calico-node.crt</span>
</code></pre></div> <ul> <li>Provision RBAC</li> </ul> <p>Change to home directory.</p> <div class=highlight><pre><span></span><code><span class=nb>cd</span> ~
</code></pre></div> <p>Create the ServiceAccount that calico/node will run as.</p> <div class=highlight><pre><span></span><code>kubectl create serviceaccount -n kube-system calico-node
</code></pre></div> <p>Provision a cluster role with permissions to read and modify Calico datastore objects</p> <div class=highlight><pre><span></span><code>kubectl apply -f - <span class=s>&lt;&lt;EOF</span>
<span class=s>kind: ClusterRole</span>
<span class=s>apiVersion: rbac.authorization.k8s.io/v1</span>
<span class=s>metadata:</span>
<span class=s>  name: calico-node</span>
<span class=s>rules:</span>
<span class=s>  # The CNI plugin needs to get pods, nodes, and namespaces.</span>
<span class=s>  - apiGroups: [&quot;&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - pods</span>
<span class=s>      - nodes</span>
<span class=s>      - namespaces</span>
<span class=s>    verbs:</span>
<span class=s>      - get</span>
<span class=s>  # EndpointSlices are used for Service-based network policy rule</span>
<span class=s>  # enforcement.</span>
<span class=s>  - apiGroups: [&quot;discovery.k8s.io&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - endpointslices</span>
<span class=s>    verbs:</span>
<span class=s>      - watch</span>
<span class=s>      - list</span>
<span class=s>  - apiGroups: [&quot;&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - endpoints</span>
<span class=s>      - services</span>
<span class=s>    verbs:</span>
<span class=s>      # Used to discover service IPs for advertisement.</span>
<span class=s>      - watch</span>
<span class=s>      - list</span>
<span class=s>      # Used to discover Typhas.</span>
<span class=s>      - get</span>
<span class=s>  # Pod CIDR auto-detection on kubeadm needs access to config maps.</span>
<span class=s>  - apiGroups: [&quot;&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - configmaps</span>
<span class=s>    verbs:</span>
<span class=s>      - get</span>
<span class=s>  - apiGroups: [&quot;&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - nodes/status</span>
<span class=s>    verbs:</span>
<span class=s>      # Needed for clearing NodeNetworkUnavailable flag.</span>
<span class=s>      - patch</span>
<span class=s>      # Calico stores some configuration information in node annotations.</span>
<span class=s>      - update</span>
<span class=s>  # Watch for changes to Kubernetes NetworkPolicies.</span>
<span class=s>  - apiGroups: [&quot;networking.k8s.io&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - networkpolicies</span>
<span class=s>    verbs:</span>
<span class=s>      - watch</span>
<span class=s>      - list</span>
<span class=s>  # Used by Calico for policy information.</span>
<span class=s>  - apiGroups: [&quot;&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - pods</span>
<span class=s>      - namespaces</span>
<span class=s>      - serviceaccounts</span>
<span class=s>    verbs:</span>
<span class=s>      - list</span>
<span class=s>      - watch</span>
<span class=s>  # The CNI plugin patches pods/status.</span>
<span class=s>  - apiGroups: [&quot;&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - pods/status</span>
<span class=s>    verbs:</span>
<span class=s>      - patch</span>
<span class=s>  # Used for creating service account tokens to be used by the CNI plugin</span>
<span class=s>  - apiGroups: [&quot;&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - serviceaccounts/token</span>
<span class=s>    resourceNames:</span>
<span class=s>      - calico-node</span>
<span class=s>    verbs:</span>
<span class=s>      - create</span>
<span class=s>  # Calico monitors various CRDs for config.</span>
<span class=s>  - apiGroups: [&quot;crd.projectcalico.org&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - globalfelixconfigs</span>
<span class=s>      - felixconfigurations</span>
<span class=s>      - bgppeers</span>
<span class=s>      - globalbgpconfigs</span>
<span class=s>      - bgpconfigurations</span>
<span class=s>      - ippools</span>
<span class=s>      - ipamblocks</span>
<span class=s>      - globalnetworkpolicies</span>
<span class=s>      - globalnetworksets</span>
<span class=s>      - networkpolicies</span>
<span class=s>      - networksets</span>
<span class=s>      - clusterinformations</span>
<span class=s>      - hostendpoints</span>
<span class=s>      - blockaffinities</span>
<span class=s>    verbs:</span>
<span class=s>      - get</span>
<span class=s>      - list</span>
<span class=s>      - watch</span>
<span class=s>  # Calico must create and update some CRDs on startup.</span>
<span class=s>  - apiGroups: [&quot;crd.projectcalico.org&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - ippools</span>
<span class=s>      - felixconfigurations</span>
<span class=s>      - clusterinformations</span>
<span class=s>    verbs:</span>
<span class=s>      - create</span>
<span class=s>      - update</span>
<span class=s>  # Calico stores some configuration information on the node.</span>
<span class=s>  - apiGroups: [&quot;&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - nodes</span>
<span class=s>    verbs:</span>
<span class=s>      - get</span>
<span class=s>      - list</span>
<span class=s>      - watch</span>
<span class=s>  # These permissions are required for Calico CNI to perform IPAM allocations.</span>
<span class=s>  - apiGroups: [&quot;crd.projectcalico.org&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - blockaffinities</span>
<span class=s>      - ipamblocks</span>
<span class=s>      - ipamhandles</span>
<span class=s>    verbs:</span>
<span class=s>      - get</span>
<span class=s>      - list</span>
<span class=s>      - create</span>
<span class=s>      - update</span>
<span class=s>      - delete</span>
<span class=s>  - apiGroups: [&quot;crd.projectcalico.org&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - ipamconfigs</span>
<span class=s>    verbs:</span>
<span class=s>      - get</span>
<span class=s>  # Block affinities must also be watchable by confd for route aggregation.</span>
<span class=s>  - apiGroups: [&quot;crd.projectcalico.org&quot;]</span>
<span class=s>    resources:</span>
<span class=s>      - blockaffinities</span>
<span class=s>    verbs:</span>
<span class=s>      - watch</span>
<span class=s>EOF</span>
</code></pre></div> <p>Bind the cluster role to the calico-node ServiceAccount</p> <div class=highlight><pre><span></span><code><span class=go>kubectl create clusterrolebinding calico-node --clusterrole=calico-node --serviceaccount=kube-system:calico-node</span>
</code></pre></div> <ul> <li>Install daemon set</li> </ul> <p>Change to home directory.</p> <div class=highlight><pre><span></span><code><span class=nb>cd</span> ~
</code></pre></div> <p><code>calico/node</code> runs as a daemon set so that it is installed on every node in the cluster.</p> <p>Change <code>image: calico/node:v3.20.0</code> to right version.</p> <p>Create the daemon set</p> <div class=highlight><pre><span></span><code>kubectl apply -f - <span class=s>&lt;&lt;EOF</span>
<span class=s>kind: DaemonSet</span>
<span class=s>apiVersion: apps/v1</span>
<span class=s>metadata:</span>
<span class=s>  name: calico-node</span>
<span class=s>  namespace: kube-system</span>
<span class=s>  labels:</span>
<span class=s>    k8s-app: calico-node</span>
<span class=s>spec:</span>
<span class=s>  selector:</span>
<span class=s>    matchLabels:</span>
<span class=s>      k8s-app: calico-node</span>
<span class=s>  updateStrategy:</span>
<span class=s>    type: RollingUpdate</span>
<span class=s>    rollingUpdate:</span>
<span class=s>      maxUnavailable: 1</span>
<span class=s>  template:</span>
<span class=s>    metadata:</span>
<span class=s>      labels:</span>
<span class=s>        k8s-app: calico-node</span>
<span class=s>    spec:</span>
<span class=s>      nodeSelector:</span>
<span class=s>        kubernetes.io/os: linux</span>
<span class=s>      hostNetwork: true</span>
<span class=s>      tolerations:</span>
<span class=s>        # Make sure calico-node gets scheduled on all nodes.</span>
<span class=s>        - effect: NoSchedule</span>
<span class=s>          operator: Exists</span>
<span class=s>        # Mark the pod as a critical add-on for rescheduling.</span>
<span class=s>        - key: CriticalAddonsOnly</span>
<span class=s>          operator: Exists</span>
<span class=s>        - effect: NoExecute</span>
<span class=s>          operator: Exists</span>
<span class=s>      serviceAccountName: calico-node</span>
<span class=s>      # Minimize downtime during a rolling upgrade or deletion; tell Kubernetes to do a &quot;force</span>
<span class=s>      # deletion&quot;: https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods.</span>
<span class=s>      terminationGracePeriodSeconds: 0</span>
<span class=s>      priorityClassName: system-node-critical</span>
<span class=s>      containers:</span>
<span class=s>        # Runs calico-node container on each Kubernetes node.  This</span>
<span class=s>        # container programs network policy and routes on each</span>
<span class=s>        # host.</span>
<span class=s>        - name: calico-node</span>
<span class=s>          image: calico/node:v3.20.0</span>
<span class=s>          env:</span>
<span class=s>            # Use Kubernetes API as the backing datastore.</span>
<span class=s>            - name: DATASTORE_TYPE</span>
<span class=s>              value: &quot;kubernetes&quot;</span>
<span class=s>            - name: FELIX_TYPHAK8SSERVICENAME</span>
<span class=s>              value: calico-typha</span>
<span class=s>            # Wait for the datastore.</span>
<span class=s>            - name: WAIT_FOR_DATASTORE</span>
<span class=s>              value: &quot;true&quot;</span>
<span class=s>            # Set based on the k8s node name.</span>
<span class=s>            - name: NODENAME</span>
<span class=s>              valueFrom:</span>
<span class=s>                fieldRef:</span>
<span class=s>                  fieldPath: spec.nodeName</span>
<span class=s>            # Choose the backend to use.</span>
<span class=s>            - name: CALICO_NETWORKING_BACKEND</span>
<span class=s>              value: bird</span>
<span class=s>            # Cluster type to identify the deployment type</span>
<span class=s>            - name: CLUSTER_TYPE</span>
<span class=s>              value: &quot;k8s,bgp&quot;</span>
<span class=s>            # Auto-detect the BGP IP address.</span>
<span class=s>            - name: IP</span>
<span class=s>              value: &quot;autodetect&quot;</span>
<span class=s>            # Disable file logging so kubectl logs works.</span>
<span class=s>            - name: CALICO_DISABLE_FILE_LOGGING</span>
<span class=s>              value: &quot;true&quot;</span>
<span class=s>            # Set Felix endpoint to host default action to ACCEPT.</span>
<span class=s>            - name: FELIX_DEFAULTENDPOINTTOHOSTACTION</span>
<span class=s>              value: &quot;ACCEPT&quot;</span>
<span class=s>            # Disable IPv6 on Kubernetes.</span>
<span class=s>            - name: FELIX_IPV6SUPPORT</span>
<span class=s>              value: &quot;false&quot;</span>
<span class=s>            # Set Felix logging to &quot;info&quot;</span>
<span class=s>            - name: FELIX_LOGSEVERITYSCREEN</span>
<span class=s>              value: &quot;info&quot;</span>
<span class=s>            - name: FELIX_HEALTHENABLED</span>
<span class=s>              value: &quot;true&quot;</span>
<span class=s>            # Location of the CA bundle Felix uses to authenticate Typha; volume mount</span>
<span class=s>            - name: FELIX_TYPHACAFILE</span>
<span class=s>              value: /calico-typha-ca/typhaca.crt</span>
<span class=s>            # Common name on the Typha certificate; used to verify we are talking to an authentic typha</span>
<span class=s>            - name: FELIX_TYPHACN</span>
<span class=s>              value: calico-typha</span>
<span class=s>            # Location of the client certificate for connecting to Typha; volume mount</span>
<span class=s>            - name: FELIX_TYPHACERTFILE</span>
<span class=s>              value: /calico-node-certs/calico-node.crt</span>
<span class=s>            # Location of the client certificate key for connecting to Typha; volume mount</span>
<span class=s>            - name: FELIX_TYPHAKEYFILE</span>
<span class=s>              value: /calico-node-certs/calico-node.key</span>
<span class=s>          securityContext:</span>
<span class=s>            privileged: true</span>
<span class=s>          resources:</span>
<span class=s>            requests:</span>
<span class=s>              cpu: 250m</span>
<span class=s>          lifecycle:</span>
<span class=s>            preStop:</span>
<span class=s>              exec:</span>
<span class=s>                command:</span>
<span class=s>                - /bin/calico-node</span>
<span class=s>                - -shutdown</span>
<span class=s>          livenessProbe:</span>
<span class=s>            httpGet:</span>
<span class=s>              path: /liveness</span>
<span class=s>              port: 9099</span>
<span class=s>              host: localhost</span>
<span class=s>            periodSeconds: 10</span>
<span class=s>            initialDelaySeconds: 10</span>
<span class=s>            failureThreshold: 6</span>
<span class=s>          readinessProbe:</span>
<span class=s>            exec:</span>
<span class=s>              command:</span>
<span class=s>              - /bin/calico-node</span>
<span class=s>              - -bird-ready</span>
<span class=s>              - -felix-ready</span>
<span class=s>            periodSeconds: 10</span>
<span class=s>          volumeMounts:</span>
<span class=s>            - mountPath: /lib/modules</span>
<span class=s>              name: lib-modules</span>
<span class=s>              readOnly: true</span>
<span class=s>            - mountPath: /run/xtables.lock</span>
<span class=s>              name: xtables-lock</span>
<span class=s>              readOnly: false</span>
<span class=s>            - mountPath: /var/run/calico</span>
<span class=s>              name: var-run-calico</span>
<span class=s>              readOnly: false</span>
<span class=s>            - mountPath: /var/lib/calico</span>
<span class=s>              name: var-lib-calico</span>
<span class=s>              readOnly: false</span>
<span class=s>            - mountPath: /var/run/nodeagent</span>
<span class=s>              name: policysync</span>
<span class=s>            - mountPath: &quot;/calico-typha-ca&quot;</span>
<span class=s>              name: calico-typha-ca</span>
<span class=s>              readOnly: true</span>
<span class=s>            - mountPath: /calico-node-certs</span>
<span class=s>              name: calico-node-certs</span>
<span class=s>              readOnly: true</span>
<span class=s>      volumes:</span>
<span class=s>        # Used by calico-node.</span>
<span class=s>        - name: lib-modules</span>
<span class=s>          hostPath:</span>
<span class=s>            path: /lib/modules</span>
<span class=s>        - name: var-run-calico</span>
<span class=s>          hostPath:</span>
<span class=s>            path: /var/run/calico</span>
<span class=s>        - name: var-lib-calico</span>
<span class=s>          hostPath:</span>
<span class=s>            path: /var/lib/calico</span>
<span class=s>        - name: xtables-lock</span>
<span class=s>          hostPath:</span>
<span class=s>            path: /run/xtables.lock</span>
<span class=s>            type: FileOrCreate</span>
<span class=s>        # Used to create per-pod Unix Domain Sockets</span>
<span class=s>        - name: policysync</span>
<span class=s>          hostPath:</span>
<span class=s>            type: DirectoryOrCreate</span>
<span class=s>            path: /var/run/nodeagent</span>
<span class=s>        - name: calico-typha-ca</span>
<span class=s>          configMap:</span>
<span class=s>            name: calico-typha-ca</span>
<span class=s>        - name: calico-node-certs</span>
<span class=s>          secret:</span>
<span class=s>            secretName: calico-node-certs</span>
<span class=s>EOF</span>
</code></pre></div> <p>Verify that calico/node is running on each node in your cluster, and goes to Running within a few minutes.</p> <div class=highlight><pre><span></span><code><span class=go>kubectl get pod -l k8s-app=calico-node -n kube-system</span>
</code></pre></div> <p>Result looks like below.</p> <div class=highlight><pre><span></span><code><span class=go>NAME                READY   STATUS    RESTARTS   AGE</span>
<span class=go>calico-node-4c4sp   1/1     Running   0          40s</span>
<span class=go>calico-node-j2z6v   1/1     Running   0          40s</span>
<span class=go>calico-node-vgm9n   1/1     Running   0          40s</span>
</code></pre></div> <h2 id=test-networking>Test networking<a class=headerlink href=#test-networking title="Permanent link"> ¶</a></h2> <h3 id=pod-to-pod-pings>Pod to pod pings<a class=headerlink href=#pod-to-pod-pings title="Permanent link"> ¶</a></h3> <p>Create three busybox instances</p> <div class=highlight><pre><span></span><code><span class=go>kubectl create deployment pingtest --image=busybox --replicas=3 -- sleep infinity</span>
</code></pre></div> <p>Check their IP addresses</p> <div class=highlight><pre><span></span><code><span class=go>kubectl get pods --selector=app=pingtest --output=wide</span>
</code></pre></div> <p>Result</p> <div class=highlight><pre><span></span><code><span class=go>NAME                        READY   STATUS    RESTARTS   AGE   IP             NODE     NOMINATED NODE   READINESS GATES</span>
<span class=go>pingtest-585b76c894-chwjq   1/1     Running   0          7s    10.244.31.1    cka002   &lt;none&gt;           &lt;none&gt;</span>
<span class=go>pingtest-585b76c894-s2tbs   1/1     Running   0          7s    10.244.31.0    cka002   &lt;none&gt;           &lt;none&gt;</span>
<span class=go>pingtest-585b76c894-vm9wn   1/1     Running   0          7s    10.244.28.64   cka003   &lt;none&gt;           &lt;none&gt;</span>
</code></pre></div> <p>Note the IP addresses of the second two pods, then exec into the first one. From inside the pod, ping the other two pod IP addresses. For example:</p> <div class=highlight><pre><span></span><code><span class=go>kubectl exec -ti pingtest-585b76c894-chwjq -- sh</span>
<span class=go>/ # ping 10.244.31.1 -c 4</span>
<span class=go>4 packets transmitted, 4 packets received, 0% packet loss</span>

<span class=go>/ # ping 10.244.31.0 -c 4</span>
<span class=go>4 packets transmitted, 4 packets received, 0% packet loss</span>

<span class=go>/ # ping 10.244.28.64 -c 4</span>
<span class=go>4 packets transmitted, 0 packets received, 100% packet loss</span>
</code></pre></div> <h3 id=check-routes>Check routes<a class=headerlink href=#check-routes title="Permanent link"> ¶</a></h3> <p>From one of the nodes, verify that routes exist to each of the pingtest pods’ IP addresses. For example</p> <div class=highlight><pre><span></span><code><span class=go>ip route get 10.244.31.1</span>
<span class=go>ip route get 10.244.31.0</span>
<span class=go>ip route get 10.244.28.64</span>
</code></pre></div> <p>In the result, the <code>via &lt;cka001_ip&gt;</code>(it's control-plane) in this example indicates the next-hop for this pod IP, which matches the IP address of the node the pod is scheduled on, as expected. IPAM allocations from different pools.</p> <p>Recall that we created two IP pools, but left one disabled.</p> <div class=highlight><pre><span></span><code><span class=go>calicoctl get ippools -o wide</span>
</code></pre></div> <p>Result</p> <div class=highlight><pre><span></span><code><span class=go>NAME            CIDR              NAT    IPIPMODE   VXLANMODE   DISABLED   DISABLEBGPEXPORT   SELECTOR   </span>
<span class=go>ipv4-ippool-1   10.244.0.0/18     true   Never      Never       false      false              all()      </span>
<span class=go>ipv4-ippool-2   10.244.192.0/19   true   Never      Never       true       false              all()   </span>
</code></pre></div> <p>Enable the second pool.</p> <div class=highlight><pre><span></span><code><span class=go>calicoctl --allow-version-mismatch apply -f - &lt;&lt;EOF</span>
<span class=go>apiVersion: projectcalico.org/v3</span>
<span class=go>kind: IPPool</span>
<span class=go>metadata:</span>
<span class=go>  name: ipv4-ippool-2</span>
<span class=go>spec:</span>
<span class=go>  cidr: 10.244.192.0/19</span>
<span class=go>  ipipMode: Never</span>
<span class=go>  natOutgoing: true</span>
<span class=go>  disabled: false</span>
<span class=go>  nodeSelector: all()</span>
<span class=go>EOF</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>calicoctl get ippools -o wide</span>
</code></pre></div> <p>Result</p> <div class=highlight><pre><span></span><code><span class=go>NAME            CIDR              NAT    IPIPMODE   VXLANMODE   DISABLED   DISABLEBGPEXPORT   SELECTOR   </span>
<span class=go>ipv4-ippool-1   10.244.0.0/18     true   Never      Never       false      false              all()      </span>
<span class=go>ipv4-ippool-2   10.244.192.0/19   true   Never      Never       false      false              all()      </span>
</code></pre></div> <p>Create a pod, explicitly requesting an address from pool2</p> <div class=highlight><pre><span></span><code>kubectl apply -f - <span class=s>&lt;&lt;EOF</span>
<span class=s>apiVersion: v1</span>
<span class=s>kind: Pod</span>
<span class=s>metadata:</span>
<span class=s>  name: pingtest-ippool-2</span>
<span class=s>  annotations:</span>
<span class=s>    cni.projectcalico.org/ipv4pools: &quot;[\&quot;ipv4-ippool-2\&quot;]&quot;</span>
<span class=s>spec:</span>
<span class=s>  containers:</span>
<span class=s>  - args:</span>
<span class=s>    - sleep</span>
<span class=s>    - infinity</span>
<span class=s>    image: busybox</span>
<span class=s>    imagePullPolicy: Always</span>
<span class=s>    name: pingtest</span>
<span class=s>EOF</span>
</code></pre></div> <p>Verify it has an IP address from pool2</p> <div class=highlight><pre><span></span><code><span class=go>kubectl get pod pingtest-ippool-2 -o wide</span>
</code></pre></div> <p>Result</p> <div class=highlight><pre><span></span><code><span class=go>NAME                READY   STATUS    RESTARTS   AGE   IP               NODE     NOMINATED NODE   READINESS GATES</span>
<span class=go>pingtest-ippool-2   1/1     Running   0          18s   10.244.203.192   cka003   &lt;none&gt;           &lt;none&gt;</span>
</code></pre></div> <p>Let's attach to the Pod <code>pingtest-585b76c894-chwjq</code> again.</p> <div class=highlight><pre><span></span><code>kubectl <span class=nb>exec</span> -ti pingtest-585b76c894-chwjq -- sh
/ <span class=c1># 10.244.203.192 -c 4</span>
<span class=m>4</span> packets transmitted, <span class=m>0</span> packets received, <span class=m>100</span>% packet loss
</code></pre></div> <p>Mark here. it's failed. Need further check why the route does not work.</p> <p>Clean up</p> <div class=highlight><pre><span></span><code>kubectl delete deployments.apps pingtest
kubectl delete pod pingtest-ippool-2
</code></pre></div> <p>Reference</p> <ul> <li><a href=https://projectcalico.docs.tigera.io/getting-started/kubernetes/hardway/ >End-to-end Calico installation</a></li> </ul> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../casestudy-health-check/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Health Check" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Health Check </div> </div> </a> <a href=../kyma/ class="md-footer__link md-footer__link--next" aria-label="Next: Kyma" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Kyma </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.instant", "navigation.top"], "search": "../../../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../../../assets/javascripts/bundle.2ab50757.min.js></script> </body> </html>