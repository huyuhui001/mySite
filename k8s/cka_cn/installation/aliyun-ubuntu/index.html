<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://huyuhui001.github.io/mySite/k8s/cka_cn/installation/aliyun-ubuntu/ rel=canonical><link rel=icon href=../../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.3.1, mkdocs-material-8.4.3"><title>阿里云ECS安装Kubernetes - UPSkilling</title><link rel=stylesheet href=../../../../assets/stylesheets/main.6b80c2a2.min.css><link rel=stylesheet href=../../../../assets/stylesheets/palette.cbb835fc.min.css><meta name=theme-color content=#009485><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../../extra.css><script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme data-md-color-primary=teal data-md-color-accent=green> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#cka3ecskubernetes class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../.. title=UPSkilling class="md-header__button md-logo" aria-label=UPSkilling data-md-component=logo> <img src=../../../../assets/logo.jpg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> UPSkilling </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 阿里云ECS安装Kubernetes </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/huyuhui001/mySite title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> huyuhui001/mySite </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../.. class=md-tabs__link> UPSkilling </a> </li> <li class=md-tabs__item> <a href=../../../../linux/ class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../../ class="md-tabs__link md-tabs__link--active"> Kubernetes </a> </li> <li class=md-tabs__item> <a href=../../../../python/ class=md-tabs__link> Python </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../.. title=UPSkilling class="md-nav__button md-logo" aria-label=UPSkilling data-md-component=logo> <img src=../../../../assets/logo.jpg alt=logo> </a> UPSkilling </label> <div class=md-nav__source> <a href=https://github.com/huyuhui001/mySite title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> huyuhui001/mySite </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1> UPSkilling <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=UPSkilling data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> UPSkilling </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../.. class=md-nav__link> Welcome </a> </li> <li class=md-nav__item> <a href=../../../../about/ class=md-nav__link> About </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Linux <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Linux data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../linux/ class=md-nav__link> Index </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2 type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2> Linux SRE <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Linux SRE" data-md-level=2> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Linux SRE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../linux/SRE/01-fundamentals/ class=md-nav__link> Linux Fundamentals </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/02-filesystem/ class=md-nav__link> File System </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/03-identity-security/ class=md-nav__link> Identity & Security </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/04-TextTools/ class=md-nav__link> Text Tools </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/05-RegExpress/ class=md-nav__link> Regular Expression </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/06-FileLookup/ class=md-nav__link> File Lookup </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/07-FilePacking/ class=md-nav__link> FIle Packing & Unpacking </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_3 type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3> SUSE Linux Administration <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="SUSE Linux Administration" data-md-level=2> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> SUSE Linux Administration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../linux/Administration/01/ class=md-nav__link> Linux File System Overview </a> </li> <li class=md-nav__item> <a href=../../../../linux/Administration/02/ class=md-nav__link> Useful Commands </a> </li> <li class=md-nav__item> <a href=../../../../linux/Administration/03/ class=md-nav__link> Shell </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_4 type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4> SUSE Enterprise Storage Foundation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="SUSE Enterprise Storage Foundation" data-md-level=2> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> SUSE Enterprise Storage Foundation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../linux/SES/linux_ses_memo/ class=md-nav__link> SUSE Enterprise Storage Foundation </a> </li> <li class=md-nav__item> <a href=../../../../linux/SES/linux_ses_demo/ class=md-nav__link> SUSE Enterprise Storage Basic Operation </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Kubernetes data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../ class=md-nav__link> Index </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2 type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2> CKA Learning Memo <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="CKA Learning Memo" data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> CKA Learning Memo </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_1 type=checkbox id=__nav_3_2_1> <label class=md-nav__link for=__nav_3_2_1> Installation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Installation data-md-level=3> <label class=md-nav__title for=__nav_3_2_1> <span class="md-nav__icon md-icon"></span> Installation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_en/installation/single-local/ class=md-nav__link> Single Node Installation </a> </li> <li class=md-nav__item> <a href=../../../cka_en/installation/multiple-local/ class=md-nav__link> Multiple Nodes Installation </a> </li> <li class=md-nav__item> <a href=../../../cka_en/installation/aliyun-ubuntu/ class=md-nav__link> Installation on Aliyun ECS </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_2 type=checkbox id=__nav_3_2_2> <label class=md-nav__link for=__nav_3_2_2> Docker <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Docker data-md-level=3> <label class=md-nav__title for=__nav_3_2_2> <span class="md-nav__icon md-icon"></span> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/docker/ class=md-nav__link> Fundamentals </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_3 type=checkbox id=__nav_3_2_3> <label class=md-nav__link for=__nav_3_2_3> Foundamentals <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Foundamentals data-md-level=3> <label class=md-nav__title for=__nav_3_2_3> <span class="md-nav__icon md-icon"></span> Foundamentals </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/memo/ class=md-nav__link> Memo </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/basics/ class=md-nav__link> kubectl basics </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_4 type=checkbox id=__nav_3_2_4> <label class=md-nav__link for=__nav_3_2_4> Core Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Core Kubernetes" data-md-level=3> <label class=md-nav__title for=__nav_3_2_4> <span class="md-nav__icon md-icon"></span> Core Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/pod/ class=md-nav__link> Pod </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/deployment/ class=md-nav__link> Deployment </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/service/ class=md-nav__link> Service </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_5 type=checkbox id=__nav_3_2_5> <label class=md-nav__link for=__nav_3_2_5> Application Modeling <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Application Modeling" data-md-level=3> <label class=md-nav__title for=__nav_3_2_5> <span class="md-nav__icon md-icon"></span> Application Modeling </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/namespace/ class=md-nav__link> Namespace </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/statefulset/ class=md-nav__link> StatefulSet </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/daemonset/ class=md-nav__link> DaemonSet </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/job/ class=md-nav__link> Job and Cronjob </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/configuration/ class=md-nav__link> Configuration </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/secrets/ class=md-nav__link> Secrets </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/persistence/ class=md-nav__link> Persistence </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/rbac/ class=md-nav__link> Role Based Access Control (RBAC) </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/ingress/ class=md-nav__link> Ingress </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_6 type=checkbox id=__nav_3_2_6> <label class=md-nav__link for=__nav_3_2_6> Advanced Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Advanced Kubernetes" data-md-level=3> <label class=md-nav__title for=__nav_3_2_6> <span class="md-nav__icon md-icon"></span> Advanced Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/scheduling/ class=md-nav__link> Scheduling </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/hpa/ class=md-nav__link> Horizontal Pod Autoscaling </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/policy/ class=md-nav__link> Policy </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/networkpolicy/ class=md-nav__link> Network Policy </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/clustermgt/ class=md-nav__link> Cluster Management </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_7 type=checkbox id=__nav_3_2_7> <label class=md-nav__link for=__nav_3_2_7> Operating Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Operating Kubernetes" data-md-level=3> <label class=md-nav__title for=__nav_3_2_7> <span class="md-nav__icon md-icon"></span> Operating Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/troubleshooting/ class=md-nav__link> Troubleshooting </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/healthcheck/ class=md-nav__link> Health Check </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/helming/ class=md-nav__link> Helming </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_8 type=checkbox id=__nav_3_2_8> <label class=md-nav__link for=__nav_3_2_8> Topics <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Topics data-md-level=3> <label class=md-nav__title for=__nav_3_2_8> <span class="md-nav__icon md-icon"></span> Topics </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/casestudy-operation-resources/ class=md-nav__link> Operations on Resources </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/casestudy-health-check/ class=md-nav__link> Health Check </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/casestudy-calico/ class=md-nav__link> Calico Installation </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/kyma/ class=md-nav__link> Kyma </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3 type=checkbox id=__nav_3_3 checked> <label class=md-nav__link for=__nav_3_3> CKA学习笔记 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=CKA学习笔记 data-md-level=2> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> CKA学习笔记 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_1 type=checkbox id=__nav_3_3_1 checked> <label class=md-nav__link for=__nav_3_3_1> 安装 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=安装 data-md-level=3> <label class=md-nav__title for=__nav_3_3_1> <span class="md-nav__icon md-icon"></span> 安装 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../single-local/ class=md-nav__link> 单节点虚拟机安装Kubernetes </a> </li> <li class=md-nav__item> <a href=../multiple-local/ class=md-nav__link> 多节点虚拟机安装Kubernetes </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> 阿里云ECS安装Kubernetes <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> 阿里云ECS安装Kubernetes </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 摘要 </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 准备工作 </a> </li> <li class=md-nav__item> <a href=#ecs class=md-nav__link> 初始化ECS节点 </a> <nav class=md-nav aria-label=初始化ECS节点> <ul class=md-nav__list> <li class=md-nav__item> <a href=#etchosts class=md-nav__link> 配置文件/etc/hosts </a> </li> <li class=md-nav__item> <a href=#firewall class=md-nav__link> 禁用firewall </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#swap class=md-nav__link> 关闭swap </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 设置时区和地域 </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 内核设置 </a> </li> <li class=md-nav__item> <a href=#containerd class=md-nav__link> 安装Containerd </a> </li> <li class=md-nav__item> <a href=#nerdctl class=md-nav__link> 安装nerdctl </a> </li> <li class=md-nav__item> <a href=#kubeadm class=md-nav__link> 安装kubeadm </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 配置主节点 </a> <nav class=md-nav aria-label=配置主节点> <ul class=md-nav__list> <li class=md-nav__item> <a href=#kubeadm_1 class=md-nav__link> kubeadm初始化 </a> </li> <li class=md-nav__item> <a href=#kubeconfig class=md-nav__link> kubeconfig文件 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 配置工作节点 </a> </li> <li class=md-nav__item> <a href=#calicoflannel class=md-nav__link> 安装Calico或Flannel </a> <nav class=md-nav aria-label=安装Calico或Flannel> <ul class=md-nav__list> <li class=md-nav__item> <a href=#flannel class=md-nav__link> 安装Flannel </a> </li> <li class=md-nav__item> <a href=#calico class=md-nav__link> 安装Calico </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> 检查集群状态 </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> 更新安装 </a> <nav class=md-nav aria-label=更新安装> <ul class=md-nav__list> <li class=md-nav__item> <a href=#bash class=md-nav__link> Bash自动补全 </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> 别名 </a> </li> <li class=md-nav__item> <a href=#context class=md-nav__link> 更新默认Context </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> 重置集群 </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> 排错 </a> <nav class=md-nav aria-label=排错> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1 class=md-nav__link> 错误1 </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> 错误2 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_2 type=checkbox id=__nav_3_3_2> <label class=md-nav__link for=__nav_3_3_2> Docker <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Docker data-md-level=3> <label class=md-nav__title for=__nav_3_3_2> <span class="md-nav__icon md-icon"></span> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../foundamentals/docker/ class=md-nav__link> Docker基础 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_3 type=checkbox id=__nav_3_3_3> <label class=md-nav__link for=__nav_3_3_3> 基础知识 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=基础知识 data-md-level=3> <label class=md-nav__title for=__nav_3_3_3> <span class="md-nav__icon md-icon"></span> 基础知识 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../foundamentals/memo/ class=md-nav__link> Kubernetes随笔 </a> </li> <li class=md-nav__item> <a href=../../foundamentals/overview/ class=md-nav__link> Kubernetes集群概览 </a> </li> <li class=md-nav__item> <a href=../../foundamentals/basics/ class=md-nav__link> kubectl基础 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_4 type=checkbox id=__nav_3_3_4> <label class=md-nav__link for=__nav_3_3_4> 核心概念 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=核心概念 data-md-level=3> <label class=md-nav__title for=__nav_3_3_4> <span class="md-nav__icon md-icon"></span> 核心概念 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../foundamentals/pod/ class=md-nav__link> Pod </a> </li> <li class=md-nav__item> <a href=../../foundamentals/deployment/ class=md-nav__link> Deployment </a> </li> <li class=md-nav__item> <a href=../../foundamentals/service/ class=md-nav__link> Service </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_5 type=checkbox id=__nav_3_3_5> <label class=md-nav__link for=__nav_3_3_5> 应用体系 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=应用体系 data-md-level=3> <label class=md-nav__title for=__nav_3_3_5> <span class="md-nav__icon md-icon"></span> 应用体系 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../foundamentals/namespace/ class=md-nav__link> Namespace </a> </li> <li class=md-nav__item> <a href=../../foundamentals/statefulset/ class=md-nav__link> StatefulSet </a> </li> <li class=md-nav__item> <a href=../../foundamentals/daemonset/ class=md-nav__link> DaemonSet </a> </li> <li class=md-nav__item> <a href=../../foundamentals/job/ class=md-nav__link> Job and Cronjob </a> </li> <li class=md-nav__item> <a href=../../foundamentals/configuration/ class=md-nav__link> Configuration </a> </li> <li class=md-nav__item> <a href=../../foundamentals/secrets/ class=md-nav__link> secrets </a> </li> <li class=md-nav__item> <a href=../../foundamentals/persistence/ class=md-nav__link> Persistence </a> </li> <li class=md-nav__item> <a href=../../foundamentals/rbac/ class=md-nav__link> RBAC鉴权 </a> </li> <li class=md-nav__item> <a href=../../foundamentals/ingress/ class=md-nav__link> Ingress-nginx </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_6 type=checkbox id=__nav_3_3_6> <label class=md-nav__link for=__nav_3_3_6> 进阶概念 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=进阶概念 data-md-level=3> <label class=md-nav__title for=__nav_3_3_6> <span class="md-nav__icon md-icon"></span> 进阶概念 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../foundamentals/scheduling/ class=md-nav__link> Scheduling </a> </li> <li class=md-nav__item> <a href=../../foundamentals/hpa/ class=md-nav__link> Horizontal Pod Autoscaling (HPA) </a> </li> <li class=md-nav__item> <a href=../../foundamentals/policy/ class=md-nav__link> Policy </a> </li> <li class=md-nav__item> <a href=../../foundamentals/networkpolicy/ class=md-nav__link> Network Policy </a> </li> <li class=md-nav__item> <a href=../../foundamentals/clustermgt/ class=md-nav__link> Cluster Management </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_7 type=checkbox id=__nav_3_3_7> <label class=md-nav__link for=__nav_3_3_7> 日常维护 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=日常维护 data-md-level=3> <label class=md-nav__title for=__nav_3_3_7> <span class="md-nav__icon md-icon"></span> 日常维护 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../foundamentals/troubleshooting/ class=md-nav__link> Troubleshooting </a> </li> <li class=md-nav__item> <a href=../../foundamentals/healthcheck/ class=md-nav__link> 健康检查 </a> </li> <li class=md-nav__item> <a href=../../foundamentals/helming/ class=md-nav__link> Helm Chart </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_8 type=checkbox id=__nav_3_3_8> <label class=md-nav__link for=__nav_3_3_8> 主题讨论 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=主题讨论 data-md-level=3> <label class=md-nav__title for=__nav_3_3_8> <span class="md-nav__icon md-icon"></span> 主题讨论 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../foundamentals/casestudy-operation-resources/ class=md-nav__link> Kubernetes资源常见操作 </a> </li> <li class=md-nav__item> <a href=../../foundamentals/casestudy-health-check/ class=md-nav__link> 健康检查 </a> </li> <li class=md-nav__item> <a href=../../foundamentals/casestudy-calico/ class=md-nav__link> 安装Calico </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_4 type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4> Demos <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Demos data-md-level=2> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Demos </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../demo/cap_on_kyma/ class=md-nav__link> Build CAP Application on Kyma </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Python <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Python data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../python/ class=md-nav__link> Index </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2 type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2> Python基础 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Python基础 data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Python基础 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../python/Foundation/ch00/ class=md-nav__link> 安装 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/ch01/ class=md-nav__link> 语言基础 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/ch02/ class=md-nav__link> 打包和拆包 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/ch03/ class=md-nav__link> 函数及文件 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/ch04/ class=md-nav__link> 面向对象概念 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/ch05/ class=md-nav__link> 面向对象特性 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/Algorithms/ class=md-nav__link> 数据结构和算法 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3 type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3> Python数据分析基础 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Python数据分析基础 data-md-level=2> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Python数据分析基础 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch01/ class=md-nav__link> NumPy基础 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch10/ class=md-nav__link> NumPy进阶 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch02/ class=md-nav__link> Pandas入门 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch03/ class=md-nav__link> 数据载入、存储及文件格式 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch04/ class=md-nav__link> 数据清洗与准备 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch05/ class=md-nav__link> 数据规整：连接、联合与重塑 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch06/ class=md-nav__link> 绘图与可视化 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch07/ class=md-nav__link> 数据聚合与分组操作 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch08/ class=md-nav__link> 时间序列 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch09/ class=md-nav__link> 高阶pandas </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch11/ class=md-nav__link> Python建模库介绍 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4 type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4> Demos <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Demos data-md-level=2> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Demos </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../python/Demo/CourseSystem/ class=md-nav__link> 选课系统 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 摘要 </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 准备工作 </a> </li> <li class=md-nav__item> <a href=#ecs class=md-nav__link> 初始化ECS节点 </a> <nav class=md-nav aria-label=初始化ECS节点> <ul class=md-nav__list> <li class=md-nav__item> <a href=#etchosts class=md-nav__link> 配置文件/etc/hosts </a> </li> <li class=md-nav__item> <a href=#firewall class=md-nav__link> 禁用firewall </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#swap class=md-nav__link> 关闭swap </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 设置时区和地域 </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 内核设置 </a> </li> <li class=md-nav__item> <a href=#containerd class=md-nav__link> 安装Containerd </a> </li> <li class=md-nav__item> <a href=#nerdctl class=md-nav__link> 安装nerdctl </a> </li> <li class=md-nav__item> <a href=#kubeadm class=md-nav__link> 安装kubeadm </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 配置主节点 </a> <nav class=md-nav aria-label=配置主节点> <ul class=md-nav__list> <li class=md-nav__item> <a href=#kubeadm_1 class=md-nav__link> kubeadm初始化 </a> </li> <li class=md-nav__item> <a href=#kubeconfig class=md-nav__link> kubeconfig文件 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 配置工作节点 </a> </li> <li class=md-nav__item> <a href=#calicoflannel class=md-nav__link> 安装Calico或Flannel </a> <nav class=md-nav aria-label=安装Calico或Flannel> <ul class=md-nav__list> <li class=md-nav__item> <a href=#flannel class=md-nav__link> 安装Flannel </a> </li> <li class=md-nav__item> <a href=#calico class=md-nav__link> 安装Calico </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> 检查集群状态 </a> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> 更新安装 </a> <nav class=md-nav aria-label=更新安装> <ul class=md-nav__list> <li class=md-nav__item> <a href=#bash class=md-nav__link> Bash自动补全 </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> 别名 </a> </li> <li class=md-nav__item> <a href=#context class=md-nav__link> 更新默认Context </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> 重置集群 </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> 排错 </a> <nav class=md-nav aria-label=排错> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1 class=md-nav__link> 错误1 </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> 错误2 </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/huyuhui001/mySite/edit/main/docs/k8s/cka_cn/installation/aliyun-ubuntu.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1 id=cka3ecskubernetes>CKA自学笔记3:阿里云ECS安装Kubernetes<a class=headerlink href=#cka3ecskubernetes title="Permanent link"> ¶</a></h1> <h2 id=_1>摘要<a class=headerlink href=#_1 title="Permanent link"> ¶</a></h2> <p>在阿里云ECS装三台Ubuntu虚拟机。在Ubuntu虚拟机中安装基于Containerd的Kubernetes系统，并分别配置一个主节点Master和两个工作节点Worker，。</p> <h2 id=_2>准备工作<a class=headerlink href=#_2 title="Permanent link"> ¶</a></h2> <p>注册阿里云账号： <a href=https://home.console.aliyun.com/home/dashboard/ProductAndService>Alibaba Cloud home console</a>。注意保留访问密钥key文件，只能导出一次，当前练习中key文件是<code>aliyun-root</code>。</p> <p>参考下面配置注册申请三个ECS（Elastic Computer Service）服务实例：</p> <ul> <li>主机：2vCPU+4GiB</li> <li>操作系统：Ubuntu 20.04 x86_64</li> <li>实例类型：ecs.sn1.medium</li> <li>实例名称：cka001, cka002, cka003</li> <li>网络配置：both public IPs and private IPs</li> <li>最大网络带宽：100Mbps (Peak Value)</li> <li>云盘：40GiB</li> <li>支付方式：抢占式实例</li> </ul> <p>在本地打开终端窗口，通过密钥文件<code>aliyun-root</code>访问远程ECS节点 <code>cka001</code> 。</p> <div class=highlight><pre><span></span><code>ssh -i aliyun-root root@cka001
</code></pre></div> <p>创建一个普通用户，用来安装Kubernetes，当前练习中创建用户 <code>vagrant</code>，且修改该用户的主要组为 <code>sudo</code> 次要组包含 <code>root</code>。</p> <div class=highlight><pre><span></span><code>adduser vagrant
usermod -g sudo vagrant
usermod -a -G root vagrant
</code></pre></div> <p>新开一个本地终端窗口，为用户<code>vagrant</code>创建密钥key。</p> <div class=highlight><pre><span></span><code><span class=c1># Windows</span>
ssh-keygen.exe

<span class=c1># Linux</span>
ssh-keygen
</code></pre></div> <p>上面的命令会生成2个文件，当前练习中这2个文件是 <code>aliyun-vagrant</code> and <code>aliyun-vagrant.pub</code></p> <p>通过<code>sftp</code>命令将公钥文件 <code>aliyun-vagrant.pub</code> 上传到远程节点 <code>cka001</code>。</p> <div class=highlight><pre><span></span><code>sftp -i aliyun-root root@cka001
put aliyun-vagrant.pub
</code></pre></div> <p>新开一个终端窗口，用<code>root</code>的密钥登录<code>cka001</code>节点。 将上一步上传的密钥文件<code>aliyun-vagrant.pub</code> 从<code>/root</code>目录拷贝到 <code>/home/vagrant/.ssh/</code>。 将公钥文件 <code>aliyun-vagrant.pub</code> 重命名为 <code>authorized_keys</code>。 更改文件<code>authorized_keys</code> 的所有者owner为 <code>vagrant</code>. 更改文件<code>authorized_keys</code> 的主要组为 <code>sudo</code>。</p> <div class=highlight><pre><span></span><code>mkdir /home/vagrant/.ssh/
mv aliyun-james.pub /home/vagrant/.ssh/authorized_keys
chown vagrant.sudo /home/vagrant/.ssh/authorized_keys
chmod <span class=m>600</span> /home/vagrant/.ssh/authorized_keys
</code></pre></div> <p>检查文件 <code>/etc/ssh/sshd_config</code>，确定密码登录验证参数<code>asswordAuthentication</code>设定为<code>no</code>，即只能通过证书远程登录。</p> <div class=highlight><pre><span></span><code>cat /etc/ssh/sshd_config
</code></pre></div> <p>新开一个终端窗口，使用用户vagrant登录远程节点<code>cka001</code>，验证用户<code>vagrant</code>能通过前面创建的证书登录节点<code>cka001</code>。</p> <div class=highlight><pre><span></span><code>ssh -i aliyun-vagrant vagrant@cka001
</code></pre></div> <p>重复上述步骤，通过<code>sftp</code>命令将公钥文件 <code>aliyun-vagrant.pub</code>分别上传到远程节点 <code>cka002</code> 和 <code>cka003</code>，且完成同样的配置，使用户<code>vagrant</code>也能通过密钥文件登录远程节点 <code>cka002</code> 和 <code>cka003</code>。</p> <p>至此，用户 <code>vagrant</code> 可以通过密钥文件<code>aliyun-vagrant</code>从本地终端窗口登录远程节点 <code>cka001</code>, <code>cka002</code> 和<code>cka003</code> 。</p> <p>下面所有步骤都是通过用户 <code>vagrant</code>完成。</p> <h2 id=ecs>初始化ECS节点<a class=headerlink href=#ecs title="Permanent link"> ¶</a></h2> <h3 id=etchosts>配置文件/etc/hosts<a class=headerlink href=#etchosts title="Permanent link"> ¶</a></h3> <p>更新所有ECS节点的文件/etc/hosts，添加其他节点的私有IP（private IP）。</p> <div class=highlight><pre><span></span><code>vi /etc/hosts
</code></pre></div> <h3 id=firewall>禁用firewall<a class=headerlink href=#firewall title="Permanent link"> ¶</a></h3> <p>在所有节点上禁用防火墙。</p> <div class=highlight><pre><span></span><code>sudo ufw disable
</code></pre></div> <p>检查防火墙状态。</p> <div class=highlight><pre><span></span><code>sudo ufw status verbose
</code></pre></div> <h2 id=swap>关闭swap<a class=headerlink href=#swap title="Permanent link"> ¶</a></h2> <p>在所有节点上关闭swap。</p> <div class=highlight><pre><span></span><code>sudo swapoff -a
</code></pre></div> <h2 id=_3>设置时区和地域<a class=headerlink href=#_3 title="Permanent link"> ¶</a></h2> <p>在所有节点设定时区和地域。这一布在初始化ECS时候已经完成。可以通过下面命令进行设定。</p> <div class=highlight><pre><span></span><code>ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
sudo <span class=nb>echo</span> <span class=s1>&#39;LANG=&quot;en_US.UTF-8&quot;&#39;</span> &gt;&gt; /etc/profile
<span class=nb>source</span> /etc/profile
</code></pre></div> <p>通过下面命令检查时区和地域的设置。</p> <div class=highlight><pre><span></span><code>ll /etc/localtime
</code></pre></div> <div class=highlight><pre><span></span><code><span class=go>lrwxrwxrwx 1 root root 33 Jul  5 14:51 /etc/localtime -&gt; /usr/share/zoneinfo/Asia/Shanghai</span>
</code></pre></div> <h2 id=_4>内核设置<a class=headerlink href=#_4 title="Permanent link"> ¶</a></h2> <p>在所有节点上执行下面的命令以配置内核。</p> <p>使用模块overlay：</p> <p>创建Containerd服务配置文件 <code>/etc/modules-load.d/containerd.conf</code> ，如果已存在则跳过这一步。配置这个文件的目的是为了加载模块 <code>overlay</code> 和 <code>br_netfilter</code>到内核中。</p> <p>服务Containerd依赖模块<code>overlay</code> 实现<a href=https://developer.aliyun.com/article/660712>overlay-filesystem</a>文件系统功能。</p> <p>Linux中的overlay模块提供了创建两个目录的合并视图的能力，这两个目录称为层。它经常被用于实现联合挂载，这是一种将两个或更多目录一起挂载的方式，就像它们是一个目录一样（union-filesystems）。</p> <p>overlay模块在容器技术中被广泛使用，比如Docker，因为它允许多个容器共享基础镜像，同时保持它们自己的文件系统。</p> <p>要使用overlay模块，需要两个目录：较低的目录（lower directory）和较高的目录（upper directory）。较低的目录通常是只读的，包含原始文件，而较高的目录是可读写的，包含对文件的更改。当请求文件时，overlay模块首先查找上层目录，如果未找到，则查找下层目录。</p> <p>比如：</p> <p>创建两个目录，一个用于较低的目录，一个用于较高的目录。然后使用overlay文件系统类型将它们挂载起来：</p> <div class=highlight><pre><span></span><code>sudo mkdir /lower sudo mkdir /upper sudo mount -t overlay overlay -o <span class=nv>lowerdir</span><span class=o>=</span>/lower,upperdir<span class=o>=</span>/upper /merged
</code></pre></div> <p>在上面的例子中，两个目录的合并视图被创建在<code>/merged</code>目录中。在<code>/merged</code>目录中对文件所做的任何更改都存储在上层目录中，而原始文件仍然在下层目录中。</p> <p>使用模块br_netfilter：</p> <p><code>br_netfilter</code>是Linux内核中的一个模块，它提供了一种机制来过滤网桥的网络流量。该模块允许管理员配置规则，以允许或拒绝特定的网络流量通过网桥。</p> <p>网桥是一种网络设备，它可以连接多个网络段，并转发流量以使不同的网络段之间通信。<code>br_netfilter</code>模块可以用来限制或过滤这些流量。</p> <p>当启用了<code>br_netfilter</code>模块时，它会自动启用一个称为<code>bridge-nf</code>的功能，该功能将在网络流量通过网桥时应用规则。管理员可以使用iptables等工具来配置这些规则。例如，我们可以设定允许从一个网络段到另一个网络段的流量，或者拒绝来自特定IP地址或端口的流量。</p> <p>在Kubernetes中，<code>br_netfilter</code>模块主要用于启用Kubernetes服务的流量转发和负载均衡。这些服务使用了Linux内核中的iptables规则来管理流量，这些规则是通过<code>br_netfilter</code>模块实现的。</p> <p>具体来说，当我们在Kubernetes集群中创建一个服务时，该服务将分配一个虚拟IP地址，用于代表服务。然后，通过iptables规则，将这个虚拟IP地址映射到一个或多个后端Pod的IP地址，以便在需要时将流量路由到这些Pod。</p> <p>在这个过程中，<code>br_netfilter</code>模块负责监视服务的流量，并根据iptables规则进行转发和负载均衡。这包括过滤来自不受信任源的流量以及限制服务的访问权限。</p> <p>需要注意的是，为了启用Kubernetes服务的流量转发和负载均衡，<code>br_netfilter</code>模块必须在所有节点上启用，并且必须配置正确的iptables规则。</p> <p>由于<code>br_netfilter</code>模块的作用非常关键，因此在升级或更改系统时需要特别注意它的配置和状态。</p> <p>下面命令将模块<code>overlay</code>和<code>br_netfilter</code>添加到配置文件<code>containerd.conf</code>中。</p> <div class=highlight><pre><span></span><code>cat <span class=s>&lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf</span>
<span class=s>overlay</span>
<span class=s>br_netfilter</span>
<span class=s>EOF</span>
</code></pre></div> <p>手工加载模块<code>overlay</code> 和 <code>br_netfilter</code> 。</p> <div class=highlight><pre><span></span><code>sudo modprobe overlay
sudo modprobe br_netfilter
</code></pre></div> <p>验证模块是否已被加载。</p> <div class=highlight><pre><span></span><code>lsmod <span class=p>|</span> grep br_netfilter
</code></pre></div> <p>创建文件 <code>99-kubernetes-cri.conf</code> 用来配置Kubernetes CRI。</p> <p>Kubernetes CRI (Container Runtime Interface) 是 Kubernetes 用于管理容器的插件架构。它定义了容器运行时所需的 API 和契约，使得 Kubernetes 可以与任何符合该接口标准的容器运行时交互。</p> <p>CRI 最初于 Kubernetes 1.5 版本中引入，作为将容器运行时从 kubelet 中解耦出来的一种方法。在 Kubernetes 中，kubelet 是运行在节点上的主要代理程序，它负责在节点上运行容器并与 Kubernetes API 交互。通过引入 CRI，kubelet 可以使用不同的容器运行时（如 Docker、CRI-O、containerd 等）来运行容器，而无需了解容器运行时的内部细节。这种解耦使得 Kubernetes 更加灵活和可扩展，并使容器运行时的维护更加简单。</p> <p>总之，Kubernetes CRI 定义了 Kubernetes 与容器运行时之间的接口，使得 Kubernetes 可以使用不同的容器运行时来管理容器，并使 Kubernetes 更加灵活和可扩展。</p> <p>设置参数 <code>net/bridge/bridge-nf-call-iptables=1</code> ，使 Linux 桥接模块上运行的容器能够通过 iptables 进行网络包过滤（filtering）和转发（forwarding）。</p> <p>这个参数的作用是让 Linux 网络桥接能够支持 iptables 的 NAT(Network Address Translation)和过滤功能。具体来说，当容器网络流量通过 Linux 网桥桥接到宿主机网络时，如果这个参数为 1，则 iptables 规则将被应用到容器的网络流量上。如果设置为 0，则不会应用 iptables 规则，这可能会导致容器网络的不稳定性。</p> <p>参考<a href=https://cloud.tencent.com/developer/article/1828060>Why <code>net/bridge/bridge-nf-call-iptables=1</code> need to be enable by Kubernetes</a>）。</p> <p>IP转发（IP forwarding）也被称为路由（routing）。在Linux中，它也被称为内核IP转发，因为它使用内核变量<code>net.ipv4.ip_forward</code>来启用或禁用IP转发功能。默认值为<code>ip_forward=0</code>。因此，Linux的IP转发功能默认情况下是被禁用的。</p> <div class=highlight><pre><span></span><code>cat <span class=s>&lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf</span>
<span class=s>net.bridge.bridge-nf-call-iptables  = 1</span>
<span class=s>net.ipv4.ip_forward                 = 1</span>
<span class=s>net.bridge.bridge-nf-call-ip6tables = 1</span>
<span class=s>EOF</span>
</code></pre></div> <p>命令<code>sysctl</code> 从目录 <code>/proc/sys</code> 读取信息。<code>/proc/sys</code>是一个虚拟目录，其中包含可用于查看和设置当前内核参数的文件对象。</p> <p>通过<code>sysctl -w net.ipv4.ip_forward=1</code>命令，更改立即生效，但不是永久的。在系统重启后，将加载默认值。要永久设置参数，需要将设置写入<code>/etc/sysctl.conf</code>或<code>/etc/sysctl.d</code>目录中的另一个配置文件：</p> <div class=highlight><pre><span></span><code>sudo sysctl --system
</code></pre></div> <p>验证参数是否生效。</p> <div class=highlight><pre><span></span><code>sysctl net.ipv4.ip_forward
</code></pre></div> <h2 id=containerd>安装Containerd<a class=headerlink href=#containerd title="Permanent link"> ¶</a></h2> <p>在所有节点上安装Containerd服务。参考资料：<a href=https://github.com/containerd/containerd/blob/main/docs/ops.md>containerd for Ops and Admins</a></p> <p>安装前备份Ubuntu安装源配置文件。</p> <div class=highlight><pre><span></span><code>sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
</code></pre></div> <p>添加合适的安装源。基于阿里ECS的Ubuntu 20.04，已经预配置了阿里内部的源，这一步只需要检查一下是否阿里源已配置。</p> <div class=highlight><pre><span></span><code>cat &gt; /etc/apt/sources.list <span class=s>&lt;&lt; EOF</span>
<span class=s>deb http://mirrors.cloud.aliyuncs.com/ubuntu/ focal main restricted</span>
<span class=s>deb-src http://mirrors.cloud.aliyuncs.com/ubuntu/ focal main restricted</span>
<span class=s>deb http://mirrors.cloud.aliyuncs.com/ubuntu/ focal-updates main restricted</span>
<span class=s>deb-src http://mirrors.cloud.aliyuncs.com/ubuntu/ focal-updates main restricted</span>
<span class=s>deb http://mirrors.cloud.aliyuncs.com/ubuntu/ focal universe</span>
<span class=s>deb-src http://mirrors.cloud.aliyuncs.com/ubuntu/ focal universe</span>
<span class=s>deb http://mirrors.cloud.aliyuncs.com/ubuntu/ focal-updates universe</span>
<span class=s>deb-src http://mirrors.cloud.aliyuncs.com/ubuntu/ focal-updates universe</span>
<span class=s>deb http://mirrors.cloud.aliyuncs.com/ubuntu/ focal multiverse</span>
<span class=s>deb-src http://mirrors.cloud.aliyuncs.com/ubuntu/ focal multiverse</span>
<span class=s>deb http://mirrors.cloud.aliyuncs.com/ubuntu/ focal-updates multiverse</span>
<span class=s>deb-src http://mirrors.cloud.aliyuncs.com/ubuntu/ focal-updates multiverse</span>
<span class=s>deb http://mirrors.cloud.aliyuncs.com/ubuntu/ focal-backports main restricted universe multiverse</span>
<span class=s>deb-src http://mirrors.cloud.aliyuncs.com/ubuntu/ focal-backports main restricted universe multivers</span>
<span class=s>deb http://mirrors.cloud.aliyuncs.com/ubuntu focal-security main restricted</span>
<span class=s>deb-src http://mirrors.cloud.aliyuncs.com/ubuntu focal-security main restricted</span>
<span class=s>deb http://mirrors.cloud.aliyuncs.com/ubuntu focal-security universe</span>
<span class=s>deb-src http://mirrors.cloud.aliyuncs.com/ubuntu focal-security universe</span>
<span class=s># deb http://mirrors.cloud.aliyuncs.com/ubuntu focal-security multiverse</span>
<span class=s># deb-src http://mirrors.cloud.aliyuncs.com/ubuntu focal-security multiverse</span>
<span class=s>EOF</span>
</code></pre></div> <p>安装Containered。</p> <div class=highlight><pre><span></span><code>sudo apt-get update <span class=o>&amp;&amp;</span> sudo apt-get install -y containerd
</code></pre></div> <p>配置Containerd。修改文件 <code>/etc/containerd/config.toml</code>。</p> <div class=highlight><pre><span></span><code>sudo mkdir -p /etc/containerd
containerd config default <span class=p>|</span> sudo tee /etc/containerd/config.toml
sudo vi /etc/containerd/config.toml
</code></pre></div> <p>修改参数<code>sandbox_image</code> 的值为<code>"registry.aliyuncs.com/google_containers/pause:3.6"</code>。 修改参数<code>SystemdCgroup</code>的值为<code>true</code>。</p> <div class=highlight><pre><span></span><code><span class=go>[plugins]</span>
<span class=go>  [plugins.&quot;io.containerd.gc.v1.scheduler&quot;]</span>

<span class=go>  [plugins.&quot;io.containerd.grpc.v1.cri&quot;]</span>
<span class=go>    sandbox_image = &quot;registry.aliyuncs.com/google_containers/pause:3.6&quot;</span>

<span class=go>    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.cni]</span>
<span class=go>    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd]</span>
<span class=go>      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.default_runtime]</span>
<span class=go>        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.default_runtime.options]</span>
<span class=go>      [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes]</span>
<span class=go>        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]</span>

<span class=go>          [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]</span>
<span class=go>            SystemdCgroup = true</span>
</code></pre></div> <p>重启Containerd服务。</p> <div class=highlight><pre><span></span><code>sudo systemctl restart containerd
sudo systemctl status containerd
</code></pre></div> <h2 id=nerdctl>安装nerdctl<a class=headerlink href=#nerdctl title="Permanent link"> ¶</a></h2> <p>在所有节点上安装nerdctl服务。</p> <p><a href=https://github.com/containerd/nerdctl><code>nerdctl</code></a> 服务支持Contanerd所提供的容器化特性，特别是一些Docker不具备的新特性。</p> <p>二进制安装包可以通过这个链接取得: <a href=https://github.com/containerd/nerdctl/releases>Releases · containerd/nerdctl · GitHub</a> 。</p> <div class=highlight><pre><span></span><code>wget https://github.com/containerd/nerdctl/releases/download/v0.22.2/nerdctl-0.22.2-linux-amd64.tar.gz
tar -zxvf nerdctl-0.22.2-linux-amd64.tar.gz
sudo cp nerdctl /usr/bin/
</code></pre></div> <p>验证<code>nerdctl</code>服务。</p> <div class=highlight><pre><span></span><code>sudo nerdctl --help
</code></pre></div> <p>列出初始安装Kubernetes时的容器container列表。</p> <div class=highlight><pre><span></span><code>nerdctl -n k8s.io ps
</code></pre></div> <h2 id=kubeadm>安装kubeadm<a class=headerlink href=#kubeadm title="Permanent link"> ¶</a></h2> <p>在所有节点上安装Kubeadm，kubectl，kubelet。</p> <p>安装和升级Ubuntu系统依赖包 <code>apt-transport-https</code>, <code>ca-certificates</code>, <code>curl</code>。</p> <div class=highlight><pre><span></span><code>sudo apt-get update <span class=o>&amp;&amp;</span> sudo apt-get install -y apt-transport-https ca-certificates curl
</code></pre></div> <p>安装gpg证书。</p> <div class=highlight><pre><span></span><code>sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg
</code></pre></div> <p>添加Kubernetes安装源。</p> <div class=highlight><pre><span></span><code><span class=nb>echo</span> <span class=s2>&quot;deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://mirrors.aliyun.com/kubernetes/apt/ \</span>
<span class=s2>  kubernetes-xenial main&quot;</span> <span class=p>|</span> sudo tee /etc/apt/sources.list.d/kubernetes.list
</code></pre></div> <p>安装和升级Ubuntu系统依赖包。</p> <div class=highlight><pre><span></span><code>sudo apt-get update
sudo apt-get install ebtables
sudo apt-get install libxtables12
sudo apt-get upgrade iptables
</code></pre></div> <p>检查当前可用的<code>kubeadm</code>版本。</p> <div class=highlight><pre><span></span><code>apt policy kubeadm
</code></pre></div> <p>当前安装<code>1.24.0-00</code> 版本的<code>kubeadm</code>，后续会升级到 <code>1.24.2</code> 版本。</p> <div class=highlight><pre><span></span><code>sudo apt-get -y install <span class=nv>kubelet</span><span class=o>=</span><span class=m>1</span>.24.0-00 <span class=nv>kubeadm</span><span class=o>=</span><span class=m>1</span>.24.0-00 <span class=nv>kubectl</span><span class=o>=</span><span class=m>1</span>.24.0-00 --allow-downgrades
</code></pre></div> <h2 id=_5>配置主节点<a class=headerlink href=#_5 title="Permanent link"> ¶</a></h2> <h3 id=kubeadm_1>kubeadm初始化<a class=headerlink href=#kubeadm_1 title="Permanent link"> ¶</a></h3> <p>在承担主节点的虚拟机里配置控制平面（Control Plane）。</p> <p>检查<code>kubeadm</code> 当前默认配置参数。</p> <div class=highlight><pre><span></span><code>kubeadm config print init-defaults
</code></pre></div> <p>类似结果如下。保存默认配置的结果，后续会作为参考。</p> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kubeadm.k8s.io/v1beta3</span><span class=w></span>
<span class=nt>bootstrapTokens</span><span class=p>:</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>groups</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">system:bootstrappers:kubeadm:default-node-token</span><span class=w></span>
<span class=w>  </span><span class=nt>token</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">abcdef.0123456789abcdef</span><span class=w></span>
<span class=w>  </span><span class=nt>ttl</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">24h0m0s</span><span class=w></span>
<span class=w>  </span><span class=nt>usages</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">signing</span><span class=w></span>
<span class=w>  </span><span class="p p-Indicator">-</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">authentication</span><span class=w></span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">InitConfiguration</span><span class=w></span>
<span class=nt>localAPIEndpoint</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>advertiseAddress</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1.2.3.4</span><span class=w></span>
<span class=w>  </span><span class=nt>bindPort</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">6443</span><span class=w></span>
<span class=nt>nodeRegistration</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>criSocket</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">unix:///var/run/containerd/containerd.sock</span><span class=w></span>
<span class=w>  </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">node</span><span class=w></span>
<span class=w>  </span><span class=nt>taints</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class=w></span>
<span class=nn>---</span><span class=w></span>
<span class=nt>apiServer</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>timeoutForControlPlane</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">4m0s</span><span class=w></span>
<span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kubeadm.k8s.io/v1beta3</span><span class=w></span>
<span class=nt>certificatesDir</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/etc/kubernetes/pki</span><span class=w></span>
<span class=nt>clusterName</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes</span><span class=w></span>
<span class=nt>controllerManager</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span><span class=w></span>
<span class=nt>dns</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span><span class=w></span>
<span class=nt>etcd</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>local</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>dataDir</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/etcd</span><span class=w></span>
<span class=nt>imageRepository</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">k8s.gcr.io</span><span class=w></span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterConfiguration</span><span class=w></span>
<span class=nt>kubernetesVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1.24.0</span><span class=w></span>
<span class=nt>networking</span><span class=p>:</span><span class=w></span>
<span class=w>  </span><span class=nt>dnsDomain</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cluster.local</span><span class=w></span>
<span class=w>  </span><span class=nt>serviceSubnet</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">10.96.0.0/12</span><span class=w></span>
<span class=nt>scheduler</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span><span class=w></span>
</code></pre></div> <p>模拟安装和正式安装。</p> <p>通过命令 <code>kubeadm init</code> 进行主节点的初始化，下面是这个命令主要参数的说明，特别是网络参数的三个选择。</p> <ul> <li><code>--pod-network-cidr</code>:</li> <li>指定pod使用的IP地址范围。如果指定了该参数，则Control Plane会自动讲指定的CIDR分配给每个节点。</li> <li>IP地址段 <code>10.244.0.0/16</code> 是Flannel网络组件默认的地址范围。如果需要修改Flannel的IP地址段，需要在这里指定，且在部署Flannel时也要保持一致的IP段。</li> <li><code>--apiserver-bind-port</code>:</li> <li>API服务（API Server）的端口，默认时6443。</li> <li><code>--service-cidr</code>:</li> <li>指定服务（service）的IP地址段，默认是<code>10.96.0.0/12</code>。</li> </ul> <p>提示：</p> <ul> <li>服务VIPs（service VIPs），也称作集群IP（Cluster IP），通过参数 <code>--service-cidr</code>指定。</li> <li>podCIDR，也称为endpoint IP，通过参数 <code>--pod-network-cidr</code>指定。</li> </ul> <p>有4种典型的网络问题：</p> <ul> <li>高度耦合的容器与容器之间的通信：这可以通过Pod（podCIDR）和本地主机通信来解决。</li> <li>Pod对Pod通信（Pod-to-Pod）：</li> <li>也被称为容器对容器通信（container-to-container）。</li> <li>在Flannel网络插件中的示例流程是：Pod &rarr; veth对 &rarr; cni0 &rarr; flannel.1 &rarr; 宿主机eth0 &rarr; 宿主机eth0 &rarr; flannel.1 &rarr; cni0 &rarr; veth对 &rarr; Pod。</li> <li>Pod对Service通信（Pod-to-Service）：</li> <li>流程: Pod &rarr; 内核 &rarr; Service iptables &rarr; Service &rarr; Pod iptables &rarr; Pod。</li> <li>外部对Service通信（External-to-Service）：</li> <li>负载均衡器: SLB &rarr; NodePort &rarr; Service &rarr; Pod。</li> </ul> <p><code>kube-proxy</code> 是对iptables负责，不是网络流量（traffic）。</p> <ul> <li> <p><code>kube-proxy</code>是Kubernetes集群中的一个组件，负责为Service提供代理服务，同时也是Kubernetes网络模型中的重要组成部分之一。<code>kube-proxy</code>会在每个节点上启动一个代理进程，通过监听Kubernetes API Server的Service和Endpoint的变化来维护一个本地的Service和Endpoint的缓存。当有请求到达某个Service时，<code>kube-proxy</code>会根据该Service的类型（ClusterIP、NodePort、LoadBalancer、ExternalName）和端口号，生成相应的iptables规则，将请求转发给Service所代理的后端Pod。</p> </li> <li> <p>iptables是Linux系统中的一个重要网络工具，可以设置IP包的过滤、转发和修改规则，可以实现网络层的防火墙、NAT等功能。在Kubernetes集群中，<code>kube-proxy</code>通过生成和更新iptables规则，来实现Service和Endpoint之间的转发和代理。具体来说，kube-proxy会为每个Service创建三条iptables规则链（nat表中的KUBE-SERVICES和KUBE-NODEPORTS链，以及filter表中的KUBE-SVC-XXXXX链），通过这些规则链，将请求转发到相应的Pod或者Service上。</p> </li> <li> <p>因此，<code>kube-proxy</code>和iptables是紧密相关的两个组件，通过iptables规则来实现Service和Pod之间的转发和代理。这种实现方式具有可扩展性和高可用性，同时也提供了一种灵活的网络模型，可以方便地实现服务发现、负载均衡等功能。</p> </li> </ul> <div class=highlight><pre><span></span><code>sudo kubeadm init <span class=se>\</span>
  --dry-run <span class=se>\</span>
  --pod-network-cidr<span class=o>=</span><span class=m>10</span>.244.0.0/16 <span class=se>\</span>
  --service-cidr <span class=m>11</span>.244.0.0/16 <span class=se>\</span>
  --image-repository<span class=o>=</span>registry.aliyuncs.com/google_containers <span class=se>\</span>
  --kubernetes-version<span class=o>=</span>v1.24.0

sudo kubeadm init <span class=se>\</span>
  --pod-network-cidr<span class=o>=</span><span class=m>10</span>.244.0.0/16 <span class=se>\</span>
  --service-cidr <span class=m>11</span>.244.0.0/16 <span class=se>\</span>
  --image-repository<span class=o>=</span>registry.aliyuncs.com/google_containers <span class=se>\</span>
  --kubernetes-version<span class=o>=</span>v1.24.0

sudo kubeadm init <span class=se>\</span>
  --pod-network-cidr<span class=o>=</span><span class=m>10</span>.244.0.0/16 <span class=se>\</span>
  --service-cidr <span class=m>11</span>.244.0.0/16 <span class=se>\</span>
  --kubernetes-version<span class=o>=</span>v1.24.0
</code></pre></div> <h3 id=kubeconfig>kubeconfig文件<a class=headerlink href=#kubeconfig title="Permanent link"> ¶</a></h3> <p>给当前安装用户配置 <code>kubeconfig</code> 文件（当前例子是用户<code>vagrant</code>）。</p> <div class=highlight><pre><span></span><code>mkdir -p <span class=nv>$HOME</span>/.kube
sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</code></pre></div> <p>Kubernetes 提供了一个命令行工具<code>kubectl</code>，用于使用 Kubernetes API 与 Kubernetes 集群的控制平面进行通信。</p> <p>kubectl 控制 Kubernetes <em>cluster manager</em>（集群管理器）。</p> <p>对于配置，kubectl 在 <code>$HOME/.kube</code>目录中查找一个名为 config 的文件，该文件是由 <code>kubeadm init</code>生成的文件 <code>/etc/kubernetes/admin.conf</code>的副本。</p> <p>我们可以通过设置 <code>KUBECONFIG</code>环境变量或设置 <code>--kubeconfig flag</code>标志来指定其他 kubeconfig 文件。如果 <code>KUBECONFIG</code> 环境变量不存在，kubectl 将使用默认的 kubeconfig 文件 <code>$HOME/.kube/config</code>。</p> <p>kubeconfig 文件中的 <em>context（上下文）</em> 元素用于将访问参数分组到一个方便的名称下。每个上下文都有三个参数：集群、命名空间和用户。默认情况下，kubectl 命令行工具使用当前上下文中的参数与集群通信。</p> <p>文件<code>.kube/config</code>的例子：</p> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class=w></span>
<span class=nt>clusters</span><span class=p>:</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>cluster</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>certificate-authority-data</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;certificate string&gt;</span><span class=w></span>
<span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://&lt;eth0 ip&gt;:6443</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;cluster name&gt;</span><span class=w></span>
<span class=nt>contexts</span><span class=p>:</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>context</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;cluster name&gt;</span><span class=w></span>
<span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;namespace name&gt;</span><span class=w></span>
<span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;user name&gt;</span><span class=w></span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;context user&gt;@&lt;context name&gt;</span><span class=w></span>
<span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;context name&gt;</span><span class=w></span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Config</span><span class=w></span>
<span class=nt>preferences</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">{}</span><span class=w></span>
<span class=nt>users</span><span class=p>:</span><span class=w></span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;user name&gt;</span><span class=w></span>
<span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=nt>client-certificate-data</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;certificate string&gt;</span><span class=w></span>
<span class=w>    </span><span class=nt>client-key-data</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;certificate string&gt;</span><span class=w></span>
</code></pre></div> <p>读取当前上下文：</p> <div class=highlight><pre><span></span><code>kubectl config get-contexts
</code></pre></div> <p>运行结果：</p> <div class=highlight><pre><span></span><code><span class=go>CURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE</span>
<span class=go>*         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin   </span>
</code></pre></div> <h2 id=_6>配置工作节点<a class=headerlink href=#_6 title="Permanent link"> ¶</a></h2> <p>使用 <code>kubeadm token</code> 来生成加入集群的令牌（token）和哈西值（hash value）。</p> <div class=highlight><pre><span></span><code>kubeadm token create --print-join-command
</code></pre></div> <p>在所有工作节点上执行下面的命令，将工作节点加入Kubernetes集群。</p> <div class=highlight><pre><span></span><code><span class=c1># kubeadm join &lt;your master node eth0 ip&gt;:6443 --token &lt;token generated by kubeadm init&gt; --discovery-token-ca-cert-hash &lt;hash key generated by kubeadm init&gt;</span>
</code></pre></div> <p>执行下面命令检查所有节点的状态。 当前所有节点的状态都是 <code>NotReady</code>。目前不需要做什么，后面我们会安装相关的网络服务（Calico 或 Flannel），各节点的状态就会变成Ready状态。</p> <h2 id=calicoflannel>安装Calico或Flannel<a class=headerlink href=#calicoflannel title="Permanent link"> ¶</a></h2> <p>在控制平面Control Plane上安装Calico或者Flannel。如果需要配置网络策略，则选择Calico。</p> <h3 id=flannel>安装Flannel<a class=headerlink href=#flannel title="Permanent link"> ¶</a></h3> <p><a href=https://github.com/flannel-io/flannel>Flannel</a> 是为 Kubernetes 设计的一种简单易用的配置三层网络的方法。</p> <p>部署Flannel：</p> <p>在 <code>kube-flannel.yml</code> 中，我们可以获取 Flannel 的默认网络设置，它与我们在使用 <code>kubeadm</code> 初始化集群时指定的参数 <code>--pod-network-cidr=10.244.0.0/16</code> 相同。</p> <div class=highlight><pre><span></span><code><span class=w>  </span><span class=kc>net</span><span class=mi>-</span><span class=err>co</span><span class=kc>nf</span><span class=err>.jso</span><span class=kc>n</span><span class=p>:</span><span class=w> </span><span class=err>|</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=nt>&quot;Network&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;10.244.0.0/16&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=nt>&quot;Backend&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=nt>&quot;Type&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;vxlan&quot;</span><span class=w></span>
<span class=w>      </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
</code></pre></div> <p>创建Flannel服务。</p> <div class=highlight><pre><span></span><code>apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre></div> <p>输出结果：</p> <div class=highlight><pre><span></span><code><span class=go>Warning: policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+</span>
<span class=go>podsecuritypolicy.policy/psp.flannel.unprivileged created</span>
<span class=go>clusterrole.rbac.authorization.k8s.io/flannel created</span>
<span class=go>clusterrolebinding.rbac.authorization.k8s.io/flannel created</span>
<span class=go>serviceaccount/flannel created</span>
<span class=go>configmap/kube-flannel-cfg created</span>
<span class=go>daemonset.apps/kube-flannel-ds created</span>
</code></pre></div> <h3 id=calico>安装Calico<a class=headerlink href=#calico title="Permanent link"> ¶</a></h3> <p>安装指导手册：<a href=https://projectcalico.docs.tigera.io/getting-started/kubernetes/hardway/ >End-to-end Calico installation</a>。</p> <p>下载并安装Calico服务。</p> <div class=highlight><pre><span></span><code>curl https://docs.projectcalico.org/manifests/calico.yaml -O
kubectl apply -f calico.yaml
</code></pre></div> <p>输出结果：</p> <div class=highlight><pre><span></span><code><span class=go>configmap/calico-config created</span>
<span class=go>customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created</span>
<span class=go>customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created</span>
<span class=go>customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created</span>
<span class=go>customresourcedefinition.apiextensions.k8s.io/caliconodestatuses.crd.projectcalico.org created</span>
<span class=go>customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created</span>
<span class=go>customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created</span>
<span class=go>customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created</span>
<span class=go>customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created</span>
<span class=go>customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created</span>
<span class=go>customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created</span>
<span class=go>customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created</span>
<span class=go>customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created</span>
<span class=go>customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created</span>
<span class=go>customresourcedefinition.apiextensions.k8s.io/ipreservations.crd.projectcalico.org created</span>
<span class=go>customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created</span>
<span class=go>customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created</span>
<span class=go>customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created</span>
<span class=go>clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created</span>
<span class=go>clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created</span>
<span class=go>clusterrole.rbac.authorization.k8s.io/calico-node created</span>
<span class=go>clusterrolebinding.rbac.authorization.k8s.io/calico-node created</span>
<span class=go>daemonset.apps/calico-node created</span>
<span class=go>serviceaccount/calico-node created</span>
<span class=go>deployment.apps/calico-kube-controllers created</span>
<span class=go>serviceaccount/calico-kube-controllers created</span>
<span class=go>poddisruptionbudget.policy/calico-kube-controllers created</span>
</code></pre></div> <p>验证Calico服务状态：</p> <div class=highlight><pre><span></span><code>kubectl get pod -n kube-system <span class=p>|</span> grep calico
</code></pre></div> <p>输出结果：</p> <div class=highlight><pre><span></span><code>calico-kube-controllers-555bc4b957-l8bn2   <span class=m>0</span>/1     Pending    <span class=m>0</span>          28s
calico-node-255pc                          <span class=m>0</span>/1     Init:1/3   <span class=m>0</span>          29s
calico-node-7tmnb                          <span class=m>0</span>/1     Init:1/3   <span class=m>0</span>          29s
calico-node-w8nvl                          <span class=m>0</span>/1     Init:1/3   <span class=m>0</span>          29s
</code></pre></div> <p>检查集群的网络状态：</p> <div class=highlight><pre><span></span><code>sudo nerdctl network ls
</code></pre></div> <p>输出结果：</p> <div class=highlight><pre><span></span><code><span class=go>NETWORK ID    NAME               FILE</span>
<span class=go>              k8s-pod-network    /etc/cni/net.d/10-calico.conflist</span>
<span class=go>0             bridge             /etc/cni/net.d/nerdctl-bridge.conflist</span>
<span class=go>              host               </span>
<span class=go>              none </span>
</code></pre></div> <h2 id=_7>检查集群状态<a class=headerlink href=#_7 title="Permanent link"> ¶</a></h2> <p>在主节点上执行命令<code>kubectl cluster-info</code> 可以得到下面的信息：</p> <ul> <li>控制平面（control plane）运行在 <code>https://&lt;mster node ip&gt;:6443</code></li> <li>CoreDNS服务运行在 <code>https://&lt;mster node ip&gt;:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</code></li> </ul> <div class=highlight><pre><span></span><code>kubectl cluster-info
</code></pre></div> <p>查看节点运行状态。此时，所有节点都是<code>Ready</code>的正常状态了。</p> <ul> <li>OS Image: Ubuntu 20.04.4 LTS</li> <li>Kernel Version: 5.4.0-122-generic</li> <li>Container Runtime: containerd://1.5.9</li> </ul> <div class=highlight><pre><span></span><code>kubectl get nodes -owide
</code></pre></div> <p>输出结果：</p> <div class=highlight><pre><span></span><code><span class=go>NAME     STATUS   ROLES           AGE     VERSION</span>
<span class=go>cka001   Ready    control-plane   13m     v1.24.0</span>
<span class=go>cka002   Ready    &lt;none&gt;          8m35s   v1.24.0</span>
<span class=go>cka003   Ready    &lt;none&gt;          8m26s   v1.24.0</span>
</code></pre></div> <p>查看Pods的状态。</p> <div class=highlight><pre><span></span><code>kubectl get pod -A
</code></pre></div> <p>输出结果：</p> <div class=highlight><pre><span></span><code><span class=go>NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span>
<span class=go>kube-system   calico-kube-controllers-555bc4b957-l8bn2   1/1     Running   0          7m18s</span>
<span class=go>kube-system   calico-node-255pc                          1/1     Running   0          7m19s</span>
<span class=go>kube-system   calico-node-7tmnb                          1/1     Running   0          7m19s</span>
<span class=go>kube-system   calico-node-w8nvl                          1/1     Running   0          7m19s</span>
<span class=go>kube-system   coredns-74586cf9b6-4jwmk                   1/1     Running   0          15m</span>
<span class=go>kube-system   coredns-74586cf9b6-c5mll                   1/1     Running   0          15m</span>
<span class=go>kube-system   etcd-cka001                                1/1     Running   0          15m</span>
<span class=go>kube-system   kube-apiserver-cka001                      1/1     Running   0          15m</span>
<span class=go>kube-system   kube-controller-manager-cka001             1/1     Running   0          15m</span>
<span class=go>kube-system   kube-proxy-dmj2t                           1/1     Running   0          15m</span>
<span class=go>kube-system   kube-proxy-n77zw                           1/1     Running   0          11m</span>
<span class=go>kube-system   kube-proxy-qs6rf                           1/1     Running   0          11m</span>
<span class=go>kube-system   kube-scheduler-cka001                      1/1     Running   0          15m</span>
</code></pre></div> <h2 id=_8>更新安装<a class=headerlink href=#_8 title="Permanent link"> ¶</a></h2> <h3 id=bash>Bash自动补全<a class=headerlink href=#bash title="Permanent link"> ¶</a></h3> <p>在每个节点上配置Bash自动补全功能。</p> <p>参考<a href=https://kubernetes.io/docs/tasks/tools/included/optional-kubectl-configs-bash-linux/ >指导</a>设置 <code>kubectl</code> <a href=https://github.com/scop/bash-completion>自动补全功能auto-completion</a>。</p> <div class=highlight><pre><span></span><code>apt install -y bash-completion

<span class=nb>source</span> /usr/share/bash-completion/bash_completion
<span class=nb>source</span> &lt;<span class=o>(</span>kubectl completion bash<span class=o>)</span>

<span class=nb>echo</span> <span class=s2>&quot;source &lt;(kubectl completion bash)&quot;</span> &gt;&gt; ~/.bashrc
<span class=nb>source</span> ~/.bashrc
</code></pre></div> <h3 id=_9>别名<a class=headerlink href=#_9 title="Permanent link"> ¶</a></h3> <p>如果我们为 kubectl 设置一个别名，我们可以通过一些方法来扩展 shell 自动补全功能，使其能够与该别名一起使用。</p> <p>一种方法是在 Bash shell 配置文件（如 .bashrc 或 .bash_profile）中设置别名，并为该别名指定 kubectl 的完整路径。例如，可以在 .bashrc 文件中添加以下内容：</p> <div class=highlight><pre><span></span><code><span class=nb>alias</span> <span class=nv>k</span><span class=o>=</span><span class=s1>&#39;path/to/kubectl&#39;</span>
</code></pre></div> <p>然后，可以使用以下命令重新加载 .bashrc 文件：</p> <div class=highlight><pre><span></span><code><span class=nb>source</span> ~/.bashrc
</code></pre></div> <p>接下来，可以使用<code>k</code>命令来代替<code>kubectl</code>命令，并在其后面添加相应的参数和选项。当使用自动补全功能时，Bash shell 会自动将<code>k</code>别名转换为 <code>kubectl</code> 的完整路径，并对其进行自动补全。</p> <p>另一种方法是使用 Bash shell 内置的 complete 函数来为别名设置自动补全功能。例如，可以在 .bashrc 文件中添加以下内容：</p> <div class=highlight><pre><span></span><code><span class=nb>echo</span> <span class=s1>&#39;alias k=kubectl&#39;</span> &gt;&gt;~/.bashrc
<span class=nb>echo</span> <span class=s1>&#39;complete -o default -F __start_kubectl k&#39;</span> &gt;&gt;~/.bashrc
</code></pre></div> <p>这将为别名<code>k</code>设置自动补全功能，并将其与 kubectl 的自动补全函数<code>__start_kubectl</code>关联起来。这样，当用户在<code>k</code>命令后输入Tab键时，Bash shell 会自动调用<code>__start_kubectl</code>函数，并为用户提供相应的自动补全建议。</p> <h3 id=context>更新默认Context<a class=headerlink href=#context title="Permanent link"> ¶</a></h3> <p>查看当前的 context 列表：</p> <div class=highlight><pre><span></span><code>kubectl config get-contexts 
</code></pre></div> <p>这个命令会列出所有可用的 context 列表，并标记出当前正在使用的 context。</p> <p>类似下面结果：</p> <ul> <li><code>kubernetes-admin@kubernetes</code>是Context名。</li> <li><code>kubernetes</code>是集群名。</li> <li><code>kubernetes-admin</code>是用户名。</li> <li>当前例子中没有指定名称空间。</li> </ul> <div class=highlight><pre><span></span><code><span class=go>CURRENT   NAME                          CLUSTER      AUTHINFO           NAMESPACE</span>
<span class=go>*         kubernetes-admin@kubernetes   kubernetes   kubernetes-admin </span>
</code></pre></div> <p>更新context。例如，更新context的默认名称空间等。</p> <div class=highlight><pre><span></span><code><span class=c1># Usage:</span>
kubectl config set-context &lt;context name&gt; --cluster<span class=o>=</span>&lt;cluster name&gt; --namespace<span class=o>=</span>&lt;namespace name&gt; --user<span class=o>=</span>&lt;user name&gt; 

<span class=c1># Set default namespace</span>
kubectl config set-context kubernetes-admin@kubernetes --cluster<span class=o>=</span>kubernetes --namespace<span class=o>=</span>default --user<span class=o>=</span>kubernetes-admin
</code></pre></div> <p>在不同的context之间切换。</p> <div class=highlight><pre><span></span><code><span class=c1># Usage:</span>
kubectl config use-context &lt;context name&gt;

<span class=c1># Switch to new context</span>
kubectl config use-context kubernetes-admin@kubernetes
</code></pre></div> <p>参考资料：</p> <ul> <li><a href=https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/ >kubectl</a></li> <li>[commandline</li> </ul> <h2 id=_10>重置集群<a class=headerlink href=#_10 title="Permanent link"> ¶</a></h2> <p>注意：下面的操作会重置当前集群（删除集群）。</p> <p>删除集群中所有节点。</p> <div class=highlight><pre><span></span><code>kubeadm reset
</code></pre></div> <p>清除<code>iptables</code>中已定义的规则。</p> <div class=highlight><pre><span></span><code>iptables -F <span class=o>&amp;&amp;</span> iptables -t nat -F <span class=o>&amp;&amp;</span> iptables -t mangle -F <span class=o>&amp;&amp;</span> iptables -X
</code></pre></div> <p>清除<code>IPVS</code>中定义的规则（如果使用<code>IPVS</code>）。</p> <div class=highlight><pre><span></span><code>ipvsadm --clear 
</code></pre></div> <h2 id=_11>排错<a class=headerlink href=#_11 title="Permanent link"> ¶</a></h2> <h3 id=1>错误1<a class=headerlink href=#1 title="Permanent link"> ¶</a></h3> <p>报错信息：</p> <p>The connection to the server <code>&lt;master&gt;:6443</code> was refused - did you specify the right host or port?</p> <p>解决尝试：</p> <p><a href=https://discuss.kubernetes.io/t/the-connection-to-the-server-host-6443-was-refused-did-you-specify-the-right-host-or-port/552/15>Reference</a></p> <p>检查文件kubeconfig的内容和文件路径是否正确。</p> <p>检查环境变量设置。</p> <div class=highlight><pre><span></span><code>env <span class=p>|</span> grep -i kub
</code></pre></div> <p>检查容器运行状态。</p> <div class=highlight><pre><span></span><code>sudo systemctl status containerd.service 
</code></pre></div> <p>检查kubelet服务。</p> <div class=highlight><pre><span></span><code>sudo systemctl status kubelet.service 
</code></pre></div> <p>检查<code>6443</code>端口监听状态。</p> <div class=highlight><pre><span></span><code>netstat -pnlt <span class=p>|</span> grep <span class=m>6443</span>
</code></pre></div> <p>检查防火墙状态。</p> <div class=highlight><pre><span></span><code>sudo systemctl status firewalld.service
</code></pre></div> <p>检查kubelet日志。</p> <div class=highlight><pre><span></span><code>journalctl -xeu kubelet
</code></pre></div> <h3 id=2>错误2<a class=headerlink href=#2 title="Permanent link"> ¶</a></h3> <p>报错信息：</p> <p>"Container runtime network not ready" networkReady="NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: cni plugin not initialized"</p> <p>尝试方法：</p> <p>重启Containerd服务。</p> <div class=highlight><pre><span></span><code>sudo systemctl restart containerd
sudo systemctl status containerd
</code></pre></div> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../multiple-local/ class="md-footer__link md-footer__link--prev" aria-label="Previous: 多节点虚拟机安装Kubernetes" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> 多节点虚拟机安装Kubernetes </div> </div> </a> <a href=../../foundamentals/docker/ class="md-footer__link md-footer__link--next" aria-label="Next: Docker基础" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Docker基础 </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.instant", "navigation.top"], "search": "../../../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../../../assets/javascripts/bundle.2ab50757.min.js></script> </body> </html>