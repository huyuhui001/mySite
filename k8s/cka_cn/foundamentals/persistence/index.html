<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://huyuhui001.github.io/mySite/k8s/cka_cn/foundamentals/persistence/ rel=canonical><link rel=icon href=../../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.3.0, mkdocs-material-7.3.6"><title>Persistence - UPSkilling</title><link rel=stylesheet href=../../../../assets/stylesheets/main.a57b2b03.min.css><link rel=stylesheet href=../../../../assets/stylesheets/palette.3f5d1f46.min.css><meta name=theme-color content=#009485><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style><link rel=stylesheet href=../../../../extra.css></head> <body dir=ltr data-md-color-scheme data-md-color-primary=teal data-md-color-accent=green> <script>function __prefix(e){return new URL("../../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#cka17persistence class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../.. title=UPSkilling class="md-header__button md-logo" aria-label=UPSkilling data-md-component=logo> <img src=../../../../assets/logo.jpg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> UPSkilling </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Persistence </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/huyuhui001/mySite title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> huyuhui001/mySite </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../.. class=md-tabs__link> UPSkilling </a> </li> <li class=md-tabs__item> <a href=../../../../linux/ class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../../ class="md-tabs__link md-tabs__link--active"> Kubernetes </a> </li> <li class=md-tabs__item> <a href=../../../../python/ class=md-tabs__link> Python </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../.. title=UPSkilling class="md-nav__button md-logo" aria-label=UPSkilling data-md-component=logo> <img src=../../../../assets/logo.jpg alt=logo> </a> UPSkilling </label> <div class=md-nav__source> <a href=https://github.com/huyuhui001/mySite title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> huyuhui001/mySite </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1> <label class=md-nav__link for=__nav_1> UPSkilling <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=UPSkilling data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> UPSkilling </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../.. class=md-nav__link> Welcome </a> </li> <li class=md-nav__item> <a href=../../../../about/ class=md-nav__link> About </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Linux <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Linux data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Linux </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../linux/ class=md-nav__link> Index </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_2 type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2> Linux SRE <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Linux SRE" data-md-level=2> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> Linux SRE </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../linux/SRE/01-fundamentals/ class=md-nav__link> 第一章 Linux基础 </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/02-filesystem/ class=md-nav__link> 第二章 文件系统 </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/03-identity-security/ class=md-nav__link> 第三章 身份与安全 </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/04-TextTools/ class=md-nav__link> 第四章 文本编辑 </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/05-RegExpress/ class=md-nav__link> 第五章 正则表达式 </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/06-FileLookup/ class=md-nav__link> 第六章 文件查找 </a> </li> <li class=md-nav__item> <a href=../../../../linux/SRE/07-FilePacking/ class=md-nav__link> 第七章 文件打包和解包 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_3 type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3> SUSE Linux Administration <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="SUSE Linux Administration" data-md-level=2> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> SUSE Linux Administration </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../linux/Administration/01/ class=md-nav__link> Linux File System Overview </a> </li> <li class=md-nav__item> <a href=../../../../linux/Administration/02/ class=md-nav__link> Useful Commands </a> </li> <li class=md-nav__item> <a href=../../../../linux/Administration/03/ class=md-nav__link> Shell </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_4 type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4> SUSE Enterprise Storage Foundation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="SUSE Enterprise Storage Foundation" data-md-level=2> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> SUSE Enterprise Storage Foundation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../linux/SES/linux_ses_memo/ class=md-nav__link> SUSE Enterprise Storage Foundation </a> </li> <li class=md-nav__item> <a href=../../../../linux/SES/linux_ses_demo/ class=md-nav__link> SUSE Enterprise Storage Basic Operation </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3> Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Kubernetes data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../ class=md-nav__link> Index </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2 type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2> CKA Learning Memo <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="CKA Learning Memo" data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> CKA Learning Memo </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_1 type=checkbox id=__nav_3_2_1> <label class=md-nav__link for=__nav_3_2_1> Installation <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Installation data-md-level=3> <label class=md-nav__title for=__nav_3_2_1> <span class="md-nav__icon md-icon"></span> Installation </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_en/installation/single-local/ class=md-nav__link> Single Node Installation </a> </li> <li class=md-nav__item> <a href=../../../cka_en/installation/multiple-local/ class=md-nav__link> Multiple Nodes Installation </a> </li> <li class=md-nav__item> <a href=../../../cka_en/installation/aliyun-ubuntu/ class=md-nav__link> Installation on Aliyun ECS </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_2 type=checkbox id=__nav_3_2_2> <label class=md-nav__link for=__nav_3_2_2> Docker <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Docker data-md-level=3> <label class=md-nav__title for=__nav_3_2_2> <span class="md-nav__icon md-icon"></span> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/docker/ class=md-nav__link> Fundamentals </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_3 type=checkbox id=__nav_3_2_3> <label class=md-nav__link for=__nav_3_2_3> Foundamentals <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Foundamentals data-md-level=3> <label class=md-nav__title for=__nav_3_2_3> <span class="md-nav__icon md-icon"></span> Foundamentals </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/memo/ class=md-nav__link> Memo </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/overview/ class=md-nav__link> Overview </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/basics/ class=md-nav__link> kubectl basics </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_4 type=checkbox id=__nav_3_2_4> <label class=md-nav__link for=__nav_3_2_4> Core Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Core Kubernetes" data-md-level=3> <label class=md-nav__title for=__nav_3_2_4> <span class="md-nav__icon md-icon"></span> Core Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/pod/ class=md-nav__link> Pod </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/deployment/ class=md-nav__link> Deployment </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/service/ class=md-nav__link> Service </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_5 type=checkbox id=__nav_3_2_5> <label class=md-nav__link for=__nav_3_2_5> Application Modeling <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Application Modeling" data-md-level=3> <label class=md-nav__title for=__nav_3_2_5> <span class="md-nav__icon md-icon"></span> Application Modeling </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/namespace/ class=md-nav__link> Namespace </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/statefulset/ class=md-nav__link> StatefulSet </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/daemonset/ class=md-nav__link> DaemonSet </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/job/ class=md-nav__link> Job and Cronjob </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/configuration/ class=md-nav__link> Configuration </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/secrets/ class=md-nav__link> Secrets </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/persistence/ class=md-nav__link> Persistence </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/rbac/ class=md-nav__link> Role Based Access Control (RBAC) </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/ingress/ class=md-nav__link> Ingress </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_6 type=checkbox id=__nav_3_2_6> <label class=md-nav__link for=__nav_3_2_6> Advanced Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Advanced Kubernetes" data-md-level=3> <label class=md-nav__title for=__nav_3_2_6> <span class="md-nav__icon md-icon"></span> Advanced Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/scheduling/ class=md-nav__link> Scheduling </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/hpa/ class=md-nav__link> Horizontal Pod Autoscaling </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/policy/ class=md-nav__link> Policy </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/networkpolicy/ class=md-nav__link> Network Policy </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/clustermgt/ class=md-nav__link> Cluster Management </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_7 type=checkbox id=__nav_3_2_7> <label class=md-nav__link for=__nav_3_2_7> Operating Kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Operating Kubernetes" data-md-level=3> <label class=md-nav__title for=__nav_3_2_7> <span class="md-nav__icon md-icon"></span> Operating Kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/troubleshooting/ class=md-nav__link> Troubleshooting </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/healthcheck/ class=md-nav__link> Health Check </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/helming/ class=md-nav__link> Helming </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_2_8 type=checkbox id=__nav_3_2_8> <label class=md-nav__link for=__nav_3_2_8> Topics <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Topics data-md-level=3> <label class=md-nav__title for=__nav_3_2_8> <span class="md-nav__icon md-icon"></span> Topics </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/casestudy-operation-resources/ class=md-nav__link> Operations on Resources </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/casestudy-health-check/ class=md-nav__link> Health Check </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/casestudy-calico/ class=md-nav__link> Calico Installation </a> </li> <li class=md-nav__item> <a href=../../../cka_en/foundamentals/kyma/ class=md-nav__link> Kyma </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3 type=checkbox id=__nav_3_3 checked> <label class=md-nav__link for=__nav_3_3> CKA学习笔记 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=CKA学习笔记 data-md-level=2> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> CKA学习笔记 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_1 type=checkbox id=__nav_3_3_1> <label class=md-nav__link for=__nav_3_3_1> 安装 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=安装 data-md-level=3> <label class=md-nav__title for=__nav_3_3_1> <span class="md-nav__icon md-icon"></span> 安装 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../installation/single-local/ class=md-nav__link> 单节点虚拟机安装Kubernetes </a> </li> <li class=md-nav__item> <a href=../../installation/multiple-local/ class=md-nav__link> 多节点虚拟机安装Kubernetes </a> </li> <li class=md-nav__item> <a href=../../installation/aliyun-ubuntu/ class=md-nav__link> 阿里云ECS安装Kubernetes </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_2 type=checkbox id=__nav_3_3_2> <label class=md-nav__link for=__nav_3_3_2> Docker <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Docker data-md-level=3> <label class=md-nav__title for=__nav_3_3_2> <span class="md-nav__icon md-icon"></span> Docker </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../docker/ class=md-nav__link> Docker基础 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_3 type=checkbox id=__nav_3_3_3> <label class=md-nav__link for=__nav_3_3_3> 基础知识 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=基础知识 data-md-level=3> <label class=md-nav__title for=__nav_3_3_3> <span class="md-nav__icon md-icon"></span> 基础知识 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../memo/ class=md-nav__link> Kubernetes随笔 </a> </li> <li class=md-nav__item> <a href=../overview/ class=md-nav__link> Kubernetes集群概览 </a> </li> <li class=md-nav__item> <a href=../basics/ class=md-nav__link> kubectl基础 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_4 type=checkbox id=__nav_3_3_4> <label class=md-nav__link for=__nav_3_3_4> 核心概念 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=核心概念 data-md-level=3> <label class=md-nav__title for=__nav_3_3_4> <span class="md-nav__icon md-icon"></span> 核心概念 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../pod/ class=md-nav__link> Pod </a> </li> <li class=md-nav__item> <a href=../deployment/ class=md-nav__link> Deployment </a> </li> <li class=md-nav__item> <a href=../service/ class=md-nav__link> Service </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_5 type=checkbox id=__nav_3_3_5 checked> <label class=md-nav__link for=__nav_3_3_5> 应用体系 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=应用体系 data-md-level=3> <label class=md-nav__title for=__nav_3_3_5> <span class="md-nav__icon md-icon"></span> 应用体系 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../namespace/ class=md-nav__link> Namespace </a> </li> <li class=md-nav__item> <a href=../statefulset/ class=md-nav__link> StatefulSet </a> </li> <li class=md-nav__item> <a href=../daemonset/ class=md-nav__link> DaemonSet </a> </li> <li class=md-nav__item> <a href=../job/ class=md-nav__link> Job and Cronjob </a> </li> <li class=md-nav__item> <a href=../configuration/ class=md-nav__link> Configuration </a> </li> <li class=md-nav__item> <a href=../secrets/ class=md-nav__link> secrets </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Persistence <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Persistence </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 摘要 </a> </li> <li class=md-nav__item> <a href=#emptydir class=md-nav__link> emptyDir </a> </li> <li class=md-nav__item> <a href=#hostpath class=md-nav__link> hostPath </a> </li> <li class=md-nav__item> <a href=#pvpvc class=md-nav__link> PV和PVC </a> <nav class=md-nav aria-label=PV和PVC> <ul class=md-nav__list> <li class=md-nav__item> <a href=#nfs class=md-nav__link> 设置NFS共享 </a> </li> <li class=md-nav__item> <a href=#pv class=md-nav__link> 创建 PV </a> </li> <li class=md-nav__item> <a href=#pvc class=md-nav__link> 创建 PVC </a> </li> <li class=md-nav__item> <a href=#pvc_1 class=md-nav__link> 消费 PVC </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#storageclass class=md-nav__link> StorageClass </a> <nav class=md-nav aria-label=StorageClass> <ul class=md-nav__list> <li class=md-nav__item> <a href=#rbac class=md-nav__link> 配置RBAC权限 </a> </li> <li class=md-nav__item> <a href=#provisionerdeloyment class=md-nav__link> 创建Provisioner的Deloyment </a> </li> <li class=md-nav__item> <a href=#nfs-storageclass class=md-nav__link> 创建 NFS StorageClass </a> </li> <li class=md-nav__item> <a href=#pvc_2 class=md-nav__link> 创建PVC </a> </li> <li class=md-nav__item> <a href=#pvc_3 class=md-nav__link> 消费PVC </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configuration class=md-nav__link> 配置Configuration </a> <nav class=md-nav aria-label=配置Configuration> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configmap class=md-nav__link> ConfigMap </a> </li> <li class=md-nav__item> <a href=#secret class=md-nav__link> Secret </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 拓展案例 </a> <nav class=md-nav aria-label=拓展案例> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configmap_1 class=md-nav__link> 多种方法创建ConfigMap </a> </li> <li class=md-nav__item> <a href=#configmap_2 class=md-nav__link> 通过ConfigMap设定环境变量 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../rbac/ class=md-nav__link> RBAC鉴权 </a> </li> <li class=md-nav__item> <a href=../ingress/ class=md-nav__link> Ingress-nginx </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_6 type=checkbox id=__nav_3_3_6> <label class=md-nav__link for=__nav_3_3_6> 进阶概念 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=进阶概念 data-md-level=3> <label class=md-nav__title for=__nav_3_3_6> <span class="md-nav__icon md-icon"></span> 进阶概念 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../scheduling/ class=md-nav__link> Scheduling </a> </li> <li class=md-nav__item> <a href=../hpa/ class=md-nav__link> Horizontal Pod Autoscaling (HPA) </a> </li> <li class=md-nav__item> <a href=../policy/ class=md-nav__link> Policy </a> </li> <li class=md-nav__item> <a href=../networkpolicy/ class=md-nav__link> Network Policy </a> </li> <li class=md-nav__item> <a href=../clustermgt/ class=md-nav__link> Cluster Management </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_7 type=checkbox id=__nav_3_3_7> <label class=md-nav__link for=__nav_3_3_7> 日常维护 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=日常维护 data-md-level=3> <label class=md-nav__title for=__nav_3_3_7> <span class="md-nav__icon md-icon"></span> 日常维护 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../troubleshooting/ class=md-nav__link> Troubleshooting </a> </li> <li class=md-nav__item> <a href=../healthcheck/ class=md-nav__link> 健康检查 </a> </li> <li class=md-nav__item> <a href=../helming/ class=md-nav__link> Helm Chart </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3_8 type=checkbox id=__nav_3_3_8> <label class=md-nav__link for=__nav_3_3_8> 主题讨论 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=主题讨论 data-md-level=3> <label class=md-nav__title for=__nav_3_3_8> <span class="md-nav__icon md-icon"></span> 主题讨论 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../casestudy-operation-resources/ class=md-nav__link> Kubernetes资源常见操作 </a> </li> <li class=md-nav__item> <a href=../casestudy-health-check/ class=md-nav__link> 健康检查 </a> </li> <li class=md-nav__item> <a href=../casestudy-calico/ class=md-nav__link> 安装Calico </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_4 type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4> Demos <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Demos data-md-level=2> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Demos </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../demo/cap_on_kyma/ class=md-nav__link> Build CAP Application on Kyma </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Python <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Python data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Python </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../python/ class=md-nav__link> Index </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2 type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2> Python基础 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Python基础 data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Python基础 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../python/Foundation/ch00/ class=md-nav__link> Python安装 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/ch01/ class=md-nav__link> Python语言基础 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/ch02/ class=md-nav__link> Python打包和解包 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/ch03/ class=md-nav__link> Python内置函数及文件 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/ch04/ class=md-nav__link> Python面向对象概念 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/ch05/ class=md-nav__link> Python面向对象三大特性 </a> </li> <li class=md-nav__item> <a href=../../../../python/Foundation/Algorithms/ class=md-nav__link> Python数据结构和算法 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3 type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3> Python数据分析基础 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Python数据分析基础 data-md-level=2> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> Python数据分析基础 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch01/ class=md-nav__link> NumPy基础 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch10/ class=md-nav__link> NumPy进阶 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch02/ class=md-nav__link> Pandas入门 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch03/ class=md-nav__link> 数据载入、存储及文件格式 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch04/ class=md-nav__link> 数据清洗与准备 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch05/ class=md-nav__link> 数据规整：连接、联合与重塑 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch06/ class=md-nav__link> 绘图与可视化 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch07/ class=md-nav__link> 数据聚合与分组操作 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch08/ class=md-nav__link> 时间序列 </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch09/ class=md-nav__link> 高阶pandas </a> </li> <li class=md-nav__item> <a href=../../../../python/DataAnalysis/ch11/ class=md-nav__link> Python建模库介绍 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4 type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4> Demos <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Demos data-md-level=2> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Demos </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../python/Demo/CourseSystem/ class=md-nav__link> 选课系统 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 摘要 </a> </li> <li class=md-nav__item> <a href=#emptydir class=md-nav__link> emptyDir </a> </li> <li class=md-nav__item> <a href=#hostpath class=md-nav__link> hostPath </a> </li> <li class=md-nav__item> <a href=#pvpvc class=md-nav__link> PV和PVC </a> <nav class=md-nav aria-label=PV和PVC> <ul class=md-nav__list> <li class=md-nav__item> <a href=#nfs class=md-nav__link> 设置NFS共享 </a> </li> <li class=md-nav__item> <a href=#pv class=md-nav__link> 创建 PV </a> </li> <li class=md-nav__item> <a href=#pvc class=md-nav__link> 创建 PVC </a> </li> <li class=md-nav__item> <a href=#pvc_1 class=md-nav__link> 消费 PVC </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#storageclass class=md-nav__link> StorageClass </a> <nav class=md-nav aria-label=StorageClass> <ul class=md-nav__list> <li class=md-nav__item> <a href=#rbac class=md-nav__link> 配置RBAC权限 </a> </li> <li class=md-nav__item> <a href=#provisionerdeloyment class=md-nav__link> 创建Provisioner的Deloyment </a> </li> <li class=md-nav__item> <a href=#nfs-storageclass class=md-nav__link> 创建 NFS StorageClass </a> </li> <li class=md-nav__item> <a href=#pvc_2 class=md-nav__link> 创建PVC </a> </li> <li class=md-nav__item> <a href=#pvc_3 class=md-nav__link> 消费PVC </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configuration class=md-nav__link> 配置Configuration </a> <nav class=md-nav aria-label=配置Configuration> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configmap class=md-nav__link> ConfigMap </a> </li> <li class=md-nav__item> <a href=#secret class=md-nav__link> Secret </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 拓展案例 </a> <nav class=md-nav aria-label=拓展案例> <ul class=md-nav__list> <li class=md-nav__item> <a href=#configmap_1 class=md-nav__link> 多种方法创建ConfigMap </a> </li> <li class=md-nav__item> <a href=#configmap_2 class=md-nav__link> 通过ConfigMap设定环境变量 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/huyuhui001/mySite/edit/main/docs/k8s/cka_cn/foundamentals/persistence.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1 id=cka17persistence>CKA自学笔记17:Persistence<a class=headerlink href=#cka17persistence title="Permanent link"> ¶</a></h1> <h2 id=_1>摘要<a class=headerlink href=#_1 title="Permanent link"> ¶</a></h2> <p>演示场景：</p> <ul> <li>创建一个类型为 <code>emptyDir</code> 的卷来创建 Pod，Pod 中的容器将会挂载在运行节点上的默认目录 <code>/var/lib/kubelet/pods/</code> 中。</li> <li>创建一个类型为 <code>hostPath</code> 的卷来创建 Deployment，Deployment 中的容器将会挂载在运行节点上定义的目录 <code>hostPath:</code> 中。</li> <li>创建 PV 和 PVC：</li> <li>设置 NFS 服务器并共享 <code>/nfsdata/</code> 目录。</li> <li>创建 PV <code>mysql-pv</code> 并映射到共享目录 <code>/nfsdata/</code>，同时设置 StorageClassName 为 <code>nfs</code>。</li> <li>创建 PVC <code>mysql-pvc</code> 并映射到 StorageClassName 为 <code>nfs</code> 的 PV 上。</li> <li>创建 Deployment <code>mysql</code> 来使用 PVC <code>mysql-pvc</code>。</li> <li>创建 StorageClass：</li> <li>创建 ServiceAccount <code>nfs-client-provisioner</code>。</li> <li>创建 ClusterRole <code>nfs-client-provisioner-runner</code> 和 Role <code>leader-locking-nfs-client-provisioner</code>，并将其绑定到 ServiceAccount 上，以便该 ServiceAccount 可以操作下一步中创建的 Deployment。</li> <li>创建 Deployment <code>nfs-client-provisioner</code> 来添加连接到 NFS 服务器的信息，例如 <code>PROVISIONER_NAME</code> 是 <code>k8s-sigs.io/nfs-subdir-external-provisioner</code>。</li> <li>创建 StorageClass <code>nfs-client</code> 并链接到 <code>provisioner: k8s-sigs.io/nfs-subdir-external-provisioner</code>，相关的 PV 会自动创建。</li> <li>创建 PVC <code>nfs-pvc-from-sc</code> 并映射到 StorageClass <code>nfs-client</code> 上的 PV。</li> <li>配置Configuration：</li> <li>创建一个 ConfigMap 以包含文件的内容，并将此 ConfigMap 挂载到 Pod 中的特定文件中。</li> <li>创建一个 ConfigMap 来包含用户名和密码，并在 Pod 中使用它们。</li> <li>在 Pod 中将 ConfigMap 用作环境变量。</li> </ul> <p>建议：</p> <ul> <li>首先删除 PVC，然后再删除 PV。</li> <li>如果删除 PVC 时遇到 <code>Terminating</code> 状态，使用 <code>kubectl edit pvc &lt;your_pvc_name&gt;</code> 命令，然后删除 <code>finalize: &lt;your_value&gt;</code>。</li> </ul> <h2 id=emptydir>emptyDir<a class=headerlink href=#emptydir title="Permanent link"> ¶</a></h2> <p>创建一个名为 <code>hello-producer</code> 的 Pod，并使用 <code>emptyDir</code> 类型的 Volume。</p> <div class=highlight><pre><span></span><code>cat<span class=w> </span>&gt;<span class=w> </span>pod-emptydir.yaml<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<span class=s>apiVersion: v1</span>
<span class=s>kind: Pod</span>
<span class=s>metadata:</span>
<span class=s> name: hello-producer</span>
<span class=s>spec:</span>
<span class=s> containers:</span>
<span class=s> - image: busybox</span>
<span class=s>   name: producer</span>
<span class=s>   volumeMounts:</span>
<span class=s>   - mountPath: /producer_dir</span>
<span class=s>     name: shared-volume</span>
<span class=s>   args:</span>
<span class=s>   - /bin/sh</span>
<span class=s>   - -c</span>
<span class=s>   - echo &quot;hello world&quot; &gt; /producer_dir/hello; sleep 30000</span>
<span class=s> volumes:</span>
<span class=s> - name: shared-volume</span>
<span class=s>   emptyDir: {}</span>
<span class=s>EOF</span>

kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>pod-emptydir.yaml
</code></pre></div> <p>查看Pod <code>hello-producer</code>的状态。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>pod<span class=w> </span>hello-producer<span class=w> </span>-owide
</code></pre></div> <p>Pod <code>hello-producer</code> 运行在节点node <code>cka003</code>上。</p> <div class=highlight><pre><span></span><code><span class=go>NAME             READY   STATUS    RESTARTS   AGE   IP              NODE     NOMINATED NODE   READINESS GATES</span>
<span class=go>hello-producer   1/1     Running   0          6s    10.244.102.24   cka003   &lt;none&gt;           &lt;none&gt;</span>
</code></pre></div> <p>登录 <code>cka003</code>，因为 Pod <code>hello-producer</code> 正在该节点上运行。</p> <p>为 <code>crictl</code> 命令设置环境变量 <code>CONTAINER_RUNTIME_ENDPOINT</code>。建议在所有节点上执行相同的操作。</p> <div class=highlight><pre><span></span><code><span class=nb>export</span><span class=w> </span><span class=nv>CONTAINER_RUNTIME_ENDPOINT</span><span class=o>=</span>unix:///run/containerd/containerd.sock
</code></pre></div> <p>运行命令 <code>crictl ps</code> 来获取 Pod <code>hello-producer</code> 的容器 ID。</p> <div class=highlight><pre><span></span><code>crictl<span class=w> </span>ps<span class=w> </span><span class=p>|</span>grep<span class=w> </span>hello-producer
</code></pre></div> <p>容器 <code>producer</code> 的ID是 <code>05f5e1bb6a1bb</code>。</p> <div class=highlight><pre><span></span><code><span class=go>CONTAINER           IMAGE               CREATED             STATE               NAME                ATTEMPT             POD ID              POD</span>
<span class=go>50058afb3cba5       62aedd01bd852       About an hour ago   Running             producer            0                   e6953bd4833a7       hello-producer</span>
</code></pre></div> <p>运行命令 <code>crictl inspect</code>，获取已挂载的 <code>shared-volume</code> 的路径，它是 <code>emptyDir</code> 类型的。</p> <div class=highlight><pre><span></span><code>crictl<span class=w> </span>inspect<span class=w> </span>50058afb3cba5<span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span><span class=nb>source</span><span class=w> </span><span class=p>|</span><span class=w> </span>grep<span class=w> </span>empty
</code></pre></div> <p>运行结果</p> <div class=highlight><pre><span></span><code><span class=go>&quot;source&quot;: &quot;/var/lib/kubelet/pods/d7424f86-534a-48f9-9001-9d2a6e822b12/volumes/kubernetes.io~empty-dir/shared-volume&quot;,</span>
</code></pre></div> <p>修改路径为上面获取到的 <code>shared-volume</code> 的挂载路径。然后我们会看到文件 <code>hello</code> 中的内容 <code>hello world</code>。</p> <div class=highlight><pre><span></span><code><span class=nb>cd</span><span class=w> </span>/var/lib/kubelet/pods/d7424f86-534a-48f9-9001-9d2a6e822b12/volumes/kubernetes.io~empty-dir/shared-volume
cat<span class=w> </span>hello
</code></pre></div> <p>Pod内的路径<code>/producer_dir</code>被挂载到了本地宿主机路径<code>/var/lib/kubelet/pods/d7424f86-534a-48f9-9001-9d2a6e822b12/volumes/kubernetes.io~empty-dir/shared-volume</code>。</p> <p>我们在Pod内创建的文件<code>/producer_dir/hello</code>实际上在宿主机本地路径中。</p> <p>让我们删除容器<code>producer</code>，容器<code>producer</code>将以新的容器ID重新启动，而文件<code>hello</code>仍将存在。</p> <div class=highlight><pre><span></span><code>crictl<span class=w> </span>ps
crictl<span class=w> </span>stop<span class=w> </span>&lt;your_container_id&gt;
crictl<span class=w> </span>rm<span class=w> </span>&lt;your_container_id&gt;
</code></pre></div> <p>现在删除Pod <code>hello-producer</code>，容器<code>producer</code>会被删除，文件<code>hello</code>也会被删除。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>delete<span class=w> </span>pod<span class=w> </span>hello-producer<span class=w> </span>
</code></pre></div> <h2 id=hostpath>hostPath<a class=headerlink href=#hostpath title="Permanent link"> ¶</a></h2> <p>应用以下 yaml 文件创建一个 MySQL Pod 并挂载一个 <code>hostPath</code>。 将主机目录 <code>/tmp/mysql</code> 挂载到 Pod 目录 <code>/var/lib/mysql</code>。 在本地检查是否存在目录 <code>/tmp/mysql</code>，如果不存在，则执行命令 <code>mkdir /tmp/mysql</code> 创建它。</p> <div class=highlight><pre><span></span><code>cat<span class=w> </span>&gt;<span class=w> </span>mysql-hostpath.yaml<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<span class=s>apiVersion: apps/v1</span>
<span class=s>kind: Deployment</span>
<span class=s>metadata:</span>
<span class=s> name: mysql</span>
<span class=s>spec:</span>
<span class=s> selector:</span>
<span class=s>   matchLabels:</span>
<span class=s>     app: mysql</span>
<span class=s> template:</span>
<span class=s>   metadata:</span>
<span class=s>     labels:</span>
<span class=s>       app: mysql</span>
<span class=s>   spec:</span>
<span class=s>     containers:</span>
<span class=s>     - image: mysql:8.0</span>
<span class=s>       name: mysql</span>
<span class=s>       env:</span>
<span class=s>       - name: MYSQL_ROOT_PASSWORD</span>
<span class=s>         value: password</span>
<span class=s>       ports:</span>
<span class=s>       - containerPort: 3306</span>
<span class=s>         name: mysql</span>
<span class=s>       volumeMounts:</span>
<span class=s>       - name: mysql-vol</span>
<span class=s>         mountPath: /var/lib/mysql</span>
<span class=s>     volumes:</span>
<span class=s>     - hostPath:</span>
<span class=s>         path: /tmp/mysql</span>
<span class=s>       name: mysql-vol</span>
<span class=s>EOF</span>

kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>mysql-hostpath.yaml
</code></pre></div> <p>验证 MySQL 可用性。</p> <p>检查 MySQL Pod 的状态。需要记录 Pod 的名称和其所运行的节点。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>pod<span class=w> </span>-l<span class=w> </span><span class=nv>app</span><span class=o>=</span>mysql<span class=w> </span>-o<span class=w> </span>wide
</code></pre></div> <p>运行结果</p> <div class=highlight><pre><span></span><code><span class=go>NAME                     READY   STATUS              RESTARTS   AGE   IP       NODE     NOMINATED NODE   READINESS GATES</span>
<span class=go>mysql-749c8ddd67-h2rgs   0/1     ContainerCreating   0          28s   &lt;none&gt;   cka003   &lt;none&gt;           &lt;none&gt;</span>
</code></pre></div> <p>在MySQL Pod运行的节点登陆进入pod内部。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span>&lt;your_pod_name&gt;<span class=w> </span>--<span class=w> </span>bash
</code></pre></div> <p>在 Pod 中，进入 <code>/var/lib/mysql</code> 目录，该目录中的所有文件都与节点 <code>cka003</code> 上 <code>/tmp/mysql</code> 目录中的所有文件相同。</p> <p>连接到 Pod 中的数据库。</p> <div class=highlight><pre><span></span><code>mysql<span class=w> </span>-h<span class=w> </span><span class=m>127</span>.0.0.1<span class=w> </span>-uroot<span class=w> </span>-ppassword
</code></pre></div> <p>执行下面命令对数据库进行简单的操作。</p> <div class=highlight><pre><span></span><code>mysql&gt;<span class=w> </span>show<span class=w> </span>databases<span class=p>;</span>
mysql&gt;<span class=w> </span>connect<span class=w> </span>mysql<span class=p>;</span>
mysql&gt;<span class=w> </span>show<span class=w> </span>tables<span class=p>;</span>
mysql&gt;<span class=w> </span><span class=nb>exit</span>
</code></pre></div> <h2 id=pvpvc>PV和PVC<a class=headerlink href=#pvpvc title="Permanent link"> ¶</a></h2> <p>下面的演示中，我们将使用NFS作为后端存储来演示如何部署PV和PVC。</p> <h3 id=nfs>设置NFS共享<a class=headerlink href=#nfs title="Permanent link"> ¶</a></h3> <ol> <li>安装nfs-kernel-server</li> </ol> <p>登录到节点<code>cka002</code>。配置Worker <code>cka002</code>成为NFS服务器。</p> <div class=highlight><pre><span></span><code>sudo<span class=w> </span>apt-get<span class=w> </span>install<span class=w> </span>-y<span class=w> </span>nfs-kernel-server
</code></pre></div> <p>2.配置共享目录</p> <p>创建共享文件夹。 </p> <div class=highlight><pre><span></span><code>mkdir<span class=w> </span>/nfsdata
</code></pre></div> <p>编辑文件<code>/etc/exports</code>，添加一行<code>/nfsdata *(rw,sync,no_root_squash)</code>。</p> <div class=highlight><pre><span></span><code>cat<span class=w> </span>&gt;&gt;<span class=w> </span>/etc/exports<span class=w> </span><span class=s>&lt;&lt; EOF</span>
<span class=s>/nfsdata *(rw,sync,no_root_squash)</span>
<span class=s>EOF</span>
</code></pre></div> <p>有许多不同的NFS共享选项，例如：</p> <ul> <li><code>*</code>：对所有IP或特定IP可访问。</li> <li><code>rw</code>：作为读写共享。请注意，正常的Linux权限仍然适用。（请注意，这是默认选项。）</li> <li><code>ro</code>：作为只读共享。</li> <li><code>sync</code>：文件数据更改会立即写入磁盘，这会影响性能，但不太可能导致数据丢失。在某些发行版上，这是默认选项。</li> <li><code>async</code>：与sync相反，文件数据更改最初写入内存。这提高了性能，但更容易导致数据丢失。在某些发行版上，这是默认选项。</li> <li><code>root_squash</code>：将NFS客户端的root用户和组帐户映射到匿名帐户，通常是nobody帐户或nfsnobody帐户。有关更多详细信息，请参见本文后续的“用户ID映射”。（请注意，这是默认选项。）</li> <li><code>no_root_squash</code>：将NFS客户端的root用户和组帐户映射到本地root和组帐户。</li> </ul> <p>我们将使用基于Linux服务器之间的<code>nfs</code>和<code>rpcbind</code>服务的无密码远程挂载，而不是基于<code>smb</code>服务。首先，这两台服务器必须授权、安装并设置nfs和rpcbind服务，设置共享目录，启动服务，并在客户端上进行挂载。</p> <p>启动<code>rpcbind</code>服务。</p> <div class=highlight><pre><span></span><code>sudo<span class=w> </span>systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>rpcbind
sudo<span class=w> </span>systemctl<span class=w> </span>restart<span class=w> </span>rpcbind
</code></pre></div> <p>启动<code>nfs</code>服务。</p> <div class=highlight><pre><span></span><code>sudo<span class=w> </span>systemctl<span class=w> </span><span class=nb>enable</span><span class=w> </span>nfs-server
sudo<span class=w> </span>systemctl<span class=w> </span>start<span class=w> </span>nfs-server
</code></pre></div> <p>如果<code>/etc/exports</code>文件被修改，我们需要运行下面的命令使之生效。</p> <div class=highlight><pre><span></span><code>exportfs<span class=w> </span>-ra
</code></pre></div> <p>运行结果</p> <div class=highlight><pre><span></span><code>exportfs:<span class=w> </span>/etc/exports<span class=w> </span><span class=o>[</span><span class=m>1</span><span class=o>]</span>:<span class=w> </span>Neither<span class=w> </span><span class=s1>&#39;subtree_check&#39;</span><span class=w> </span>or<span class=w> </span><span class=s1>&#39;no_subtree_check&#39;</span><span class=w> </span>specified<span class=w> </span><span class=k>for</span><span class=w> </span><span class=nb>export</span><span class=w> </span><span class=s2>&quot;*:/nfsdata&quot;</span>.
<span class=w>  </span>Assuming<span class=w> </span>default<span class=w> </span>behaviour<span class=w> </span><span class=o>(</span><span class=s1>&#39;no_subtree_check&#39;</span><span class=o>)</span>.
<span class=w>  </span>NOTE:<span class=w> </span>this<span class=w> </span>default<span class=w> </span>has<span class=w> </span>changed<span class=w> </span>since<span class=w> </span>nfs-utils<span class=w> </span>version<span class=w> </span><span class=m>1</span>.0.x
</code></pre></div> <p>检查共享目录是否已经被正确配置了。</p> <div class=highlight><pre><span></span><code>showmount<span class=w> </span>-e
</code></pre></div> <p>如果看到下面的结果，则说明共享目录已经被正确配置了。</p> <div class=highlight><pre><span></span><code><span class=go>Export list for cka002:</span>
<span class=go>/nfsdata *</span>
</code></pre></div> <p>3.安装NFS客户端</p> <p>在所有节点上安装NFS客户端。</p> <div class=highlight><pre><span></span><code>sudo<span class=w> </span>apt-get<span class=w> </span>install<span class=w> </span>-y<span class=w> </span>nfs-common
</code></pre></div> <p>4.验证NFS服务</p> <p>登录到任何一个节点来验证NFS服务是否正确工作，以及NFS服务所共享到目录是否可见。 登陆到<code>cka001</code>，并检查<code>cka002</code>的共享目录状态。</p> <div class=highlight><pre><span></span><code>showmount<span class=w> </span>-e<span class=w> </span>cka002
</code></pre></div> <p>如果得到类似下面的结果，则说明NFS服务正常工作，包括共享目录。</p> <div class=highlight><pre><span></span><code>Export<span class=w> </span>list<span class=w> </span><span class=k>for</span><span class=w> </span>cka002:
/nfsdata<span class=w> </span>*
</code></pre></div> <p>5.挂载NFS共享目录</p> <p>执行下面命令，挂载NFS共享目录到任何一个非NFS服务器节点，比如<code>cka001</code> or <code>cka003</code>。</p> <div class=highlight><pre><span></span><code>mkdir<span class=w> </span>/remote-nfs-dir
mount<span class=w> </span>-t<span class=w> </span>nfs<span class=w> </span>cka002:/nfsdata<span class=w> </span>/remote-nfs-dir/
</code></pre></div> <p>执行命令<code>df -h</code>来检查NFS挂载点是否正确，类似下面的结果。</p> <div class=highlight><pre><span></span><code>Filesystem<span class=w>       </span>Size<span class=w>  </span>Used<span class=w> </span>Avail<span class=w> </span>Use%<span class=w> </span>Mounted<span class=w> </span>on
cka002:/nfsdata<span class=w>   </span>40G<span class=w>  </span><span class=m>5</span>.8G<span class=w>   </span>32G<span class=w>  </span><span class=m>16</span>%<span class=w> </span>/remote-nfs-dir
</code></pre></div> <h3 id=pv>创建 PV<a class=headerlink href=#pv title="Permanent link"> ¶</a></h3> <p>创建一个 PV <code>mysql-pv</code>。 将 NFS 服务器 IP 替换为实际的 IP（这里是 <code>&lt;cka002_ip&gt;</code>），它是运行 NFS 服务器 <code>cka002</code> 的 IP。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<span class=s>apiVersion: v1</span>
<span class=s>kind: PersistentVolume</span>
<span class=s>metadata:</span>
<span class=s> name: mysql-pv</span>
<span class=s>spec:</span>
<span class=s> accessModes:</span>
<span class=s>     - ReadWriteOnce</span>
<span class=s> capacity:</span>
<span class=s>   storage: 1Gi</span>
<span class=s> persistentVolumeReclaimPolicy: Retain</span>
<span class=s> storageClassName: nfs</span>
<span class=s> nfs:</span>
<span class=s>   path: /nfsdata/</span>
<span class=s>   server: &lt;cka002_ip&gt;</span>
<span class=s>EOF</span>
</code></pre></div> <p>执行下面的命令，检查创建的PV。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>pv
</code></pre></div> <p>运行结果</p> <div class=highlight><pre><span></span><code>NAME<span class=w>       </span>CAPACITY<span class=w>   </span>ACCESS<span class=w> </span>MODES<span class=w>   </span>RECLAIM<span class=w> </span>POLICY<span class=w>   </span>STATUS<span class=w>      </span>CLAIM<span class=w>   </span>STORAGECLASS<span class=w>   </span>REASON<span class=w>   </span>AGE
mysql-pv<span class=w>   </span>1Gi<span class=w>        </span>RWO<span class=w>            </span>Retain<span class=w>           </span>Available<span class=w>           </span>nfs<span class=w>                     </span>19s
</code></pre></div> <h3 id=pvc>创建 PVC<a class=headerlink href=#pvc title="Permanent link"> ¶</a></h3> <p>创建 PVC <code>mysql-pvc</code> 并指定存储大小、访问模式和存储类。 PVC <code>mysql-pvc</code> 将通过存储类名称自动与 PV 绑定。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<span class=s>apiVersion: v1</span>
<span class=s>kind: PersistentVolumeClaim</span>
<span class=s>metadata:</span>
<span class=s>  name: mysql-pvc</span>
<span class=s>spec:</span>
<span class=s>  accessModes:</span>
<span class=s>    - ReadWriteOnce</span>
<span class=s>  resources:</span>
<span class=s>    requests:</span>
<span class=s>      storage: 1Gi</span>
<span class=s>  storageClassName: nfs</span>
<span class=s>EOF</span>
</code></pre></div> <h3 id=pvc_1>消费 PVC<a class=headerlink href=#pvc_1 title="Permanent link"> ¶</a></h3> <p>更新Deployment <code>mysql</code> 来使用之前创建的PVC <code>mysql-pvc</code>。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<span class=s>apiVersion: apps/v1</span>
<span class=s>kind: Deployment</span>
<span class=s>metadata:</span>
<span class=s> name: mysql</span>
<span class=s>spec:</span>
<span class=s> selector:</span>
<span class=s>   matchLabels:</span>
<span class=s>     app: mysql</span>
<span class=s> template:</span>
<span class=s>   metadata:</span>
<span class=s>     labels:</span>
<span class=s>       app: mysql</span>
<span class=s>   spec:</span>
<span class=s>     containers:</span>
<span class=s>     - image: mysql:8.0</span>
<span class=s>       name: mysql</span>
<span class=s>       env:</span>
<span class=s>       - name: MYSQL_ROOT_PASSWORD</span>
<span class=s>         value: password</span>
<span class=s>       ports:</span>
<span class=s>       - containerPort: 3306</span>
<span class=s>         name: mysql</span>
<span class=s>       volumeMounts:</span>
<span class=s>       - name: mysql-persistent-storage</span>
<span class=s>         mountPath: /var/lib/mysql</span>
<span class=s>         subPath: mysqldata</span>
<span class=s>     volumes:</span>
<span class=s>     - name: mysql-persistent-storage</span>
<span class=s>       persistentVolumeClaim:</span>
<span class=s>        claimName: mysql-pvc</span>
<span class=s>EOF</span>
</code></pre></div> <p>现在我们可以看到 MySQL 文件已经移动到了 <code>cka002</code> 的 <code>/nfsdata</code> 目录下。</p> <h2 id=storageclass>StorageClass<a class=headerlink href=#storageclass title="Permanent link"> ¶</a></h2> <h3 id=rbac>配置RBAC权限<a class=headerlink href=#rbac title="Permanent link"> ¶</a></h3> <p>RBAC（Role-Based Access Control，基于角色的访问控制）是 Kubernetes 中的一种授权机制，用于限制用户对资源的访问权限。 我们可以为 Kubernetes 集群中的用户分配不同的角色，以限制他们在集群中的操作。</p> <p>要配置 RBAC 授权，需要执行以下步骤：</p> <ol> <li>为用户创建帐户</li> <li>为帐户创建角色</li> <li>为角色授予权限</li> <li>将角色绑定到帐户</li> </ol> <p>这些步骤中的每一步都需要创建 Kubernetes 对象，例如 <code>ServiceAccount</code>、<code>Role</code>、<code>ClusterRole</code>、<code>RoleBinding</code> 和 <code>ClusterRoleBinding</code>。</p> <p>RBAC权限使用<code>rbac.authorization.k8s.io</code> API组来驱动授权决策，允许我们通过Kubernetes API动态配置策略。</p> <ul> <li>ServiceAccount：<code>nfs-client-provisioner</code></li> <li>命名空间：<code>dev</code></li> <li>ClusterRole：<code>nfs-client-provisioner-runner</code>。在节点、pv、pvc、sc和事件上授予授权（authorization）。</li> <li>ClusterRoleBinding：<code>run-nfs-client-provisioner</code>，将上述ClusterRole绑定到上述ServiceAccount。</li> <li>Role：<code>leader-locking-nfs-client-provisioner</code>。在endpoint上授予权限。</li> <li>RoleBinding：<code>leader-locking-nfs-client-provisioner</code>，将上述Role绑定到上述ServiceAccount。</li> </ul> <p>创建RBAC权限。</p> <div class=highlight><pre><span></span><code>cat<span class=w> </span>&gt;<span class=w> </span>nfs-provisioner-rbac.yaml<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<span class=s>apiVersion: v1</span>
<span class=s>kind: ServiceAccount</span>
<span class=s>metadata:</span>
<span class=s>  name: nfs-client-provisioner</span>
<span class=s>  # replace with namespace where provisioner is deployed</span>
<span class=s>  namespace: dev</span>
<span class=s>---</span>
<span class=s>kind: ClusterRole</span>
<span class=s>apiVersion: rbac.authorization.k8s.io/v1</span>
<span class=s>metadata:</span>
<span class=s>  name: nfs-client-provisioner-runner</span>
<span class=s>rules:</span>
<span class=s>  - apiGroups: [&quot;&quot;]</span>
<span class=s>    resources: [&quot;nodes&quot;]</span>
<span class=s>    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span>
<span class=s>  - apiGroups: [&quot;&quot;]</span>
<span class=s>    resources: [&quot;persistentvolumes&quot;]</span>
<span class=s>    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;]</span>
<span class=s>  - apiGroups: [&quot;&quot;]</span>
<span class=s>    resources: [&quot;persistentvolumeclaims&quot;]</span>
<span class=s>    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;update&quot;]</span>
<span class=s>  - apiGroups: [&quot;storage.k8s.io&quot;]</span>
<span class=s>    resources: [&quot;storageclasses&quot;]</span>
<span class=s>    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span>
<span class=s>  - apiGroups: [&quot;&quot;]</span>
<span class=s>    resources: [&quot;events&quot;]</span>
<span class=s>    verbs: [&quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]</span>
<span class=s>---</span>
<span class=s>kind: ClusterRoleBinding</span>
<span class=s>apiVersion: rbac.authorization.k8s.io/v1</span>
<span class=s>metadata:</span>
<span class=s>  name: run-nfs-client-provisioner</span>
<span class=s>subjects:</span>
<span class=s>  - kind: ServiceAccount</span>
<span class=s>    name: nfs-client-provisioner</span>
<span class=s>    # replace with namespace where provisioner is deployed</span>
<span class=s>    namespace: dev</span>
<span class=s>roleRef:</span>
<span class=s>  kind: ClusterRole</span>
<span class=s>  name: nfs-client-provisioner-runner</span>
<span class=s>  apiGroup: rbac.authorization.k8s.io</span>
<span class=s>---</span>
<span class=s>kind: Role</span>
<span class=s>apiVersion: rbac.authorization.k8s.io/v1</span>
<span class=s>metadata:</span>
<span class=s>  name: leader-locking-nfs-client-provisioner</span>
<span class=s>  # replace with namespace where provisioner is deployed</span>
<span class=s>  namespace: dev</span>
<span class=s>rules:</span>
<span class=s>  - apiGroups: [&quot;&quot;]</span>
<span class=s>    resources: [&quot;endpoints&quot;]</span>
<span class=s>    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]</span>
<span class=s>---</span>
<span class=s>kind: RoleBinding</span>
<span class=s>apiVersion: rbac.authorization.k8s.io/v1</span>
<span class=s>metadata:</span>
<span class=s>  name: leader-locking-nfs-client-provisioner</span>
<span class=s>  # replace with namespace where provisioner is deployed</span>
<span class=s>  namespace: dev</span>
<span class=s>subjects:</span>
<span class=s>  - kind: ServiceAccount</span>
<span class=s>    name: nfs-client-provisioner</span>
<span class=s>    # replace with namespace where provisioner is deployed</span>
<span class=s>    namespace: dev</span>
<span class=s>roleRef:</span>
<span class=s>  kind: Role</span>
<span class=s>  name: leader-locking-nfs-client-provisioner</span>
<span class=s>  apiGroup: rbac.authorization.k8s.io</span>
<span class=s>EOF</span>


kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>nfs-provisioner-rbac.yaml
</code></pre></div> <h3 id=provisionerdeloyment>创建Provisioner的Deloyment<a class=headerlink href=#provisionerdeloyment title="Permanent link"> ¶</a></h3> <p>"Provisioner" 可以翻译成 "提供程序"，这个词可以指为 Kubernetes 集群中提供各种资源的服务程序，如动态存储卷提供程序 (Dynamic Provisioner)、网络存储卷提供程序 (CSI Driver) 等。</p> <p>创建 <code>nfs-client-provisioner</code> 部署，使用挂载到 <code>&lt;cka002_ip&gt;</code>(<code>cka002</code>) 上的 <code>/nfsdata</code> 目录的卷 <code>nfs-client-root</code>。 把 NFS 服务器的 IP 替换为实际的 IP 地址即可（这里用 <code>&lt;cka002_ip&gt;</code> 表示）。</p> <div class=highlight><pre><span></span><code>cat<span class=w> </span>&gt;<span class=w> </span>nfs-provisioner-deployment.yaml<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<span class=s>apiVersion: apps/v1</span>
<span class=s>kind: Deployment</span>
<span class=s>metadata:</span>
<span class=s>  name: nfs-client-provisioner</span>
<span class=s>spec:</span>
<span class=s>  replicas: 1</span>
<span class=s>  selector:</span>
<span class=s>    matchLabels:</span>
<span class=s>      app: nfs-client-provisioner</span>
<span class=s>  strategy:</span>
<span class=s>    type: Recreate</span>
<span class=s>  template:</span>
<span class=s>    metadata:</span>
<span class=s>      labels:</span>
<span class=s>        app: nfs-client-provisioner</span>
<span class=s>    spec:</span>
<span class=s>      serviceAccountName: nfs-client-provisioner</span>
<span class=s>      containers:</span>
<span class=s>        - name: nfs-client-provisioner</span>
<span class=s>          image: liyinlin/nfs-subdir-external-provisioner:v4.0.2</span>
<span class=s>          volumeMounts:</span>
<span class=s>            - name: nfs-client-root</span>
<span class=s>              mountPath: /persistentvolumes</span>
<span class=s>          env:</span>
<span class=s>            - name: PROVISIONER_NAME</span>
<span class=s>              value: k8s-sigs.io/nfs-subdir-external-provisioner</span>
<span class=s>            - name: NFS_SERVER</span>
<span class=s>              value: &lt;cka002_ip&gt;</span>
<span class=s>            - name: NFS_PATH</span>
<span class=s>              value: /nfsdata</span>
<span class=s>      volumes:</span>
<span class=s>        - name: nfs-client-root</span>
<span class=s>          nfs:</span>
<span class=s>            server: &lt;cka002_ip&gt;</span>
<span class=s>            path: /nfsdata</span>
<span class=s>EOF</span>

kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>nfs-provisioner-deployment.yaml
</code></pre></div> <h3 id=nfs-storageclass>创建 NFS StorageClass<a class=headerlink href=#nfs-storageclass title="Permanent link"> ¶</a></h3> <p>创建 StorageClass <code>nfs-client</code>，定义 NFS 子目录外部 provisioner 的 Kubernetes Storage Class。</p> <p>执行下面的命令编辑<code>nfs-storageclass.yaml</code>文件。</p> <div class=highlight><pre><span></span><code>vi<span class=w> </span>nfs-storageclass.yaml
</code></pre></div> <p>添加下面的信息来配置 NFS StorageClass。</p> <div class=highlight><pre><span></span><code>apiVersion:<span class=w> </span>storage.k8s.io/v1
kind:<span class=w> </span>StorageClass
metadata:
<span class=w>  </span>name:<span class=w> </span>nfs-client
<span class=w>  </span>annotations:
<span class=w>    </span>storageclass.kubernetes.io/is-default-class:<span class=w> </span><span class=s2>&quot;true&quot;</span>
provisioner:<span class=w> </span>k8s-sigs.io/nfs-subdir-external-provisioner
parameters:
<span class=w>  </span>pathPattern:<span class=w> </span><span class=s2>&quot;</span><span class=si>${</span><span class=p>.PVC.namespace</span><span class=si>}</span><span class=s2>/</span><span class=si>${</span><span class=p>.PVC.annotations.nfs.io/storage-path</span><span class=si>}</span><span class=s2>&quot;</span>
<span class=w>  </span>onDelete:<span class=w> </span>delete
</code></pre></div> <p>应用上面的yaml文件，使之生效。</p> <div class=highlight><pre><span></span><code><span class=go>kubectl apply -f nfs-storageclass.yaml</span>
</code></pre></div> <h3 id=pvc_2>创建PVC<a class=headerlink href=#pvc_2 title="Permanent link"> ¶</a></h3> <p>创建 PVC <code>nfs-pvc-from-sc</code>。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<span class=s>kind: PersistentVolumeClaim</span>
<span class=s>apiVersion: v1</span>
<span class=s>metadata:</span>
<span class=s>  name: nfs-pvc-from-sc</span>
<span class=s>spec:</span>
<span class=s>  storageClassName: nfs-client</span>
<span class=s>  accessModes:</span>
<span class=s>    - ReadWriteMany</span>
<span class=s>  resources:</span>
<span class=s>    requests:</span>
<span class=s>      storage: 1Gi</span>
<span class=s>EOF</span>
</code></pre></div> <p>查看所创建的 PVC <code>nfs-pvc-from-sc</code> 的状态。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>pvc<span class=w> </span>nfs-pvc-from-sc
</code></pre></div> <p>PVC <code>nfs-pvc-from-sc</code> 的当前状态是 <code>Pending</code>.</p> <div class=highlight><pre><span></span><code><span class=go>NAME              STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span>
<span class=go>nfs-pvc-from-sc   Pending                                      nfs-client     112s</span>
</code></pre></div> <p>检查 <code>Pending</code> 状态的原因。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>describe<span class=w> </span>pvc<span class=w> </span>nfs-pvc-from-sc
</code></pre></div> <p>下面的信息说明 PVC <code>nfs-pvc-from-sc</code> 处于挂起状态，在等待卷（volume）创建完成。</p> <div class=highlight><pre><span></span><code><span class=go>Events:</span>
<span class=go>  Type    Reason                Age               From                         Message</span>
<span class=go>  ----    ------                ----              ----                         -------</span>
<span class=go>  Normal  ExternalProvisioning  9s (x6 over 84s)  persistentvolume-controller  waiting for a volume to be created, either by external provisioner &quot;k8s-sigs.io/nfs-subdir-external-provisioner&quot; or manually created by system administrator</span>
</code></pre></div> <h3 id=pvc_3>消费PVC<a class=headerlink href=#pvc_3 title="Permanent link"> ¶</a></h3> <p>创建 Deployment <code>mysql-with-sc-pvc</code> 以使用 PVC <code>nfs-pvc-from-sc</code>。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<span class=s>apiVersion: apps/v1</span>
<span class=s>kind: Deployment</span>
<span class=s>metadata:</span>
<span class=s>  name: mysql-with-sc-pvc</span>
<span class=s>spec:</span>
<span class=s>  selector:</span>
<span class=s>    matchLabels:</span>
<span class=s>      app: mysql</span>
<span class=s>  template:</span>
<span class=s>    metadata:</span>
<span class=s>      labels:</span>
<span class=s>        app: mysql</span>
<span class=s>    spec:</span>
<span class=s>      containers:</span>
<span class=s>      - image: mysql:8.0</span>
<span class=s>        name: mysql</span>
<span class=s>        env:</span>
<span class=s>        - name: MYSQL_ROOT_PASSWORD</span>
<span class=s>          value: password</span>
<span class=s>        ports:</span>
<span class=s>        - containerPort: 3306</span>
<span class=s>          name: mysql</span>
<span class=s>        volumeMounts:</span>
<span class=s>        - name: mysql-pv</span>
<span class=s>          mountPath: /var/lib/mysql</span>
<span class=s>      volumes:</span>
<span class=s>      - name: mysql-pv</span>
<span class=s>        persistentVolumeClaim:</span>
<span class=s>          claimName: nfs-pvc-from-sc</span>
<span class=s>EOF</span>
</code></pre></div> <p>检查 Deployment <code>mysql-with-sc-pvc</code> 的状态。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>deployment<span class=w> </span>mysql-with-sc-pvc<span class=w> </span>-o<span class=w> </span>wide
</code></pre></div> <p>运行结果：</p> <div class=highlight><pre><span></span><code><span class=go>NAME                READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES      SELECTOR</span>
<span class=go>mysql-with-sc-pvc   1/1     1            1           16s   mysql        mysql:8.0   app=mysql</span>
</code></pre></div> <p>使用 Deployment <code>mysql-with-sc-pvc</code> 消费 PVC <code>nfs-pvc-from-sc</code> 后，PVC 的状态从 <code>Pending</code> 变为了 <code>Bound</code>。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>pvc<span class=w> </span>nfs-pvc-from-sc
</code></pre></div> <p>运行结果：</p> <div class=highlight><pre><span></span><code><span class=go>NAME              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span>
<span class=go>nfs-pvc-from-sc   Bound    pvc-edf70dff-7407-4b38-aac9-9c2dd6a84316   1Gi        RWX            nfs-client     52m</span>
</code></pre></div> <p>检查相关 Pod 的状态。注意，Pod <code>mysql-with-sc-pvc-7c97d875f8-dwfkc</code> 运行在 <code>cka003</code> 上。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>pod<span class=w> </span>-o<span class=w> </span>wide<span class=w> </span>-l<span class=w> </span><span class=nv>app</span><span class=o>=</span>mysql
</code></pre></div> <p>运行结果：</p> <div class=highlight><pre><span></span><code><span class=go>NAME                                 READY   STATUS    RESTARTS   AGE     IP              NODE     NOMINATED NODE   READINESS GATES</span>
<span class=go>mysql-774db46945-h82kk               1/1     Running   0          69m     10.244.112.26   cka002   &lt;none&gt;           &lt;none&gt;</span>
<span class=go>mysql-with-sc-pvc-7c97d875f8-wkvr9   1/1     Running   0          3m37s   10.244.102.27   cka003   &lt;none&gt;           &lt;none&gt;</span>
</code></pre></div> <p>我们现在来查看 NFS 服务器 <code>cka002</code> 上的共享目录 <code>/nfsdata/</code>。</p> <div class=highlight><pre><span></span><code>ll<span class=w> </span>/nfsdata/
</code></pre></div> <p>NFS 服务器 <code>cka002</code> 上的共享目录 <code>/nfsdata/</code> 下有了2个子目录，与其他2个节点上的目录 <code>/remote-nfs-dir/</code> 下的内容是一致。</p> <div class=highlight><pre><span></span><code>drwxrwxrwx<span class=w>  </span><span class=m>6</span><span class=w> </span>systemd-coredump<span class=w> </span>root<span class=w> </span><span class=m>4096</span><span class=w> </span>Jul<span class=w> </span><span class=m>23</span><span class=w> </span><span class=m>23</span>:35<span class=w> </span>dev/
drwxr-xr-x<span class=w>  </span><span class=m>6</span><span class=w> </span>systemd-coredump<span class=w> </span>root<span class=w> </span><span class=m>4096</span><span class=w> </span>Jul<span class=w> </span><span class=m>23</span><span class=w> </span><span class=m>22</span>:29<span class=w> </span>mysqldata/
</code></pre></div> <p>命名空间Namespace的名称作为目录名在 <code>/nfsdata/</code> 目录下用于挂载到 Pod 中。 默认情况下，命名空间Namespace名称将用于挂载点。 如果我们想要使用自定义的文件夹来代替，我们需要声明一个 <code>nfs.io/storage-path</code> 注释，例如下面的例子。</p> <p>在命名空间 <code>kube-system</code> 上创建 PVC <code>test-claim</code>，并消费 <code>nfs-client</code> 卷。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<span class=s>kind: PersistentVolumeClaim</span>
<span class=s>apiVersion: v1</span>
<span class=s>metadata:</span>
<span class=s>  name: test-claim</span>
<span class=s>  namespace: kube-system</span>
<span class=s>  annotations:</span>
<span class=s>    nfs.io/storage-path: &quot;test-path&quot;</span>
<span class=s>spec:</span>
<span class=s>  storageClassName: nfs-client</span>
<span class=s>  accessModes:</span>
<span class=s>    - ReadWriteMany</span>
<span class=s>  resources:</span>
<span class=s>    requests:</span>
<span class=s>      storage: 1Gi</span>
<span class=s>EOF</span>
</code></pre></div> <p>在上述情况下， PVC 创建在 <code>kube-system</code> 命名空间中，因此我们可以在节点 <code>cka002</code> 上的 <code>kube-system</code> 目录下看到 <code>test-path</code> 目录。</p> <p>执行下面的命令，来查看目录 <code>/nfsdata/</code> 的整体目录结构。</p> <div class=highlight><pre><span></span><code>tree<span class=w> </span>-L<span class=w> </span><span class=m>1</span><span class=w> </span>/nfsdata/<span class=w> </span>
</code></pre></div> <p>运行结果：</p> <div class=highlight><pre><span></span><code><span class=go>/nfsdata/</span>
<span class=go>├── dev</span>
<span class=go>├── kube-system</span>
<span class=go>└── mysqldata</span>
</code></pre></div> <p>注意：</p> <p>上述规则遵循了 <code>nfs-subdir-external-provisioner</code> 实现，可能与其他<code>provisioner</code>不同。</p> <p>参考：</p> <p><code>nfs-subdir-external-provisioner</code> <a href=https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner>项目</a>的详细信息。</p> <h2 id=configuration>配置Configuration<a class=headerlink href=#configuration title="Permanent link"> ¶</a></h2> <h3 id=configmap>ConfigMap<a class=headerlink href=#configmap title="Permanent link"> ¶</a></h3> <p>创建 ConfigMap <code>cm-nginx</code> 来配置文件 <code>nginx.conf</code>。</p> <div class=highlight><pre><span></span><code>vi<span class=w> </span>configmap.yaml
</code></pre></div> <p>把下面的内容粘贴到文件<code>nginx.conf</code>中。</p> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>labels</span><span class=p>:</span>
<span class=w>    </span><span class=nt>cattle.io/creator</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">norman</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">cm-nginx</span>
<span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dev</span>
<span class=nt>data</span><span class=p>:</span>
<span class=w>  </span><span class=nt>nginx.conf</span><span class=p>:</span><span class=w> </span><span class="p p-Indicator">|-</span>
<span class=w>    </span><span class=no>user  nginx;</span>
<span class=w>    </span><span class=no>worker_processes  2;</span>

<span class=w>    </span><span class=no>error_log  /var/log/nginx/error.log warn;</span>
<span class=w>    </span><span class=no>pid        /var/run/nginx.pid;</span>


<span class=w>    </span><span class=no>events {</span>
<span class=w>        </span><span class=no>worker_connections  1024;</span>
<span class=w>    </span><span class=no>}</span>


<span class=w>    </span><span class=no>http {</span>
<span class=w>        </span><span class=no>include       /etc/nginx/mime.types;</span>
<span class=w>        </span><span class=no>default_type  application/octet-stream;</span>

<span class=w>        </span><span class=no>log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span>
<span class=w>                          </span><span class=no>&#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span>
<span class=w>                          </span><span class=no>&#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span>

<span class=w>        </span><span class=no>access_log  /var/log/nginx/access.log  main;</span>

<span class=w>        </span><span class=no>sendfile        on;</span>
<span class=w>        </span><span class=no>#tcp_nopush     on;</span>

<span class=w>        </span><span class=no>keepalive_timeout  65;</span>

<span class=w>        </span><span class=no>#gzip  on;</span>

<span class=w>        </span><span class=no>include /etc/nginx/conf.d/*.conf;</span>
<span class=w>    </span><span class=no>}</span>
</code></pre></div> <p>应用文件<code>configmap.yaml</code>，创建ConfigMap。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>configmap.yaml
</code></pre></div> <p>创建Pod <code>nginx-with-cm</code>。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<span class=s>apiVersion: v1</span>
<span class=s>kind: Pod</span>
<span class=s>metadata:</span>
<span class=s>  name: nginx-with-cm</span>
<span class=s>spec:</span>
<span class=s> containers:</span>
<span class=s> - name: nginx</span>
<span class=s>   image: nginx</span>
<span class=s>   volumeMounts:</span>
<span class=s>   - name: foo</span>
<span class=s>     mountPath: &quot;/etc/nginx/nginx.conf&quot;</span>
<span class=s>     subPath:  nginx.conf</span>
<span class=s> volumes:</span>
<span class=s> - name: foo</span>
<span class=s>   configMap:</span>
<span class=s>     name: cm-nginx</span>
<span class=s>EOF</span>
</code></pre></div> <p>提示：</p> <ul> <li>默认情况下，要挂载 ConfigMap，Kubernetes 会覆盖挂载点的所有内容。我们可以使用 <code>volumeMounts.subPath</code> 来指定只覆盖在 <code>mountPath</code> 中定义的 <code>nginx.conf</code> 文件。</li> <li>如果我们使用 <code>volumeMounts.subPath</code> 来挂载一个容器卷，Kubernetes 将不会进行热更新以反映实时更新。</li> </ul> <p>把从外部挂载的 <code>nginx.conf</code> 文件和上面的文件进行比较，以验证它是否已经被加载到容器中。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span>nginx-with-cm<span class=w> </span>--<span class=w> </span>sh<span class=w> </span>
cat<span class=w> </span>/etc/nginx/nginx.conf
</code></pre></div> <h3 id=secret>Secret<a class=headerlink href=#secret title="Permanent link"> ¶</a></h3> <p>用base64方式编码密码。</p> <div class=highlight><pre><span></span><code><span class=nb>echo</span><span class=w> </span>-n<span class=w> </span>admin<span class=w> </span><span class=p>|</span><span class=w> </span>base64<span class=w>  </span>
<span class=nv>YWRtaW4</span><span class=o>=</span>

<span class=nb>echo</span><span class=w> </span>-n<span class=w> </span><span class=m>123456</span><span class=w> </span><span class=p>|</span><span class=w> </span>base64
MTIzNDU2
</code></pre></div> <p>创建Secret <code>mysecret</code>。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<span class=s>apiVersion: v1</span>
<span class=s>kind: Secret</span>
<span class=s>metadata:</span>
<span class=s>  name: mysecret</span>
<span class=s>data:</span>
<span class=s>  username: YWRtaW4=</span>
<span class=s>  password: MTIzNDU2</span>
<span class=s>EOF</span>
</code></pre></div> <p>使用卷将 Secret 挂载（注入，injection）到 Pod 中。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt;EOF</span>
<span class=s>apiVersion: v1</span>
<span class=s>kind: Pod</span>
<span class=s>metadata:</span>
<span class=s>  name: busybox-with-secret</span>
<span class=s>spec:</span>
<span class=s> containers:</span>
<span class=s> - name: mypod</span>
<span class=s>   image: busybox</span>
<span class=s>   args:</span>
<span class=s>    - /bin/sh</span>
<span class=s>    - -c</span>
<span class=s>    - sleep 1000000;</span>
<span class=s>   volumeMounts:</span>
<span class=s>   - name: foo</span>
<span class=s>     mountPath: &quot;/tmp/secret&quot;</span>
<span class=s> volumes:</span>
<span class=s> - name: foo</span>
<span class=s>   secret:</span>
<span class=s>    secretName: mysecret</span>
<span class=s>EOF</span>
</code></pre></div> <p>让我们登录进入到Pod <code>busybox-with-secret</code>内部，以验证 <code>mysecret</code> 的两个数据元素（<code>username</code>和<code>password</code>）是否已成功挂载到Pod中的路径 <code>/tmp/secret</code>。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span>busybox-with-secret<span class=w> </span>--<span class=w> </span>sh
</code></pre></div> <p>执行下面的命令，我们可以看到<code>mysecret</code> 的两个数据元素（<code>username</code>和<code>password</code>）已经以文件形式存在于目录<code>/tmp/secret</code>下。</p> <div class=highlight><pre><span></span><code>/<span class=w> </span><span class=c1># ls -l /tmp/secret/</span>
lrwxrwxrwx<span class=w>    </span><span class=m>1</span><span class=w> </span>root<span class=w>     </span>root<span class=w>            </span><span class=m>15</span><span class=w> </span>Jul<span class=w> </span><span class=m>23</span><span class=w> </span><span class=m>16</span>:30<span class=w> </span>password<span class=w> </span>-&gt;<span class=w> </span>..data/password
lrwxrwxrwx<span class=w>    </span><span class=m>1</span><span class=w> </span>root<span class=w>     </span>root<span class=w>            </span><span class=m>15</span><span class=w> </span>Jul<span class=w> </span><span class=m>23</span><span class=w> </span><span class=m>16</span>:30<span class=w> </span>username<span class=w> </span>-&gt;<span class=w> </span>..data/username
</code></pre></div> <p>而且我们可以看到这2个数据元素（<code>username</code>和<code>password</code>）的内容就是我们预先定义的。</p> <div class=highlight><pre><span></span><code>/<span class=w> </span><span class=c1># cat /tmp/secret/username</span>
admin

/<span class=w> </span><span class=c1># cat /tmp/secret/password</span>
<span class=m>123456</span>
</code></pre></div> <h3 id=_2>拓展案例<a class=headerlink href=#_2 title="Permanent link"> ¶</a></h3> <h4 id=configmap_1>多种方法创建ConfigMap<a class=headerlink href=#configmap_1 title="Permanent link"> ¶</a></h4> <p>我们可以通过文件、目录、或者值来创建ConfigMap。</p> <p>下面我们创建ConfigMap <code>colors</code>，包含：</p> <ul> <li>四个文件，文件名是四个颜色。</li> <li>一个文件，文件名是最喜欢的颜色。</li> </ul> <div class=highlight><pre><span></span><code>mkdir<span class=w> </span>configmap
<span class=nb>cd</span><span class=w> </span>configmap
mkdir<span class=w> </span>primary

<span class=nb>echo</span><span class=w> </span>c<span class=w> </span>&gt;<span class=w> </span>primary/cyan
<span class=nb>echo</span><span class=w> </span>m<span class=w> </span>&gt;<span class=w> </span>primary/magenta
<span class=nb>echo</span><span class=w> </span>y<span class=w> </span>&gt;<span class=w> </span>primary/yellow
<span class=nb>echo</span><span class=w> </span>k<span class=w> </span>&gt;<span class=w> </span>primary/black
<span class=nb>echo</span><span class=w> </span><span class=s2>&quot;known as key&quot;</span><span class=w> </span>&gt;&gt;<span class=w> </span>primary/black
<span class=nb>echo</span><span class=w> </span>blue<span class=w> </span>&gt;<span class=w> </span>favorite
</code></pre></div> <p>执行命令<code>tree configmap</code>，可以看到类似下面的文件目录结构。</p> <div class=highlight><pre><span></span><code><span class=go>configmap</span>
<span class=go>├── favorite</span>
<span class=go>└── primary</span>
<span class=go>    ├── black</span>
<span class=go>    ├── cyan</span>
<span class=go>    ├── magenta</span>
<span class=go>    └── yellow</span>
</code></pre></div> <p>创建一个 ConfigMap，引用上面我们创建的文件。确保我们现在在路径 <code>~/configmap</code> 下。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>create<span class=w> </span>configmap<span class=w> </span>colors<span class=w> </span><span class=se>\</span>
--from-literal<span class=o>=</span><span class=nv>text</span><span class=o>=</span>black<span class=w>  </span><span class=se>\</span>
--from-file<span class=o>=</span>./favorite<span class=w>  </span><span class=se>\</span>
--from-file<span class=o>=</span>./primary/
</code></pre></div> <p>查看ConfigMap <code>colors</code>的内容。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>configmap<span class=w> </span>colors<span class=w> </span>-o<span class=w> </span>yaml
</code></pre></div> <p>运行结果：</p> <div class=highlight><pre><span></span><code>apiVersion:<span class=w> </span>v1
data:
<span class=w>  </span>black:<span class=w> </span><span class=p>|</span>
<span class=w>    </span>k
<span class=w>    </span>known<span class=w> </span>as<span class=w> </span>key
<span class=w>  </span>cyan:<span class=w> </span><span class=p>|</span>
<span class=w>    </span>c
<span class=w>  </span>favorite:<span class=w> </span><span class=p>|</span>
<span class=w>    </span>blue
<span class=w>  </span>magenta:<span class=w> </span><span class=p>|</span>
<span class=w>    </span>m
<span class=w>  </span>text:<span class=w> </span>black
<span class=w>  </span>yellow:<span class=w> </span><span class=p>|</span>
<span class=w>    </span>y
kind:<span class=w> </span>ConfigMap
metadata:
<span class=w>  </span>creationTimestamp:<span class=w> </span><span class=s2>&quot;2022-07-12T16:38:27Z&quot;</span>
<span class=w>  </span>name:<span class=w> </span>colors
<span class=w>  </span>namespace:<span class=w> </span>dev
<span class=w>  </span>resourceVersion:<span class=w> </span><span class=s2>&quot;2377258&quot;</span>
<span class=w>  </span>uid:<span class=w> </span>d5ab133f-5e4d-41d4-bc9e-2bbb22a872a1
</code></pre></div> <h4 id=configmap_2>通过ConfigMap设定环境变量<a class=headerlink href=#configmap_2 title="Permanent link"> ¶</a></h4> <p>继续上面的例子，现在我们准备创建一个名为<code>pod-configmap-env</code>的Pod，设置环境变量<code>ilike</code>并从ConfigMap <code>colors</code>中分配值<code>favorite</code>。</p> <div class=highlight><pre><span></span><code><span class=go>kubectl apply -f - &lt;&lt; EOF</span>
<span class=go>apiVersion: v1</span>
<span class=go>kind: Pod</span>
<span class=go>metadata:</span>
<span class=go>  name: pod-configmap-env</span>
<span class=go>spec:</span>
<span class=go>  containers:</span>
<span class=go>  - name: nginx</span>
<span class=go>    image: nginx</span>
<span class=go>    env:</span>
<span class=go>    - name: ilike</span>
<span class=go>      valueFrom:</span>
<span class=go>        configMapKeyRef:</span>
<span class=go>          name: colors</span>
<span class=go>          key: favorite</span>
<span class=go>EOF</span>
</code></pre></div> <p>连接并进入Pod <code>pod-configmap-env</code>内部。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span>pod-configmap-env<span class=w> </span>--<span class=w> </span>bash
</code></pre></div> <p>验证环境变量 <code>ilike</code> 的值是 <code>blue</code>，这是 ConfigMap <code>colors</code> 的 <code>favorite</code> 值。</p> <div class=highlight><pre><span></span><code>root@pod-configmap-env:/#<span class=w> </span><span class=nb>echo</span><span class=w> </span><span class=nv>$ilike</span>
blue
</code></pre></div> <p>我们还可以使用 ConfigMap 的所有键值对来设置 Pod 的环境变量。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>-<span class=w> </span><span class=s>&lt;&lt; EOF</span>
<span class=s>apiVersion: v1</span>
<span class=s>kind: Pod</span>
<span class=s>metadata:</span>
<span class=s> name: pod-configmap-env-2</span>
<span class=s>spec:</span>
<span class=s> containers:</span>
<span class=s> - name: nginx</span>
<span class=s>   image: nginx</span>
<span class=s>   envFrom:</span>
<span class=s>    - configMapRef:</span>
<span class=s>        name: colors</span>
<span class=s>EOF</span>
</code></pre></div> <p>连接并进入Pod <code>pod-configmap-env-2</code>内部。</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span><span class=nb>exec</span><span class=w> </span>-it<span class=w> </span>pod-configmap-env-2<span class=w> </span>--<span class=w> </span>bash
</code></pre></div> <p>验证环境变量的值是我们在ConfigMap <code>colors</code>所定义的键值对。</p> <div class=highlight><pre><span></span><code>root@pod-configmap-env-2:/#<span class=w> </span><span class=nb>echo</span><span class=w> </span><span class=nv>$black</span>
k<span class=w> </span>known<span class=w> </span>as<span class=w> </span>key
root@pod-configmap-env-2:/#<span class=w> </span><span class=nb>echo</span><span class=w> </span><span class=nv>$cyan</span>
c
root@pod-configmap-env-2:/#<span class=w> </span><span class=nb>echo</span><span class=w> </span><span class=nv>$favorite</span>
blue
</code></pre></div> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top data-md-state=hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../secrets/ class="md-footer__link md-footer__link--prev" aria-label="Previous: secrets" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> secrets </div> </div> </a> <a href=../rbac/ class="md-footer__link md-footer__link--next" aria-label="Next: RBAC鉴权" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> RBAC鉴权 </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.instant", "navigation.top"], "search": "../../../../assets/javascripts/workers/search.fcfe8b6d.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": null}</script> <script src=../../../../assets/javascripts/bundle.b1047164.min.js></script> </body> </html>